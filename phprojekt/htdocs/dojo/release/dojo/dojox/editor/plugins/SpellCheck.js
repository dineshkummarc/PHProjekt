/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.editor.plugins.SpellCheck"]||(dojo._hasResource["dojox.editor.plugins.SpellCheck"]=!0,dojo.provide("dojox.editor.plugins.SpellCheck"),dojo.require("dijit.form.TextBox"),dojo.require("dijit.form.DropDownButton"),dojo.require("dijit.TooltipDialog"),dojo.require("dijit.form.MultiSelect"),dojo.require("dojo.io.script"),dojo.require("dijit.Menu"),dojo.requireLocalization("dojox.editor.plugins","SpellCheck",null,"ROOT,ar,ca,cs,da,de,el,es,fi,fr,he,hu,it,ja,kk,ko,nb,nl,pl,pt,pt-pt,ro,ru,sk,sl,sv,th,tr,zh,zh-tw"),
dojo.experimental("dojox.editor.plugins.SpellCheck"),dojo.declare("dojox.editor.plugins._spellCheckControl",[dijit._Widget,dijit._Templated],{widgetsInTemplate:!0,templateString:"<table class='dijitEditorSpellCheckTable'><tr><td colspan='3' class='alignBottom'><label for='${textId}' id='${textId}_label'>${unfound}</label><div class='dijitEditorSpellCheckBusyIcon' id='${id}_progressIcon'></div></td></tr><tr><td class='dijitEditorSpellCheckBox'><input dojoType='dijit.form.TextBox' required='false' intermediateChanges='true' class='dijitEditorSpellCheckBox' dojoAttachPoint='unfoundTextBox' id='${textId}'/></td><td><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='skipButton'>${skip}</button></td><td><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='skipAllButton'>${skipAll}</button></td></tr><tr><td class='alignBottom'><label for='${selectId}'>${suggestions}</td></label><td colspan='2'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='toDicButton'>${toDic}</button></td></tr><tr><td><select dojoType='dijit.form.MultiSelect' id='${selectId}' class='dijitEditorSpellCheckBox listHeight' dojoAttachPoint='suggestionSelect'></select></td><td colspan='2'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='replaceButton'>${replace}</button><div class='topMargin'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='replaceAllButton'>${replaceAll}</button><div></td></tr><tr><td><div class='topMargin'><button dojoType='dijit.form.Button' dojoAttachPoint='cancelButton'>${cancel}</button></div></td><td></td><td></td></tr></table>",
constructor:function(){this.isOpen=this.isChanged=this.ignoreChange=!1;this.closable=!0},postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.textId=this.id+"_textBox";this.selectId=this.id+"_select"},postCreate:function(){var a=this.suggestionSelect;dojo.removeAttr(a.domNode,"multiple");a.addItems=function(a){var c=this,d=null;a&&a.length>0&&dojo.forEach(a,function(a,b){d=dojo.create("option",{innerHTML:a,value:a},c.domNode);if(b==0)d.selected=!0})};
a.removeItems=function(){dojo.empty(this.domNode)};a.deselectAll=function(){this.containerNode.selectedIndex=-1};this.connect(this,"onKeyPress","_cancel");this.connect(this.unfoundTextBox,"onKeyPress","_enter");this.connect(this.unfoundTextBox,"onChange","_unfoundTextBoxChange");this.connect(this.suggestionSelect,"onKeyPress","_enter");this.connect(this.skipButton,"onClick","onSkip");this.connect(this.skipAllButton,"onClick","onSkipAll");this.connect(this.toDicButton,"onClick","onAddToDic");this.connect(this.replaceButton,
"onClick","onReplace");this.connect(this.replaceAllButton,"onClick","onReplaceAll");this.connect(this.cancelButton,"onClick","onCancel")},onSkip:function(){},onSkipAll:function(){},onAddToDic:function(){},onReplace:function(){},onReplaceAll:function(){},onCancel:function(){},onEnter:function(){},focus:function(){this.unfoundTextBox.focus()},_cancel:function(a){a.keyCode==dojo.keys.ESCAPE&&(this.onCancel(),dojo.stopEvent(a))},_enter:function(a){a.keyCode==dojo.keys.ENTER&&(this.onEnter(),dojo.stopEvent(a))},
_unfoundTextBoxChange:function(){var a=this.textId+"_label";this.ignoreChange?dojo.byId(a).innerHTML=this.unfound:(dojo.byId(a).innerHTML=this.replaceWith,this.isChanged=!0,this.suggestionSelect.deselectAll())},_setUnfoundWordAttr:function(a){this.unfoundTextBox.set("value",a||"")},_getUnfoundWordAttr:function(){return this.unfoundTextBox.get("value")},_setSuggestionListAttr:function(a){var b=this.suggestionSelect,a=a||[];b.removeItems();b.addItems(a)},_getSelectedWordAttr:function(){var a=this.suggestionSelect.getSelected();
return a&&a.length>0?a[0].value:this.unfoundTextBox.get("value")},_setDisabledAttr:function(a){this.skipButton.set("disabled",a);this.skipAllButton.set("disabled",a);this.toDicButton.set("disabled",a);this.replaceButton.set("disabled",a);this.replaceAllButton.set("disabled",a)},_setInProgressAttr:function(a){dojo[a?"removeClass":"addClass"](this.id+"_progressIcon","hidden")}}),dojo.declare("dojox.editor.plugins._SpellCheckScriptMultiPart",null,{ACTION_QUERY:"query",ACTION_UPDATE:"update",callbackHandle:"callback",
maxBufferLength:100,delimiter:" ",label:"response",_timeout:3E4,SEC:1E3,constructor:function(){this.serviceEndPoint="";this._queue=[];this.isWorking=!1;this.exArgs=null;this._counter=0},send:function(a,b){var c=this,d=this.delimiter,e=this.maxBufferLength,f=this.label,o=this.serviceEndPoint,m=this.callbackHandle,k=this.exArgs,n=this._timeout,l=0,g=0;if(!this._result)this._result=[];var b=b||this.ACTION_QUERY,h=function(){var j=[],i=0;if(a&&a.length>0){c.isWorking=!0;var h=a.length;do{l=g+1;if((g+=
e)>h)g=h;else for(;d&&a.charAt(g)!=d&&g<=h;)g++;j.push({l:l,r:g});i++}while(g<h);dojo.forEach(j,function(e,d){var g={url:o,action:b,timeout:n,callbackParamName:m,handle:function(a){if(++c._counter<=this.size&&!(a instanceof Error)&&a[f]&&dojo.isArray(a[f])){var b=this.offset;dojo.forEach(a[f],function(a){a.offset+=b});c._result[this.number]=a[f]}if(c._counter==this.size)c._finalizeCollection(this.action),c.isWorking=!1,c._queue.length>0&&c._queue.shift()()}};g.content=k?dojo.mixin(k,{action:b,content:a.substring(e.l-
1,e.r)}):{action:b,content:a.substring(e.l-1,e.r)};g.size=i;g.number=d;g.offset=e.l-1;dojo.io.script.get(g)})}};c.isWorking?c._queue.push(h):h()},_finalizeCollection:function(a){for(var b=this._result,c=b.length,d=0;d<c;d++)var e=b.shift(),b=b.concat(e);if(a==this.ACTION_QUERY)this.onLoad(b);this._counter=0;this._result=[]},onLoad:function(){},setWaitingTime:function(a){this._timeout=a*this.SEC}}),dojo.declare("dojox.editor.plugins.SpellCheck",[dijit._editor._Plugin],{url:"",bufferLength:100,interactive:!1,
timeout:30,button:null,_editor:null,exArgs:null,_cursorSpan:'<span class="cursorPlaceHolder"></span>',_cursorSelector:"cursorPlaceHolder",_incorrectWordsSpan:"<span class='incorrectWordPlaceHolder'>${text}</span>",_ignoredIncorrectStyle:{cursor:"inherit",borderBottom:"none",backgroundColor:"transparent"},_normalIncorrectStyle:{cursor:"pointer",borderBottom:"1px dotted red",backgroundColor:"yellow"},_highlightedIncorrectStyle:{borderBottom:"1px dotted red",backgroundColor:"#b3b3ff"},_selector:"incorrectWordPlaceHolder",
_maxItemNumber:3,constructor:function(){this._spanList=[];this._cache={};this._enabled=!0;this._iterator=0},setEditor:function(a){this._editor=a;this._initButton();this._setNetwork();this._connectUp()},_initButton:function(){var a=this,b=this._strings=dojo.i18n.getLocalization("dojox.editor.plugins","SpellCheck"),c=this._dialog=new dijit.TooltipDialog;c.set("content",this._dialogContent=new dojox.editor.plugins._spellCheckControl({unfound:b.unfound,skip:b.skip,skipAll:b.skipAll,toDic:b.toDic,suggestions:b.suggestions,
replaceWith:b.replaceWith,replace:b.replace,replaceAll:b.replaceAll,cancel:b.cancel}));this.button=new dijit.form.DropDownButton({label:b.widgetLabel,showLabel:!1,iconClass:"dijitEditorSpellCheckIcon",dropDown:c,id:dijit.getUniqueId(this.declaredClass.replace(/\./g,"_"))+"_dialogPane",closeDropDown:function(b){if(a._dialogContent.closable){a._dialogContent.isOpen=!1;if(dojo.isIE){var c=a._iterator,f=a._spanList;c<f.length&&c>=0&&dojo.style(f[c],a._normalIncorrectStyle)}if(this._opened)dijit.popup.close(this.dropDown),
b&&this.focus(),this._opened=!1,this.state=""}}});a._dialogContent.isOpen=!1;dijit.setWaiState(c.domNode,"label",this._strings.widgetLabel)},_setNetwork:function(){var a=this.exArgs;if(!this._service){var b=this._service=new dojox.editor.plugins._SpellCheckScriptMultiPart;b.serviceEndPoint=this.url;b.maxBufferLength=this.bufferLength;b.setWaitingTime(this.timeout);if(a)delete a.name,delete a.url,delete a.interactive,delete a.timeout,b.exArgs=a}},_connectUp:function(){var a=this._editor,b=this._dialogContent;
this.connect(this.button,"set","_disabled");this.connect(this._service,"onLoad","_loadData");this.connect(this._dialog,"onOpen","_openDialog");this.connect(a,"onKeyPress","_keyPress");this.connect(a,"onLoad","_submitContent");this.connect(b,"onSkip","_skip");this.connect(b,"onSkipAll","_skipAll");this.connect(b,"onAddToDic","_add");this.connect(b,"onReplace","_replace");this.connect(b,"onReplaceAll","_replaceAll");this.connect(b,"onCancel","_cancel");this.connect(b,"onEnter","_enter");a.contentPostFilters.push(this._spellCheckFilter);
dojo.publish(dijit._scopeName+".Editor.plugin.SpellCheck.getParser",[this]);this.parser||console.error("Can not get the word parser!")},_disabled:function(a,b){if(a=="disabled")b?(this._iterator=0,this._spanList=[]):this.interactive&&!b&&this._service&&this._submitContent(!0),this._enabled=!b},_keyPress:function(a){if(this.interactive){var b=a.charCode;!a.altKey&&b==dojo.keys.SPACE?this._submitContent():(a.ctrlKey&&(b==118||b==86)||!a.ctrlKey&&a.charCode)&&this._submitContent(!0)}},_loadData:function(a){var b=
this._cache,c=this._editor.get("value"),d=this._dialogContent;this._iterator=0;dojo.forEach(a,function(a){b[a.text]=a.suggestion;b[a.text].correct=!1});if(this._enabled&&(d.closable=!1,this._markIncorrectWords(c,b),d.closable=!0,this._dialogContent.isOpen))this._iterator=-1,this._skip()},_openDialog:function(){var a=this._dialogContent;a.ignoreChange=!0;a.set("unfoundWord","");a.set("suggestionList",null);a.set("disabled",!0);a.set("inProgress",!0);a.isOpen=!0;a.closable=!1;this._submitContent();
a.closable=!0},_skip:function(a,b){var c=this._dialogContent,d=this._spanList||[],e=d.length,f=this._iterator;c.closable=!1;c.isChanged=!1;c.ignoreChange=!0;for(!b&&f>=0&&f<e&&this._skipWord(f);++f<e&&d[f].edited==!0;);f<e?(this._iterator=f,this._populateDialog(f),this._selectWord(f)):(this._iterator=-1,c.set("unfoundWord",this._strings.msg),c.set("suggestionList",null),c.set("disabled",!0),c.set("inProgress",!1));setTimeout(function(){dojo.isWebKit&&c.skipButton.focus();c.focus();c.ignoreChange=
!1;c.closable=!0},0)},_skipAll:function(){this._dialogContent.closable=!1;this._skipWordAll(this._iterator);this._skip()},_add:function(){var a=this._dialogContent;a.closable=!1;a.isOpen=!0;this._addWord(this._iterator,a.get("unfoundWord"));this._skip()},_replace:function(){var a=this._dialogContent,b=this._iterator,c=a.get("selectedWord");a.closable=!1;this._replaceWord(b,c);this._skip(null,!0)},_replaceAll:function(){var a=this._dialogContent,b=this._spanList,c=b.length,d=b[this._iterator].innerHTML.toLowerCase(),
e=a.get("selectedWord");a.closable=!1;for(a=0;a<c;a++)b[a].innerHTML.toLowerCase()==d&&this._replaceWord(a,e);this._skip(null,!0)},_cancel:function(){this._dialogContent.closable=!0;this._editor.focus()},_enter:function(){this._dialogContent.isChanged?this._replace():this._skip()},_query:function(a){var b=this._service,c=this._cache,a=this.parser.parseIntoWords(this._html2Text(a))||[],d=[];dojo.forEach(a,function(a){a=a.toLowerCase();if(!c[a])c[a]=[],c[a].correct=!0,d.push(a)});d.length>0?b.send(d.join(" ")):
b.isWorking||this._loadData([])},_html2Text:function(a){for(var b=[],c=!1,d=a?a.length:0,e=0;e<d;e++)a.charAt(e)=="<"&&(c=!0),c==!0?b.push(" "):b.push(a.charAt(e)),a.charAt(e)==">"&&(c=!1);return b.join("")},_getBookmark:function(a){var b=this._editor,c=this._cursorSpan;b.execCommand("inserthtml",c);for(var b=b.get("value"),c=b.indexOf(c),d=-1;++d<c&&a.charAt(d)==b.charAt(d););return d},_moveToBookmark:function(){var a=this._editor,b=dojo.withGlobal(a.window,"query",dojo,["."+this._cursorSelector]);
if(b=b&&b[0])a._sCall("selectElement",[b]),a._sCall("collapse",[!0]),(a=b.parentNode)&&a.removeChild(b)},_submitContent:function(a){if(a){var b=this;if(this._delayHandler)clearTimeout(this._delayHandler),this._delayHandler=null;setTimeout(function(){b._query(b._editor.get("value"))},3E3)}else this._query(this._editor.get("value"))},_populateDialog:function(a){var b=this._spanList,c=this._cache,d=this._dialogContent;d.set("disabled",!1);if(a<b.length&&b.length>0)a=b[a].innerHTML,d.set("unfoundWord",
a),d.set("suggestionList",c[a.toLowerCase()]),d.set("inProgress",!1)},_markIncorrectWords:function(a,b){for(var c=this,d=this.parser,e=this._editor,f=this._incorrectWordsSpan,o=this._normalIncorrectStyle,m=this._selector,k=d.parseIntoWords(this._html2Text(a).toLowerCase()),d=d.getIndices(),n=this._cursorSpan,l=this._getBookmark(a),g=!1,h=a.split(""),j=null,j=k.length-1;j>=0;j--){var i=k[j];if(b[i]&&!b[i].correct){var i=d[j],q=k[j].length,p=i+q;p<=l&&!g&&(h.splice(l,0,n),g=!0);h.splice(i,q,dojo.string.substitute(f,
{text:a.substring(i,p)}));i<l&&l<p&&!g&&(g=h[i].split(""),g.splice(39+l-i,0,n),h[i]=g.join(""),g=!0)}}g||(h.splice(l,0,n),g=!0);e.set("value",h.join(""));e._cursorToStart=!1;this._moveToBookmark();j=this._spanList=dojo.withGlobal(e.window,"query",dojo,["."+this._selector]);dojo.forEach(j,function(a,b){a.id=m+b});this.interactive||delete o.cursor;j.style(o);if(this.interactive){if(c._contextMenu)c._contextMenu.uninitialize(),c._contextMenu=null;c._contextMenu=new dijit.Menu({targetNodeIds:[e.iframe],
bindDomNode:function(a){var a=dojo.byId(a),d,f,g;a.tagName.toLowerCase()=="iframe"?(f=a,g=this._iframeContentWindow(f),d=dojo.withGlobal(g,dojo.body)):d=a==dojo.body()?dojo.doc.documentElement:a;var h={node:a,iframe:f};dojo.attr(a,"_dijitMenu"+this.id,this._bindings.push(h));var i=dojo.hitch(this,function(a){return[dojo.connect(a,this.leftClickToOpen?"onclick":"oncontextmenu",this,function(a){var d=a.target,g=c._strings;if(dojo.hasClass(d,m)&&!d.edited){dojo.stopEvent(a);var h=c._maxItemNumber,i=
d.id.substring(m.length),j=b[d.innerHTML.toLowerCase()],l=j.length;this.destroyDescendants();if(l==0)this.addChild(new dijit.MenuItem({label:g.iMsg,disabled:!0}));else for(var k=0;k<h&&k<l;k++)this.addChild(new dijit.MenuItem({label:j[k],onClick:function(){var a=j[k];return function(){c._replaceWord(i,a);e.focus()}}()}));this.addChild(new dijit.MenuSeparator);this.addChild(new dijit.MenuItem({label:g.iSkip,onClick:function(){c._skipWord(i);e.focus()}}));this.addChild(new dijit.MenuItem({label:g.iSkipAll,
onClick:function(){c._skipWordAll(i);e.focus()}}));this.addChild(new dijit.MenuSeparator);this.addChild(new dijit.MenuItem({label:g.toDic,onClick:function(){c._addWord(i);e.focus()}}));this._scheduleOpen(d,f,{x:a.pageX,y:a.pageY})}}),dojo.connect(a,"onkeydown",this,function(a){a.shiftKey&&a.keyCode==dojo.keys.F10&&(dojo.stopEvent(a),this._scheduleOpen(a.target,f))})]});h.connects=d?i(d):[];if(f)h.onloadHandler=dojo.hitch(this,function(){var a=this._iframeContentWindow(f);d=dojo.withGlobal(a,dojo.body);
h.connects=i(d)}),f.addEventListener?f.addEventListener("load",h.onloadHandler,!1):f.attachEvent("onload",h.onloadHandler)}})}},_selectWord:function(a){var b=this._spanList,c=this._editor.window;a<b.length&&b.length>0&&(dojo.withGlobal(c,"selectElement",dijit._editor.selection,[b[a]]),dojo.withGlobal(c,"collapse",dijit._editor.selection,[!0]),this._findText(b[a].innerHTML,!1,!1),dojo.isIE&&dojo.style(b[a],this._highlightedIncorrectStyle))},_replaceWord:function(a,b){var c=this._spanList;c[a].innerHTML=
b;dojo.style(c[a],this._ignoredIncorrectStyle);c[a].edited=!0},_skipWord:function(a){var b=this._spanList;dojo.style(b[a],this._ignoredIncorrectStyle);this._cache[b[a].innerHTML.toLowerCase()].correct=!0;b[a].edited=!0},_skipWordAll:function(a,b){for(var c=this._spanList,d=c.length,b=b||c[a].innerHTML.toLowerCase(),e=0;e<d;e++)!c[e].edited&&c[e].innerHTML.toLowerCase()==b&&this._skipWord(e)},_addWord:function(a,b){var c=this._service;c.send(b||this._spanList[a].innerHTML.toLowerCase(),c.ACTION_UPDATE);
this._skipWordAll(a,b)},_findText:function(a,b,c){var d=this._editor,e=d.window,f=!1;if(a)e.find?f=e.find(a,b,c,!1,!1,!1,!1):(e=d.document,e.selection&&(this._editor.focus(),d=e.body.createTextRange(),(f=e.selection?e.selection.createRange():null)&&(c?d.setEndPoint("EndToStart",f):d.setEndPoint("StartToEnd",f)),b=b?4:0,c&&(b|=1),(f=d.findText(a,d.text.length,b))&&d.select()));return f},_spellCheckFilter:function(a){return a.replace(/<span class=["']incorrectWordPlaceHolder["'].*?>(.*?)<\/span>/g,
"$1")}}),dojo.subscribe(dijit._scopeName+".Editor.getPlugin",null,function(a){if(!a.plugin&&a.args.name.toLowerCase()==="spellcheck")a.plugin=new dojox.editor.plugins.SpellCheck({url:"url"in a.args?a.args.url:"",interactive:"interactive"in a.args?a.args.interactive:!1,bufferLength:"bufferLength"in a.args?a.args.bufferLength:100,timeout:"timeout"in a.args?a.args.timeout:30,exArgs:a.args})}));