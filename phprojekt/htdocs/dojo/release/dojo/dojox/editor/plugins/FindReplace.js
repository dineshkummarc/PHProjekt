/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.editor.plugins.FindReplace"]||(dojo._hasResource["dojox.editor.plugins.FindReplace"]=!0,dojo.provide("dojox.editor.plugins.FindReplace"),dojo.require("dojo.string"),dojo.require("dijit.TooltipDialog"),dojo.require("dijit.Toolbar"),dojo.require("dijit.form.CheckBox"),dojo.require("dijit.form.TextBox"),dojo.require("dijit._editor._Plugin"),dojo.require("dijit.form.Button"),dojo.require("dojox.editor.plugins.ToolbarLineBreak"),dojo.require("dojo.i18n"),dojo.requireLocalization("dojox.editor.plugins",
"FindReplace",null,"ROOT,ar,ca,cs,da,de,el,es,fi,fr,he,hu,it,ja,kk,ko,nb,nl,pl,pt,pt-pt,ro,ru,sk,sl,sv,th,tr,zh,zh-tw"),dojo.experimental("dojox.editor.plugins.FindReplace"),dojo.declare("dojox.editor.plugins._FindReplaceCloseBox",[dijit._Widget,dijit._Templated],{btnId:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='float: right' class='dijitInline' tabindex='-1'><button class='dijit dijitReset dijitInline' id='${btnId}' dojoAttachPoint='button' dojoType='dijit.form.Button' tabindex='-1' iconClass='dijitEditorIconsFindReplaceClose' showLabel='false'>X</button></span>",
postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.btnId=this.id+"_close";this.inherited(arguments)},startup:function(){this.connect(this.button,"onClick","onClick")},onClick:function(){}}),dojo.declare("dojox.editor.plugins._FindReplaceTextBox",[dijit._Widget,dijit._Templated],{textId:"",label:"",toolTip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' class='dijit dijitReset dijitInline dijitEditorFindReplaceTextBox' title='${tooltip}' tabindex='-1'><label class='dijitLeft dijitInline' for='${textId}' tabindex='-1'>${label}</label><input dojoType='dijit.form.TextBox' required='false' intermediateChanges='true' class='focusTextBox'tabIndex='0' id='${textId}' dojoAttachPoint='textBox, focusNode' value='' dojoAttachEvent='onKeyPress: _onKeyPress'/></span>",
postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.textId=this.id+"_text";this.inherited(arguments)},postCreate:function(){this.textBox.set("value","");this.disabled=this.textBox.get("disabled");this.connect(this.textBox,"onChange","onChange")},_setValueAttr:function(a){this.value=a;this.textBox.set("value",a)},focus:function(){this.textBox.focus()},_setDisabledAttr:function(a){this.disabled=a;this.textBox.set("disabled",a)},onChange:function(a){this.value=
a},_onKeyPress:function(a){var b=0,c=0;if(a.target&&!a.ctrlKey&&!a.altKey&&!a.shiftKey)if(a.keyCode==dojo.keys.LEFT_ARROW)b=a.target.selectionStart,c=a.target.selectionEnd,b<c&&(dijit.selectInputText(a.target,b,b),dojo.stopEvent(a));else if(a.keyCode==dojo.keys.RIGHT_ARROW)b=a.target.selectionStart,c=a.target.selectionEnd,b<c&&(dijit.selectInputText(a.target,c,c),dojo.stopEvent(a))}}),dojo.declare("dojox.editor.plugins._FindReplaceCheckBox",[dijit._Widget,dijit._Templated],{checkId:"",label:"",tooltip:"",
widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' tabindex='-1' class='dijit dijitReset dijitInline dijitEditorFindReplaceCheckBox' title='${tooltip}' ><input dojoType='dijit.form.CheckBox' required=false tabIndex='0' id='${checkId}' dojoAttachPoint='checkBox, focusNode' value=''/><label tabindex='-1' class='dijitLeft dijitInline' for='${checkId}'>${label}</label></span>",postMixInProperties:function(){this.id=dijit.getUniqueId(this.declaredClass.replace(/\./g,"_"));
this.checkId=this.id+"_check";this.inherited(arguments)},postCreate:function(){this.checkBox.set("checked",!1);this.disabled=this.checkBox.get("disabled");this.checkBox.isFocusable=function(){return!1}},_setValueAttr:function(a){this.checkBox.set("value",a)},_getValueAttr:function(){return this.checkBox.get("value")},focus:function(){this.checkBox.focus()},_setDisabledAttr:function(a){this.disabled=a;this.checkBox.set("disabled",a)}}),dojo.declare("dojox.editor.plugins._FindReplaceToolbar",dijit.Toolbar,
{postCreate:function(){this.connectKeyNavHandlers([],[]);this.connect(this.containerNode,"onclick","_onToolbarEvent");this.connect(this.containerNode,"onkeydown","_onToolbarEvent");dojo.addClass(this.domNode,"dijitToolbar")},addChild:function(a,b){dijit._KeyNavContainer.superclass.addChild.apply(this,arguments)},_onToolbarEvent:function(a){a.stopPropagation()}}),dojo.declare("dojox.editor.plugins.FindReplace",[dijit._editor._Plugin],{buttonClass:dijit.form.ToggleButton,iconClassPrefix:"dijitEditorIconsFindReplace",
editor:null,button:null,_frToolbar:null,_closeBox:null,_findField:null,_replaceField:null,_findButton:null,_replaceButton:null,_replaceAllButton:null,_caseSensitive:null,_backwards:null,_promDialog:null,_promDialogTimeout:null,_strings:null,_initButton:function(){this._strings=dojo.i18n.getLocalization("dojox.editor.plugins","FindReplace");this.button=new dijit.form.ToggleButton({label:this._strings.findReplace,showLabel:!1,iconClass:this.iconClassPrefix+" dijitEditorIconFindString",tabIndex:"-1",
onChange:dojo.hitch(this,"_toggleFindReplace")});dojo.isOpera&&this.button.set("disabled",!0);this.connect(this.button,"set",dojo.hitch(this,function(a,b){a==="disabled"&&this._toggleFindReplace(!b&&this._displayed,!0,!0)}))},setEditor:function(a){this.editor=a;this._initButton()},toggle:function(){this.button.set("checked",!this.button.get("checked"))},_toggleFindReplace:function(a,b,c){var d=dojo.marginBox(this.editor.domNode);if(a&&!dojo.isOpera){if(dojo.style(this._frToolbar.domNode,"display",
"block"),this._populateFindField(),!b)this._displayed=!0}else{dojo.style(this._frToolbar.domNode,"display","none");if(!b)this._displayed=!1;c||this.editor.focus()}this.editor.resize({h:d.h})},_populateFindField:function(){var a=dojo.withGlobal(this.editor.window,"getSelectedText",dijit._editor.selection,[null]);this._findField&&this._findField.textBox&&(a&&this._findField.textBox.set("value",a),this._findField.textBox.focus(),dijit.selectInputText(this._findField.textBox.focusNode))},setToolbar:function(a){this.inherited(arguments);
if(!dojo.isOpera){var b=this._frToolbar=new dojox.editor.plugins._FindReplaceToolbar;dojo.style(b.domNode,"display","none");dojo.place(b.domNode,a.domNode,"after");b.startup();this._closeBox=new dojox.editor.plugins._FindReplaceCloseBox;b.addChild(this._closeBox);this._findField=new dojox.editor.plugins._FindReplaceTextBox({label:this._strings.findLabel,tooltip:this._strings.findTooltip});b.addChild(this._findField);this._replaceField=new dojox.editor.plugins._FindReplaceTextBox({label:this._strings.replaceLabel,
tooltip:this._strings.replaceTooltip});b.addChild(this._replaceField);b.addChild(new dojox.editor.plugins.ToolbarLineBreak);this._findButton=new dijit.form.Button({label:this._strings.findButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconFind"});this._findButton.titleNode.title=this._strings.findButtonTooltip;b.addChild(this._findButton);this._replaceButton=new dijit.form.Button({label:this._strings.replaceButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplace"});
this._replaceButton.titleNode.title=this._strings.replaceButtonTooltip;b.addChild(this._replaceButton);this._replaceAllButton=new dijit.form.Button({label:this._strings.replaceAllButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplaceAll"});this._replaceAllButton.titleNode.title=this._strings.replaceAllButtonTooltip;b.addChild(this._replaceAllButton);this._caseSensitive=new dojox.editor.plugins._FindReplaceCheckBox({label:this._strings.matchCase,tooltip:this._strings.matchCaseTooltip});
b.addChild(this._caseSensitive);this._backwards=new dojox.editor.plugins._FindReplaceCheckBox({label:this._strings.backwards,tooltip:this._strings.backwardsTooltip});b.addChild(this._backwards);this._findButton.set("disabled",!0);this._replaceButton.set("disabled",!0);this._replaceAllButton.set("disabled",!0);this.connect(this._findField,"onChange","_checkButtons");this.connect(this._findField,"onKeyDown","_onFindKeyDown");this.connect(this._replaceField,"onKeyDown","_onReplaceKeyDown");this.connect(this._findButton,
"onClick","_find");this.connect(this._replaceButton,"onClick","_replace");this.connect(this._replaceAllButton,"onClick","_replaceAll");this.connect(this._closeBox,"onClick","toggle");this._promDialog=new dijit.TooltipDialog;this._promDialog.startup();this._promDialog.set("content","")}},_checkButtons:function(){this._findField.get("value")?(this._findButton.set("disabled",!1),this._replaceButton.set("disabled",!1),this._replaceAllButton.set("disabled",!1)):(this._findButton.set("disabled",!0),this._replaceButton.set("disabled",
!0),this._replaceAllButton.set("disabled",!0))},_onFindKeyDown:function(a){a.keyCode==dojo.keys.ENTER&&(this._find(),dojo.stopEvent(a))},_onReplaceKeyDown:function(a){a.keyCode==dojo.keys.ENTER&&(this._replace()||this._replace(),dojo.stopEvent(a))},_find:function(a){var b=this._findField.get("value")||"";if(b){var c=this._caseSensitive.get("value"),d=this._backwards.get("value"),b=this._findText(b,c,d);if(!b&&a)this._promDialog.set("content",dojo.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextFind})),
dijit.popup.open({popup:this._promDialog,around:this._findButton.domNode}),this._promDialogTimeout=setTimeout(dojo.hitch(this,function(){clearTimeout(this._promDialogTimeout);this._promDialogTimeout=null;dijit.popup.close(this._promDialog)}),3E3),setTimeout(dojo.hitch(this,function(){this.editor.focus()}),0);return b}return!1},_replace:function(a){var b=!1,c=this.editor;c.focus();var d=this._findField.get("value")||"",e=this._replaceField.get("value")||"";if(d){var f=this._caseSensitive.get("value"),
h=this._backwards.get("value"),g=dojo.withGlobal(c.window,"getSelectedText",dijit._editor.selection,[null]);dojo.isMoz&&(d=dojo.trim(d),g=dojo.trim(g));d=this._filterRegexp(d,!f);g&&d.test(g)&&(c.execCommand("inserthtml",e),b=!0,h&&(this._findText(e,f,h),dojo.withGlobal(c.window,"collapse",dijit._editor.selection,[!0])));if(!this._find(!1)&&a)this._promDialog.set("content",dojo.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextReplace})),dijit.popup.open({popup:this._promDialog,
around:this._replaceButton.domNode}),this._promDialogTimeout=setTimeout(dojo.hitch(this,function(){clearTimeout(this._promDialogTimeout);this._promDialogTimeout=null;dijit.popup.close(this._promDialog)}),3E3),setTimeout(dojo.hitch(this,function(){this.editor.focus()}),0);return b}return null},_replaceAll:function(a){var b=0;this._backwards.get("value")?this.editor.placeCursorAtEnd():this.editor.placeCursorAtStart();this._replace(!1)&&b++;var c=dojo.hitch(this,function(){if(this._replace(!1))b++,setTimeout(c,
10);else if(a)this._promDialog.set("content",dojo.string.substitute(this._strings.replaceDialogText,{0:""+b})),dijit.popup.open({popup:this._promDialog,around:this._replaceAllButton.domNode}),this._promDialogTimeout=setTimeout(dojo.hitch(this,function(){clearTimeout(this._promDialogTimeout);this._promDialogTimeout=null;dijit.popup.close(this._promDialog)}),3E3),setTimeout(dojo.hitch(this,function(){this._findField.focus();this._findField.textBox.focusNode.select()}),0)});c()},_findText:function(a,
b,c){var d=this.editor,e=d.window,f=!1;if(a)e.find?f=e.find(a,b,c,!1,!1,!1,!1):(e=d.document,e.selection&&(this.editor.focus(),d=e.body.createTextRange(),(f=e.selection?e.selection.createRange():null)&&(c?d.setEndPoint("EndToStart",f):d.setEndPoint("StartToEnd",f)),b=b?4:0,c&&(b|=1),(f=d.findText(a,d.text.length,b))&&d.select()));return f},_filterRegexp:function(a,b){for(var c="",d=null,e=0;e<a.length;e++)switch(d=a.charAt(e),d){case "\\":c+=d;e++;c+=a.charAt(e);break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":c+=
"\\";default:c+=d}c="^"+c+"$";return b?RegExp(c,"mi"):RegExp(c,"m")},updateState:function(){this.button.set("disabled",this.get("disabled"))},destroy:function(){this.inherited(arguments);if(this._promDialogTimeout)clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,dijit.popup.close(this._promDialog);if(this._frToolbar)this._frToolbar.destroyRecursive(),this._frToolbar=null;if(this._promDialog)this._promDialog.destroyRecursive(),this._promDialog=null}}),dojo.subscribe(dijit._scopeName+
".Editor.getPlugin",null,function(a){if(!a.plugin&&a.args.name.toLowerCase()==="findreplace")a.plugin=new dojox.editor.plugins.FindReplace({})}));