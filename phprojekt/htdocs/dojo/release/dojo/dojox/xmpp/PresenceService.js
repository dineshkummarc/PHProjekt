/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.xmpp.PresenceService"])dojo._hasResource["dojox.xmpp.PresenceService"]=!0,dojo.provide("dojox.xmpp.PresenceService"),dojox.xmpp.presence={UPDATE:201,SUBSCRIPTION_REQUEST:202,SUBSCRIPTION_SUBSTATUS_NONE:204,SUBSCRIPTION_NONE:"none",SUBSCRIPTION_FROM:"from",SUBSCRIPTION_TO:"to",SUBSCRIPTION_BOTH:"both",SUBSCRIPTION_REQUEST_PENDING:"pending",STATUS_ONLINE:"online",STATUS_AWAY:"away",STATUS_CHAT:"chat",STATUS_DND:"dnd",STATUS_EXTENDED_AWAY:"xa",STATUS_OFFLINE:"offline",STATUS_INVISIBLE:"invisible"},
dojo.declare("dojox.xmpp.PresenceService",null,{constructor:function(a){this.session=a;this.isInvisible=!1;this.presence=this.avatarHash=null;this.restrictedContactjids={}},publish:function(a){this.presence=a;this._setPresence()},sendAvatarHash:function(a){this.avatarHash=a;this._setPresence()},_setPresence:function(){var a=this.presence,b={xmlns:"jabber:client"};if(a&&a.to)b.to=a.to;if(a.show&&a.show==dojox.xmpp.presence.STATUS_OFFLINE)b.type="unavailable";if(a.show&&a.show==dojox.xmpp.presence.STATUS_INVISIBLE)this._setInvisible(),
this.isInvisible=!0;else{this.isInvisible&&this._setVisible();b=new dojox.string.Builder(dojox.xmpp.util.createElement("presence",b,!1));a.show&&a.show!=dojox.xmpp.presence.STATUS_OFFLINE&&(b.append(dojox.xmpp.util.createElement("show",{},!1)),b.append(a.show),b.append("</show>"));a.status&&(b.append(dojox.xmpp.util.createElement("status",{},!1)),b.append(a.status),b.append("</status>"));this.avatarHash&&(b.append(dojox.xmpp.util.createElement("x",{xmlns:"vcard-temp:x:update"},!1)),b.append(dojox.xmpp.util.createElement("photo",
{},!1)),b.append(this.avatarHash),b.append("</photo>"),b.append("</x>"));if(a.priority&&a.show!=dojox.xmpp.presence.STATUS_OFFLINE){if(a.priority>127||a.priority<-128)a.priority=5;b.append(dojox.xmpp.util.createElement("priority",{},!1));b.append(a.priority);b.append("</priority>")}b.append("</presence>");this.session.dispatchPacket(b.toString())}},toggleBlockContact:function(a){this.restrictedContactjids[a]||(this.restrictedContactjids[a]=this._createRestrictedJid());this.restrictedContactjids[a].blocked=
!this.restrictedContactjids[a].blocked;this._updateRestricted();return this.restrictedContactjids},toggleContactInvisiblity:function(a){this.restrictedContactjids[a]||(this.restrictedContactjids[a]=this._createRestrictedJid());this.restrictedContactjids[a].invisible=!this.restrictedContactjids[a].invisible;this._updateRestricted();return this.restrictedContactjids},_createRestrictedJid:function(){return{invisible:!1,blocked:!1}},_updateRestricted:function(){var a={id:this.session.getNextIqId(),from:this.session.jid+
"/"+this.session.resource,type:"set"},b=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",a,!1));b.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1));b.append(dojox.xmpp.util.createElement("list",{name:"iwcRestrictedContacts"},!1));var e=1,c;for(c in this.restrictedContactjids){var d=this.restrictedContactjids[c];d.blocked||d.invisible?(b.append(dojox.xmpp.util.createElement("item",{value:dojox.xmpp.util.encodeJid(c),action:"deny",order:e++},!1)),d.blocked&&b.append(dojox.xmpp.util.createElement("message",
{},!0)),d.invisible&&b.append(dojox.xmpp.util.createElement("presence-out",{},!0)),b.append("</item>")):delete this.restrictedContactjids[c]}b.append("</list>");b.append("</query>");b.append("</iq>");a=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",a,!1));a.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1));a.append(dojox.xmpp.util.createElement("active",{name:"iwcRestrictedContacts"},!0));a.append("</query>");a.append("</iq>");this.session.dispatchPacket(b.toString());
this.session.dispatchPacket(a.toString())},_setVisible:function(){var a={id:this.session.getNextIqId(),from:this.session.jid+"/"+this.session.resource,type:"set"},a=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",a,!1));a.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1));a.append(dojox.xmpp.util.createElement("active",{},!0));a.append("</query>");a.append("</iq>");this.session.dispatchPacket(a.toString())},_setInvisible:function(){var a={id:this.session.getNextIqId(),
from:this.session.jid+"/"+this.session.resource,type:"set"},b=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",a,!1));b.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1));b.append(dojox.xmpp.util.createElement("list",{name:"invisible"},!1));b.append(dojox.xmpp.util.createElement("item",{action:"deny",order:"1"},!1));b.append(dojox.xmpp.util.createElement("presence-out",{},!0));b.append("</item>");b.append("</list>");b.append("</query>");b.append("</iq>");a={id:this.session.getNextIqId(),
from:this.session.jid+"/"+this.session.resource,type:"set"};a=new dojox.string.Builder(dojox.xmpp.util.createElement("iq",a,!1));a.append(dojox.xmpp.util.createElement("query",{xmlns:"jabber:iq:privacy"},!1));a.append(dojox.xmpp.util.createElement("active",{name:"invisible"},!0));a.append("</query>");a.append("</iq>");this.session.dispatchPacket(b.toString());this.session.dispatchPacket(a.toString())},_manageSubscriptions:function(a,b){a&&(a.indexOf("@")==-1&&(a+="@"+this.session.domain),this.session.dispatchPacket(dojox.xmpp.util.createElement("presence",
{to:a,type:b},!0)))},subscribe:function(a){this._manageSubscriptions(a,"subscribe")},approveSubscription:function(a){this._manageSubscriptions(a,"subscribed")},unsubscribe:function(a){this._manageSubscriptions(a,"unsubscribe")},declineSubscription:function(a){this._manageSubscriptions(a,"unsubscribed")},cancelSubscription:function(a){this._manageSubscriptions(a,"unsubscribed")}});