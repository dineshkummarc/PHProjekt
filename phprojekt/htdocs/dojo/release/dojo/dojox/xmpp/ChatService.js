/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.xmpp.ChatService"])dojo._hasResource["dojox.xmpp.ChatService"]=!0,dojo.provide("dojox.xmpp.ChatService"),dojox.xmpp.chat={CHAT_STATE_NS:"http://jabber.org/protocol/chatstates",ACTIVE_STATE:"active",COMPOSING_STATE:"composing",INACTIVE_STATE:"inactive",PAUSED_STATE:"paused",GONE_STATE:"gone"},dojo.declare("dojox.xmpp.ChatService",null,{state:"",constructor:function(){this.state="";this.chatid=Math.round(Math.random()*1E15)},recieveMessage:function(b,a){if(b&&!a)this.onNewMessage(b)},
setSession:function(b){this.session=b},setState:function(b){if(this.state!=b)this.state=b},invite:function(b){if(!this.uid){if(!b||b=="")throw Error("ChatService::invite() contact is NULL");this.uid=b;var a=new dojox.string.Builder(dojox.xmpp.util.createElement("message",{xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},!1));a.append(dojox.xmpp.util.createElement("thread",{},!1));a.append(this.chatid);a.append("</thread>");a.append(dojox.xmpp.util.createElement("active",
{xmlns:dojox.xmpp.chat.CHAT_STATE_NS},!0));a.append("</message>");this.session.dispatchPacket(a.toString());this.onInvite(b);this.setState(dojox.xmpp.chat.CHAT_STATE_NS)}},sendMessage:function(b){if(this.uid&&(b.body&&b.body!=""||b.xhtml)){var a=new dojox.string.Builder(dojox.xmpp.util.createElement("message",{xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},!1)),c=dojox.xmpp.util.createElement("html",{xmlns:dojox.xmpp.xmpp.XHTML_IM_NS},!1),d=dojox.xmpp.util.createElement("body",
{"xml:lang":this.session.lang,xmlns:dojox.xmpp.xmpp.XHTML_BODY_NS},!1)+b.body+"</body>",b=dojox.xmpp.util.createElement("body",{},!1)+dojox.xmpp.util.stripHtml(b.body)+"</body>";a.subject&&a.subject!=""&&(a.append(dojox.xmpp.util.createElement("subject",{},!1)),a.append(a.subject),a.append("</subject>"));a.append(b);a.append(c);a.append(d);a.append("</html>");a.append(dojox.xmpp.util.createElement("thread",{},!1));a.append(this.chatid);a.append("</thread>");this.useChatStates&&a.append(dojox.xmpp.util.createElement("active",
{xmlns:dojox.xmpp.chat.CHAT_STATE_NS},!0));a.append("</message>");this.session.dispatchPacket(a.toString())}},sendChatState:function(b){if(this.useChatState&&!this.firstMessage&&b!=this._currentState){var a=new dojox.string.Builder(dojox.xmpp.util.createElement("message",{xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},!1));a.append(dojox.xmpp.util.createElement(b,{xmlns:dojox.xmpp.chat.CHAT_STATE_NS},!0));this._currentState=b;a.append("<thread>");a.append(this.chatid);
a.append("</thread></message>");this.session.dispatchPacket(a.toString())}},onNewMessage:function(){},onInvite:function(){}});