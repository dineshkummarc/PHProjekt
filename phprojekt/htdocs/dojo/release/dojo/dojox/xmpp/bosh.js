/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.xmpp.bosh"])dojo._hasResource["dojox.xmpp.bosh"]=!0,dojo.provide("dojox.xmpp.bosh"),dojo.require("dojo.io.script"),dojo.require("dojo.io.iframe"),dojo.require("dojox.xml.parser"),dojox.xmpp.bosh={transportIframes:[],initialize:function(a){this.transportIframes=[];for(var b=dojox._scopeName+".xmpp.bosh",c=dojo.connect(dojo.getObject(b),"_iframeOnload",this,function(b){b==0&&(a.load(),dojo.disconnect(c))}),d=0;d<a.iframes;d++){var e="xmpp-transport-"+d,f=dojo.byId("xmpp-transport-"+
d);f&&(window[e]&&(window[e]=null),window.frames[e]&&(window.frames[e]=null),dojo.destroy(f));f=dojo.io.iframe.create("xmpp-transport-"+d,b+"._iframeOnload("+d+");");this.transportIframes.push(f)}},_iframeOnload:function(a){dojo.io.iframe.doc(dojo.byId("xmpp-transport-"+a)).write("<script>var isLoaded=true; var rid=0; var transmiting=false; function _BOSH_(msg) { transmiting=false; parent.dojox.xmpp.bosh.handle(msg, rid); } <\/script>")},findOpenIframe:function(){for(var a=0;a<this.transportIframes.length;a++){var b=
this.transportIframes[a],c=b.contentWindow;if(c.isLoaded&&!c.transmiting)return b}return!1},handle:function(a,b){var c=this["rid"+b],d=dojox.xml.parser.parse(a,"text/xml");d?c.ioArgs.xmppMessage=d:c.errback(Error("Recieved bad document from server: "+a))},get:function(a){var b=this.findOpenIframe(),c=dojo.io.iframe.doc(b);a.frameDoc=c;var a=this._makeScriptDeferred(a),d=a.ioArgs;b.contentWindow.rid=d.rid;b.contentWindow.transmiting=!0;dojo._ioAddQueryToUrl(d);dojo._ioNotifyStart(a);dojo.io.script.attach(d.id,
d.url,c);dojo._ioWatch(a,this._validCheck,this._ioCheck,this._resHandle);return a},remove:function(a,b){dojo.destroy(dojo.byId(a,b));this[a]&&delete this[a]},_makeScriptDeferred:function(a){var b=dojo._ioSetArgs(a,this._deferredCancel,this._deferredOk,this._deferredError),c=b.ioArgs;c.id="rid"+a.rid;c.rid=a.rid;c.canDelete=!0;c.frameDoc=a.frameDoc;return this[c.id]=b},_deferredCancel:function(a){a.canceled=!0;a.ioArgs.canDelete&&dojox.xmpp.bosh._addDeadScript(a.ioArgs)},_deferredOk:function(a){a=
a.ioArgs;a.canDelete&&dojox.xmpp.bosh._addDeadScript(a);return a.xmppMessage||a},_deferredError:function(a,b){b.ioArgs.canDelete&&(a.dojoType=="timeout"?dojox.xmpp.bosh.remove(b.ioArgs.id,b.ioArgs.frameDoc):dojox.xmpp.bosh._addDeadScript(b.ioArgs));return a},_deadScripts:[],_addDeadScript:function(a){dojox.xmpp.bosh._deadScripts.push({id:a.id,frameDoc:a.frameDoc});a.frameDoc=null},_validCheck:function(){var a=dojox.xmpp.bosh,b=a._deadScripts;if(b&&b.length>0){for(var c=0;c<b.length;c++)a.remove(b[c].id,
b[c].frameDoc),b[c].frameDoc=null;dojox.xmpp.bosh._deadScripts=[]}return!0},_ioCheck:function(a){return a.ioArgs.xmppMessage?!0:!1},_resHandle:function(a){dojox.xmpp.bosh._ioCheck(a)?a.callback(a):a.errback(Error("inconceivable dojox.xmpp.bosh._resHandle error"))}};