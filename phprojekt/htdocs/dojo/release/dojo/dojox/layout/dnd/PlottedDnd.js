/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.layout.dnd.PlottedDnd"]&&(dojo._hasResource["dojox.layout.dnd.PlottedDnd"]=!0,dojo.provide("dojox.layout.dnd.PlottedDnd"),dojo.require("dojo.dnd.Source"),dojo.require("dojo.dnd.Manager"),dojo.require("dojox.layout.dnd.Avatar"),dojo.declare("dojox.layout.dnd.PlottedDnd",[dojo.dnd.Source],{GC_OFFSET_X:dojo.dnd.manager().OFFSET_X,GC_OFFSET_Y:dojo.dnd.manager().OFFSET_Y,constructor:function(a,b){this.childBoxes=null;this.dropIndicator=new dojox.layout.dnd.DropIndicator("dndDropIndicator",
"div");this.withHandles=b.withHandles;this.handleClasses=b.handleClasses;this.opacity=b.opacity;this.allowAutoScroll=b.allowAutoScroll;this.dom=b.dom;this.skipForm=this.singular=!0;this._over=!1;this.defaultHandleClass="GcDndHandle";this.isDropped=!1;this._timer=null;this.isOffset=b.isOffset?!0:!1;this.offsetDrag=b.offsetDrag?b.offsetDrag:{x:0,y:0};this.hideSource=b.hideSource?b.hideSource:!0;this._drop=this.dropIndicator.create()},_calculateCoords:function(a){dojo.forEach(this.node.childNodes,function(b){var c=
dojo.coords(b,!0);b.coords={xy:c,w:b.offsetWidth/2,h:b.offsetHeight/2,mw:c.w};if(a)b.coords.mh=c.h},this)},_legalMouseDown:function(a){if(!this.withHandles)return!0;for(a=a.target;a&&a!=this.node;a=a.parentNode)if(dojo.hasClass(a,this.defaultHandleClass))return!0;return!1},setDndItemSelectable:function(a,b){for(var c=a;c&&a!=this.node;c=c.parentNode)if(dojo.hasClass(c,"dojoDndItem")){dojo.setSelectable(c,b);break}},getDraggedWidget:function(a){for(;a&&a.nodeName.toLowerCase()!="body"&&!dojo.hasClass(a,
"dojoDndItem");)a=a.parentNode;return a?dijit.byNode(a):null},isAccepted:function(a){return(a=a?a.getAttribute("dndtype"):null)&&a in this.accept},onDndStart:function(a,b,c){this.firstIndicator=a==this;this._calculateCoords(!0);var d=dojo.dnd.manager();b[0].coords?(this._drop.style.height=b[0].coords.mh+"px",dojo.style(d.avatar.node,"width",b[0].coords.mw+"px")):this._drop.style.height=d.avatar.node.clientHeight+"px";this.dndNodes=b;dojox.layout.dnd.PlottedDnd.superclass.onDndStart.call(this,a,b,
c);a==this&&this.hideSource&&dojo.forEach(b,function(a){dojo.style(a,"display","none")})},onDndCancel:function(){if(dojo.dnd.manager().source==this&&this.hideSource){var a=this.getSelectedNodes();dojo.forEach(a,function(a){dojo.style(a,"display","")})}dojox.layout.dnd.PlottedDnd.superclass.onDndCancel.call(this);this.deleteDashedZone()},onDndDrop:function(a,b,c,d){try{if(this.isAccepted(b[0])){if(a==this&&this._over&&this.dropObject)this.current=this.dropObject.c;dojox.layout.dnd.PlottedDnd.superclass.onDndDrop.call(this,
a,b,c,d);this._calculateCoords(!0)}else this.onDndCancel()}catch(e){console.warn(e)}},onMouseDown:function(a){if(this.current==null)this.selection={};else if(this.current==this.anchor)this.anchor=null;if(this.current!==null){var b=dojo.coords(this.current,!0);this.current.coords={xy:b,w:this.current.offsetWidth/2,h:this.current.offsetHeight/2,mh:b.h,mw:b.w};this._drop.style.height=this.current.coords.mh+"px";if(this.isOffset){if(this.offsetDrag.x==0&&this.offsetDrag.y==0){var c=!0,b=dojo.coords(this._getChildByEvent(a));
this.offsetDrag.x=b.x-a.pageX;this.offsetDrag.y=b.y-a.clientY}if(this.offsetDrag.y<16&&this.current!=null)this.offsetDrag.y=this.GC_OFFSET_Y;b=dojo.dnd.manager();b.OFFSET_X=this.offsetDrag.x;b.OFFSET_Y=this.offsetDrag.y;if(c)this.offsetDrag.x=0,this.offsetDrag.y=0}}dojo.dnd.isFormElement(a)?this.setDndItemSelectable(a.target,!0):(this.containerSource=!0,c=this.getDraggedWidget(a.target),(!c||!c.dragRestriction)&&dojox.layout.dnd.PlottedDnd.superclass.onMouseDown.call(this,a))},onMouseUp:function(a){dojox.layout.dnd.PlottedDnd.superclass.onMouseUp.call(this,
a);this.containerSource=!1;!dojo.isIE&&this.mouseDown&&this.setDndItemSelectable(a.target,!0);a=dojo.dnd.manager();a.OFFSET_X=this.GC_OFFSET_X;a.OFFSET_Y=this.GC_OFFSET_Y},onMouseMove:function(a){var b=dojo.dnd.manager();if(this.isDragging){var c=!1;if(this.current!=null||this.current==null&&!this.dropObject)if(this.isAccepted(b.nodes[0])||this.containerSource)c=this.setIndicatorPosition(a);if(this.current!=this.targetAnchor||c!=this.before)this._markTargetAnchor(c),b.canDrop(!this.current||b.source!=
this||!(this.current.id in this.selection));this.allowAutoScroll&&this._checkAutoScroll(a)}else this.mouseDown&&this.isSource&&(c=this.getSelectedNodes(),c.length&&b.startDrag(this,c,this.copyState(dojo.isCopyKey(a)))),this.allowAutoScroll&&this._stopAutoScroll()},_markTargetAnchor:function(a){if(!(this.current==this.targetAnchor&&this.before==a))this.targetAnchor=this.current,this.targetBox=null,this.before=a},_unmarkTargetAnchor:function(){if(this.targetAnchor)this.targetBox=this.targetAnchor=null,
this.before=!0},setIndicatorPosition:function(a){var b=!1;if(this.current){if(!this.current.coords||this.allowAutoScroll)this.current.coords={xy:dojo.coords(this.current,!0),w:this.current.offsetWidth/2,h:this.current.offsetHeight/2};b=this.horizontal?a.pageX-this.current.coords.xy.x<this.current.coords.w:a.pageY-this.current.coords.xy.y<this.current.coords.h;this.insertDashedZone(b)}else this.dropObject||this.insertDashedZone(!1);return b},onOverEvent:function(){this._over=!0;dojox.layout.dnd.PlottedDnd.superclass.onOverEvent.call(this);
if(this.isDragging){var a=dojo.dnd.manager();!this.current&&!this.dropObject&&this.getSelectedNodes()[0]&&this.isAccepted(a.nodes[0])&&this.insertDashedZone(!1)}},onOutEvent:function(){this.containerSource=this._over=!1;dojox.layout.dnd.PlottedDnd.superclass.onOutEvent.call(this);this.dropObject&&this.deleteDashedZone()},deleteDashedZone:function(){this._drop.style.display="none";for(var a=this._drop.nextSibling;a!=null;)a.coords.xy.y-=parseInt(this._drop.style.height),a=a.nextSibling;delete this.dropObject},
insertDashedZone:function(a){if(this.dropObject)if(a==this.dropObject.b&&(this.current&&this.dropObject.c==this.current.id||!this.current&&!this.dropObject.c))return;else this.deleteDashedZone();this.dropObject={n:this._drop,c:this.current?this.current.id:null,b:a};if(this.current)if(dojo.place(this._drop,this.current,a?"before":"after"),this.firstIndicator)this.firstIndicator=!1;else for(a=this._drop.nextSibling;a!=null;)a.coords.xy.y+=parseInt(this._drop.style.height),a=a.nextSibling;else this.node.appendChild(this._drop);
this._drop.style.display=""},insertNodes:function(a,b,c,d){if(this.dropObject)dojo.style(this.dropObject.n,"display","none"),dojox.layout.dnd.PlottedDnd.superclass.insertNodes.call(this,!0,b,!0,this.dropObject.n),this.deleteDashedZone();else return dojox.layout.dnd.PlottedDnd.superclass.insertNodes.call(this,a,b,c,d);if(a=dijit.byId(b[0].getAttribute("widgetId")))dojox.layout.dnd._setGcDndHandle(a,this.withHandles,this.handleClasses),this.hideSource&&dojo.style(a.domNode,"display","")},_checkAutoScroll:function(a){this._timer&&
clearTimeout(this._timer);this._stopAutoScroll();var b=this.dom,c=this._sumAncestorProperties(b,"offsetTop");if(a.pageY-b.offsetTop+30>b.clientHeight)this.autoScrollActive=!0,this._autoScrollDown(b);else if(b.scrollTop>0&&a.pageY-c<30)this.autoScrollActive=!0,this._autoScrollUp(b)},_autoScrollUp:function(a){if(this.autoScrollActive&&a.scrollTop>0)a.scrollTop-=30,this._timer=setTimeout(dojo.hitch(this,"_autoScrollUp",a),100)},_autoScrollDown:function(a){if(this.autoScrollActive&&a.scrollTop<a.scrollHeight-
a.clientHeight)a.scrollTop+=30,this._timer=setTimeout(dojo.hitch(this,"_autoScrollDown",a),100)},_stopAutoScroll:function(){this.autoScrollActive=!1},_sumAncestorProperties:function(a,b){a=dojo.byId(a);if(!a)return 0;for(var c=0;a;){var d=a[b];if(d&&(c+=d-0,a==dojo.body()))break;a=a.parentNode}return c}}),dojox.layout.dnd._setGcDndHandle=function(a,b,c,d){d||dojo.query(".GcDndHandle",a.domNode).removeClass("GcDndHandle");if(b){b=!1;for(d=c.length-1;d>=0;d--){var e=dojo.query("."+c[d],a.domNode)[0];
if(e&&(b=!0,c[d]!="GcDndHandle")){var f=dojo.query(".GcDndHandle",a.domNode);f.length==0?dojo.removeClass(a.domNode,"GcDndHandle"):f.removeClass("GcDndHandle");dojo.addClass(e,"GcDndHandle")}}b||dojo.addClass(a.domNode,"GcDndHandle")}else dojo.addClass(a.domNode,"GcDndHandle")},dojo.declare("dojox.layout.dnd.DropIndicator",null,{constructor:function(a,b){this.tag=b||"div";this.style=a||null},isInserted:function(){return this.node.parentNode&&this.node.parentNode.nodeType==1},create:function(){if(this.node&&
this.isInserted())return this.node;var a=dojo.doc.createElement(this.tag);this.style?(a.className=this.style,a.style.height="90px"):dojo.style(a,{position:"relative",border:"1px dashed #F60",margin:"2px",height:"90px"});return this.node=a},destroy:function(){if(this.node&&this.isInserted())this.node.parentNode.removeChild(this.node),this.node=null}}),dojo.extend(dojo.dnd.Manager,{canDrop:function(a){a=this.target&&a;if(this.canDropFlag!=a)this.canDropFlag=a,this.avatar&&this.avatar.update()},makeAvatar:function(){return this.source.declaredClass==
"dojox.layout.dnd.PlottedDnd"?new dojox.layout.dnd.Avatar(this,this.source.opacity):new dojo.dnd.Avatar(this)}}),dojo.isIE))dojox.layout.dnd.handdleIE=[dojo.subscribe("/dnd/start",null,function(){IEonselectstart=document.body.onselectstart;document.body.onselectstart=function(){return!1}}),dojo.subscribe("/dnd/cancel",null,function(){document.body.onselectstart=IEonselectstart}),dojo.subscribe("/dnd/drop",null,function(){document.body.onselectstart=IEonselectstart})],dojo.addOnWindowUnload(function(){dojo.forEach(dojox.layout.dnd.handdleIE,
dojo.unsubscribe)});