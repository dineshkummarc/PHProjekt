/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.widget.RollingList"]||(dojo._hasResource["dojox.widget.RollingList"]=!0,dojo.provide("dojox.widget.RollingList"),dojo.experimental("dojox.widget.RollingList"),dojo.require("dojo.window"),dojo.require("dijit.layout.ContentPane"),dojo.require("dijit._Templated"),dojo.require("dijit._Contained"),dojo.require("dijit.layout._LayoutWidget"),dojo.require("dijit.Menu"),dojo.require("dijit.form.Button"),dojo.require("dojox.html.metrics"),dojo.require("dojo.i18n"),dojo.requireLocalization("dijit",
"common",null,"ROOT,ar,ca,cs,da,de,el,es,fi,fr,he,hu,it,ja,kk,ko,nb,nl,pl,pt,pt-pt,ro,ru,sk,sl,sv,th,tr,zh,zh-tw"),dojo.declare("dojox.widget._RollingListPane",[dijit.layout.ContentPane,dijit._Templated,dijit._Contained],{templateString:'<div class="dojoxRollingListPane"><table><tbody><tr><td dojoAttachPoint="containerNode"></td></tr></tbody></div>',parentWidget:null,parentPane:null,store:null,items:null,query:null,queryOptions:null,_focusByNode:!0,minWidth:0,_setContentAndScroll:function(a,b){this._setContent(a,
b);this.parentWidget.scrollIntoView(this)},_updateNodeWidth:function(a,b){a.style.width="";dojo.marginBox(a).w<b&&dojo.marginBox(a,{w:b})},_onMinWidthChange:function(a){this._updateNodeWidth(this.domNode,a)},_setMinWidthAttr:function(a){if(a!==this.minWidth)this.minWidth=a,this._onMinWidthChange(a)},startup:function(){this._started||(this.store&&this.store.getFeatures()["dojo.data.api.Notification"]&&window.setTimeout(dojo.hitch(this,function(){this.connect(this.store,"onSet","_onSetItem");this.connect(this.store,
"onNew","_onNewItem");this.connect(this.store,"onDelete","_onDeleteItem")}),1),this.connect(this.focusNode||this.domNode,"onkeypress","_focusKey"),this.parentWidget._updateClass(this.domNode,"Pane"),this.inherited(arguments),this._onMinWidthChange(this.minWidth))},_focusKey:function(a){a.charOrCode==dojo.keys.BACKSPACE?dojo.stopEvent(a):a.charOrCode==dojo.keys.LEFT_ARROW&&this.parentPane?(this.parentPane.focus(),this.parentWidget.scrollIntoView(this.parentPane)):a.charOrCode==dojo.keys.ENTER&&this.parentWidget._onExecute()},
focus:function(a){if(this.parentWidget._focusedPane!=this&&(this.parentWidget._focusedPane=this,this.parentWidget.scrollIntoView(this),this._focusByNode&&(!this.parentWidget._savedFocus||a)))try{(this.focusNode||this.domNode).focus()}catch(b){}},_onShow:function(){(this.store||this.items)&&(this.refreshOnShow&&this.domNode||!this.isLoaded&&this.domNode)&&this.refresh()},_load:function(){this.isLoaded=!1;this.items?(this._setContentAndScroll(this.onLoadStart(),!0),window.setTimeout(dojo.hitch(this,
"_doQuery"),1)):this._doQuery()},_doLoadItems:function(a,b){var c=0,e=this.store;dojo.forEach(a,function(a){e.isItemLoaded(a)||c++});if(c===0)b();else{var d=function(){c--;c===0&&b()};dojo.forEach(a,function(a){e.isItemLoaded(a)||e.loadItem({item:a,onItem:d})})}},_doQuery:function(){if(this.domNode){var a=this.parentWidget.preloadItems,a=a===!0||this.items&&this.items.length<=Number(a);if(this.items&&a)this._doLoadItems(this.items,dojo.hitch(this,"onItems"));else if(this.items)this.onItems();else this._setContentAndScroll(this.onFetchStart(),
!0),this.store.fetch({query:this.query,onComplete:function(a){this.items=a;this.onItems()},onError:function(a){this._onError("Fetch",a)},scope:this})}},_hasItem:function(a){for(var b=this.items||[],c=0,e;e=b[c];c++)if(this.parentWidget._itemsMatch(e,a))return!0;return!1},_onSetItem:function(a){this._hasItem(a)&&this.refresh()},_onNewItem:function(a,b){var c;!b&&!this.parentPane||b&&this.parentPane&&this.parentPane._hasItem(b.item)&&(c=this.parentPane._getSelected())&&this.parentWidget._itemsMatch(c.item,
b.item)?(this.items.push(a),this.refresh()):b&&this.parentPane&&this._hasItem(b.item)&&this.refresh()},_onDeleteItem:function(a){if(this._hasItem(a))this.items=dojo.filter(this.items,function(b){return b!=a}),this.refresh()},onFetchStart:function(){return this.loadingMessage},onFetchError:function(){return this.errorMessage},onLoadStart:function(){return this.loadingMessage},onLoadError:function(){return this.errorMessage},onItems:function(){if(!this.onLoadDeferred)this.cancel(),this.onLoadDeferred=
new dojo.Deferred(dojo.hitch(this,"cancel"));this._onLoadHandler()}}),dojo.declare("dojox.widget._RollingListGroupPane",[dojox.widget._RollingListPane],{templateString:'<div><div dojoAttachPoint="containerNode"></div><div dojoAttachPoint="menuContainer"><div dojoAttachPoint="menuNode"></div></div></div>',_menu:null,_setContent:function(a){this._menu||this.inherited(arguments)},_onMinWidthChange:function(a){if(this._menu){var b=dojo.marginBox(this.domNode).w,c=dojo.marginBox(this._menu.domNode).w;
this._updateNodeWidth(this._menu.domNode,a-(b-c))}},onItems:function(){var a;this._menu&&(a=this._getSelected(),this._menu.destroyRecursive());this._menu=this._getMenu();var b,c;this.items.length?dojo.forEach(this.items,function(e){if(b=this.parentWidget._getMenuItemForItem(e,this))a&&this.parentWidget._itemsMatch(b.item,a.item)&&(c=b),this._menu.addChild(b)},this):(b=this.parentWidget._getMenuItemForItem(null,this))&&this._menu.addChild(b);if(c){if(this._setSelected(c),a&&!a.children&&c.children||
a&&a.children&&!c.children){var e=this.parentWidget._getPaneForItem(c.item,this,c.children);e?this.parentWidget.addChild(e,this.getIndexInParent()+1):(this.parentWidget._removeAfter(this),this.parentWidget._onItemClick(null,this,c.item,c.children))}}else a&&this.parentWidget._removeAfter(this);this.containerNode.innerHTML="";this.containerNode.appendChild(this._menu.domNode);this.parentWidget.scrollIntoView(this);this._checkScrollConnection(!0);this.inherited(arguments);this._onMinWidthChange(this.minWidth)},
_checkScrollConnection:function(a){var b=this.store;this._scrollConn&&this.disconnect(this._scrollConn);delete this._scrollConn;if(!dojo.every(this.items,function(a){return b.isItemLoaded(a)}))a&&this._loadVisibleItems(),this._scrollConn=this.connect(this.domNode,"onscroll","_onScrollPane")},startup:function(){this.inherited(arguments);this.parentWidget._updateClass(this.domNode,"GroupPane")},focus:function(a){if(this._menu){this._pendingFocus&&this.disconnect(this._pendingFocus);delete this._pendingFocus;
var b=this._menu.focusedChild;if(!b){var c=dojo.query(".dojoxRollingListItemSelected",this.domNode)[0];c&&(b=dijit.byNode(c))}b||(b=this._menu.getChildren()[0]||this._menu);this._focusByNode=!1;if(b.focusNode){if(!this.parentWidget._savedFocus||a)try{b.focusNode.focus()}catch(e){}window.setTimeout(function(){try{dojo.window.scrollIntoView(b.focusNode)}catch(a){}},1)}else b.focus?(!this.parentWidget._savedFocus||a)&&b.focus():this._focusByNode=!0;this.inherited(arguments)}else if(!this._pendingFocus)this._pendingFocus=
this.connect(this,"onItems","focus")},_getMenu:function(){var a=this,b=new dijit.Menu({parentMenu:this.parentPane?this.parentPane._menu:null,onCancel:function(){a.parentPane&&a.parentPane.focus(!0)},_moveToPopup:function(a){this.focusedChild&&!this.focusedChild.disabled&&this.focusedChild._onClick(a)}},this.menuNode);this.connect(b,"onItemClick",function(a,e){if(!a.disabled)if(e.alreadySelected=dojo.hasClass(a.domNode,"dojoxRollingListItemSelected"),e.alreadySelected&&(e.type=="keypress"&&e.charOrCode!=
dojo.keys.ENTER||e.type=="internal")){var d=this.parentWidget.getChildren()[this.getIndexInParent()+1];d&&(d.focus(!0),this.parentWidget.scrollIntoView(d))}else this._setSelected(a,b),this.parentWidget._onItemClick(e,this,a.item,a.children),e.type=="keypress"&&e.charOrCode==dojo.keys.ENTER&&this.parentWidget._onExecute()});b._started||b.startup();return b},_onScrollPane:function(){this._visibleLoadPending&&window.clearTimeout(this._visibleLoadPending);this._visibleLoadPending=window.setTimeout(dojo.hitch(this,
"_loadVisibleItems"),500)},_loadVisibleItems:function(){delete this._visibleLoadPending;var a=this._menu;if(a){var b=a.getChildren();if(b&&b.length){var c=function(a,b,c){var e=dojo.getComputedStyle(a),d=0;b&&(d+=dojo._getMarginExtents(a,e).t);c&&(d+=dojo._getPadBorderExtents(a,e).t);return d},c=c(this.domNode,!1,!0)+c(this.containerNode,!0,!0)+c(a.domNode,!0,!0)+c(b[0].domNode,!0,!1),e=dojo.contentBox(this.domNode).h,d=this.domNode.scrollTop-c-e/2,f=d+3*e/2,g=dojo.filter(b,function(a){var b=a.domNode.offsetTop,
c=a.store,a=a.item;return b>=d&&b<=f&&!c.isItemLoaded(a)}),h=dojo.map(g,function(a){return a.item}),b=dojo.hitch(this,function(){var b=this._getSelected();dojo.forEach(h,function(c,e){var d=this.parentWidget._getMenuItemForItem(c,this),h=g[e],f=h.getIndexInParent();a.removeChild(h);d&&(b&&this.parentWidget._itemsMatch(d.item,b.item),a.addChild(d,f),a.focusedChild==h&&a.focusChild(d));h.destroy()},this);this._checkScrollConnection(!1)});this._doLoadItems(h,b)}}},_getSelected:function(a){if(!a)a=this._menu;
if(a)for(var a=this._menu.getChildren(),b=0,c;c=a[b];b++)if(dojo.hasClass(c.domNode,"dojoxRollingListItemSelected"))return c;return null},_setSelected:function(a,b){if(!b)b=this._menu;b&&dojo.forEach(b.getChildren(),function(b){this.parentWidget._updateClass(b.domNode,"Item",{Selected:a&&b==a&&!b.disabled})},this)}}),dojo.declare("dojox.widget.RollingList",[dijit._Widget,dijit._Templated,dijit._Container],{templateString:dojo.cache("dojox.widget","RollingList/RollingList.html",'<div class="dojoxRollingList ${className}"\n\t><div class="dojoxRollingListContainer" dojoAttachPoint="containerNode" dojoAttachEvent="onkeypress:_onKey"\n\t></div\n\t><div class="dojoxRollingListButtons" dojoAttachPoint="buttonsNode"\n        ><button dojoType="dijit.form.Button" dojoAttachPoint="okButton"\n\t\t\t\tdojoAttachEvent="onClick:_onExecute">${okButtonLabel}</button\n        ><button dojoType="dijit.form.Button" dojoAttachPoint="cancelButton"\n\t\t\t\tdojoAttachEvent="onClick:_onCancel">${cancelButtonLabel}</button\n\t></div\n></div>\n'),
widgetsInTemplate:!0,className:"",store:null,query:null,queryOptions:null,childrenAttrs:["children"],parentAttr:"",value:null,executeOnDblClick:!0,preloadItems:!1,showButtons:!1,okButtonLabel:"",cancelButtonLabel:"",minPaneWidth:0,postMixInProperties:function(){this.inherited(arguments);var a=dojo.i18n.getLocalization("dijit","common");this.okButtonLabel=this.okButtonLabel||a.buttonOk;this.cancelButtonLabel=this.cancelButtonLabel||a.buttonCancel},_setShowButtonsAttr:function(a){var b=!1;if(this.showButtons!=
a&&this._started||this.showButtons==a&&!this.started)b=!0;dojo.toggleClass(this.domNode,"dojoxRollingListButtonsHidden",!a);this.showButtons=a;b&&(this._started?this.layout():window.setTimeout(dojo.hitch(this,"layout"),0))},_itemsMatch:function(a,b){if(!a&&!b)return!0;else if(!a||!b)return!1;return a==b||this._isIdentity&&this.store.getIdentity(a)==this.store.getIdentity(b)},_removeAfter:function(a){typeof a!="number"&&(a=this.getIndexOfChild(a));a>=0&&dojo.forEach(this.getChildren(),function(b,c){c>
a&&(this.removeChild(b),b.destroyRecursive())},this);for(var b=this.getChildren(),b=b[b.length-1],c=null;b&&!c;){var e=b._getSelected?b._getSelected():null;if(e)c=e.item;b=b.parentPane}this._setInProgress||this._setValue(c)},addChild:function(a,b){b>0&&this._removeAfter(b-1);this.inherited(arguments);a._started||a.startup();a.attr("minWidth",this.minPaneWidth);this.layout();this._savedFocus||a.focus()},_setMinPaneWidthAttr:function(a){if(a!==this.minPaneWidth)this.minPaneWidth=a,dojo.forEach(this.getChildren(),
function(b){b.attr("minWidth",a)})},_updateClass:function(a,b,c){if(!this._declaredClasses)this._declaredClasses=("dojoxRollingList "+this.className).split(" ");dojo.forEach(this._declaredClasses,function(e){if(e){dojo.addClass(a,e+b);for(var d in c||{})dojo.toggleClass(a,e+b+d,c[d]);dojo.toggleClass(a,e+b+"FocusSelected",dojo.hasClass(a,e+b+"Focus")&&dojo.hasClass(a,e+b+"Selected"));dojo.toggleClass(a,e+b+"HoverSelected",dojo.hasClass(a,e+b+"Hover")&&dojo.hasClass(a,e+b+"Selected"))}})},scrollIntoView:function(a){this._scrollingTimeout&&
window.clearTimeout(this._scrollingTimeout);delete this._scrollingTimeout;this._scrollingTimeout=window.setTimeout(dojo.hitch(this,function(){a.domNode&&dojo.window.scrollIntoView(a.domNode);delete this._scrollingTimeout}),1)},resize:function(a){dijit.layout._LayoutWidget.prototype.resize.call(this,a)},layout:function(){var a=this.getChildren();if(this._contentBox){var b=this._contentBox.h-dojo.marginBox(this.buttonsNode).h-dojox.html.metrics.getScrollbar().h;dojo.forEach(a,function(a){dojo.marginBox(a.domNode,
{h:b})})}this._focusedPane?(a=this._focusedPane,delete this._focusedPane,this._savedFocus||a.focus()):a&&a.length&&(this._savedFocus||a[0].focus())},_onChange:function(a){this.onChange(a)},_setValue:function(a){delete this._setInProgress;if(!this._itemsMatch(this.value,a))this.value=a,this._onChange(a)},_setValueAttr:function(a){if((!this._itemsMatch(this.value,a)||a)&&!(this._setInProgress&&this._setInProgress===a))if(this._setInProgress=a,!a||!this.store.isItem(a)){var b=this.getChildren()[0];b._setSelected(null);
this._onItemClick(null,b,null,null)}else{var c=dojo.hitch(this,function(b,c){var e=this.store,d;if(this.parentAttr&&e.getFeatures()["dojo.data.api.Identity"]&&((d=this.store.getValue(b,this.parentAttr))||d==="")){var f=function(a){e.getIdentity(a)==e.getIdentity(b)?c(null):c([a])};d===""?c(null):typeof d=="string"?e.fetchItemByIdentity({identity:d,onItem:f}):e.isItem(d)&&f(d)}else{var j=this.childrenAttrs.length,i=[];dojo.forEach(this.childrenAttrs,function(d){var f={};f[d]=b;e.fetch({query:f,scope:this,
onComplete:function(b){this._setInProgress===a&&(i=i.concat(b),j--,j===0&&c(i))}})},this)}}),e=dojo.hitch(this,function(b,c){var d=b[c],f=this.getChildren()[c],k;if(d&&f){var j=dojo.hitch(this,function(){k&&this.disconnect(k);delete k;if(this._setInProgress===a){var i=dojo.filter(f._menu.getChildren(),function(a){return this._itemsMatch(a.item,d)},this)[0];i&&(c++,f._menu.onItemClick(i,{type:"internal",stopPropagation:function(){},preventDefault:function(){}}),b[c]?e(b,c):(this._setValue(d),this.onItemClick(d,
f,this.getChildItems(d))))}});f.isLoaded?j():k=this.connect(f,"onLoad",j)}else c===0&&this.set("value",null)}),d=[],f=dojo.hitch(this,function(a){a&&a.length?(d.push(a[0]),c(a[0],f)):(a||d.pop(),d.reverse(),e(d,0))}),b=this.domNode.style;b.display=="none"||b.visibility=="hidden"?this._setValue(a):this._itemsMatch(a,this._visibleItem)||f([a])}},_onItemClick:function(a,b,c,e){if(a){var d=this._getPaneForItem(c,b,e);a.type=="click"&&a.alreadySelected&&d?(this._removeAfter(b.getIndexInParent()+1),(d=
b.getNextSibling())&&d._setSelected&&d._setSelected(null),this.scrollIntoView(d)):d?(this.addChild(d,b.getIndexInParent()+1),this._savedFocus&&d.focus(!0)):(this._removeAfter(b),this.scrollIntoView(b))}else b&&(this._removeAfter(b),this.scrollIntoView(b));if(!a||a.type!="internal")this._setValue(c),this.onItemClick(c,b,e);this._visibleItem=c},_getPaneForItem:function(a,b,c){var e=this.getPaneForItem(a,b,c);e.store=this.store;e.parentWidget=this;e.parentPane=b||null;a?e.items=c?c:[a]:(e.query=this.query,
e.queryOptions=this.queryOptions);return e},_getMenuItemForItem:function(a,b){var c=this.store;if(!a||!c||!c.isItem(a))return c=new dijit.MenuItem({label:"---",disabled:!0,iconClass:"dojoxEmpty",focus:function(){}}),this._updateClass(c.domNode,"Item"),c;else{var e=(c=c.isItemLoaded(a))?this.getChildItems(a):void 0,d;if(e)if(d=this.getMenuItemForItem(a,b,e),d.children=e,this._updateClass(d.domNode,"Item",{Expanding:!0}),d._started)dojo.style(d.arrowWrapper,"display","");else var f=d.connect(d,"startup",
function(){this.disconnect(f);dojo.style(this.arrowWrapper,"display","")});else d=this.getMenuItemForItem(a,b,null),c?this._updateClass(d.domNode,"Item",{Single:!0}):(this._updateClass(d.domNode,"Item",{Unloaded:!0}),d.attr("disabled",!0));d.store=this.store;d.item=a;d.label||d.attr("label",this.store.getLabel(a).replace(/</,"&lt;"));if(d.focusNode){var g=this;d.focus=function(){if(!this.disabled)try{this.focusNode.focus()}catch(a){}};d.connect(d.focusNode,"onmouseenter",function(){this.disabled||
g._updateClass(this.domNode,"Item",{Hover:!0})});d.connect(d.focusNode,"onmouseleave",function(){this.disabled||g._updateClass(this.domNode,"Item",{Hover:!1})});d.connect(d.focusNode,"blur",function(){g._updateClass(this.domNode,"Item",{Focus:!1,Hover:!1})});d.connect(d.focusNode,"focus",function(){g._updateClass(this.domNode,"Item",{Focus:!0});g._focusedPane=b});this.executeOnDblClick&&d.connect(d.focusNode,"ondblclick",function(){g._onExecute()})}return d}},_setStore:function(a){if(!(a===this.store&&
this._started))this.store=a,this._isIdentity=a.getFeatures()["dojo.data.api.Identity"],this.addChild(this._getPaneForItem(),0)},_onKey:function(a){if(a.charOrCode==dojo.keys.BACKSPACE)dojo.stopEvent(a);else if(a.charOrCode==dojo.keys.ESCAPE&&this._savedFocus){try{dijit.focus(this._savedFocus)}catch(b){}dojo.stopEvent(a)}else(a.charOrCode==dojo.keys.LEFT_ARROW||a.charOrCode==dojo.keys.RIGHT_ARROW)&&dojo.stopEvent(a)},_resetValue:function(){this.set("value",this._lastExecutedValue)},_onCancel:function(){this._resetValue();
this.onCancel()},_onExecute:function(){this._lastExecutedValue=this.get("value");this.onExecute()},focus:function(){var a=this._savedFocus;this._savedFocus=dijit.getFocus(this);this._savedFocus.node||delete this._savedFocus;if(this._focusedPane){this._savedFocus=dijit.getFocus(this);var b=this._focusedPane;delete this._focusedPane;a||b.focus(!0)}else(b=this.getChildren()[0])&&!a&&b.focus(!0)},handleKey:function(a){if(a.charOrCode==dojo.keys.DOWN_ARROW)return delete this._savedFocus,this.focus(),!1;
else if(a.charOrCode==dojo.keys.ESCAPE)return this._onCancel(),!1;return!0},_updateChildClasses:function(){var a=this.getChildren(),b=a.length;dojo.forEach(a,function(a,e){dojo.toggleClass(a.domNode,"dojoxRollingListPaneCurrentChild",e==b-1);dojo.toggleClass(a.domNode,"dojoxRollingListPaneCurrentSelected",e==b-2)})},startup:function(){if(!this._started){if(!this.getParent||!this.getParent())this.resize(),this.connect(dojo.global,"onresize","resize");this.connect(this,"addChild","_updateChildClasses");
this.connect(this,"removeChild","_updateChildClasses");this._setStore(this.store);this.set("showButtons",this.showButtons);this.inherited(arguments);this._lastExecutedValue=this.get("value")}},getChildItems:function(a){var b,c=this.store;dojo.forEach(this.childrenAttrs,function(e){(e=c.getValues(a,e))&&e.length&&(b=(b||[]).concat(e))});return b},getMenuItemForItem:function(){return new dijit.MenuItem({})},getPaneForItem:function(a,b,c){return!a||c?new dojox.widget._RollingListGroupPane({}):null},
onItemClick:function(){},onExecute:function(){},onCancel:function(){},onChange:function(){}}));