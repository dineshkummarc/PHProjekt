/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.rpc.Service"])dojo._hasResource["dojox.rpc.Service"]=!0,dojo.provide("dojox.rpc.Service"),dojo.require("dojo.AdapterRegistry"),dojo.declare("dojox.rpc.Service",null,{constructor:function(a,b){function c(a){a._baseUrl=new dojo._Url(dojo.isBrowser?location.href:dojo.config.baseUrl,d||".")+"";g._smd=a;for(var b in g._smd.services){for(var a=b.split("."),c=g,f=0;f<a.length-1;f++)c=c[a[f]]||(c[a[f]]={});c[a[a.length-1]]=g._generateService(b,g._smd.services[b])}}var d,g=this;
if(a)if(dojo.isString(a)||a instanceof dojo._Url){d=a instanceof dojo._Url?a+"":a;var f=dojo._getText(d);if(f)c(dojo.fromJson(f));else throw Error("Unable to load SMD from "+a);}else c(a);this._options=b?b:{};this._requestId=0},_generateService:function(a,b){if(this[b])throw Error("WARNING: "+a+" already exists for service. Unable to generate function");b.name=a;var c=dojo.hitch(this,"_executeMethod",b),d=dojox.rpc.transportRegistry.match(b.transport||this._smd.transport);d.getExecutor&&(c=d.getExecutor(c,
b,this));d=b.returns||(b._schema={});d._service=c;c.servicePath="/"+a+"/";c._schema=d;c.id=dojox.rpc.Service._nextId++;return c},_getRequest:function(a,b){var c=this._smd,d=dojox.rpc.envelopeRegistry.match(a.envelope||c.envelope||"NONE"),g=(a.parameters||[]).concat(c.parameters||[]);if(d.namedParams){if(b.length==1&&dojo.isObject(b[0]))b=b[0];else{for(var f={},e=0;e<a.parameters.length;e++)if(typeof b[e]!="undefined"||!a.parameters[e].optional)f[a.parameters[e].name]=b[e];b=f}if(a.strictParameters||
c.strictParameters)for(e in b){for(var f=!1,h=0;h<g.length;h++)g[e].name==e&&(f=!0);f||delete b[e]}for(e=0;e<g.length;e++)if(f=g[e],!f.optional&&f.name&&!b[f.name])if(f["default"])b[f.name]=f["default"];else if(!(f.name in b))throw Error("Required parameter "+f.name+" was omitted");}else g&&g[0]&&g[0].name&&b.length==1&&dojo.isObject(b[0])&&(b=d.namedParams===!1?dojox.rpc.toOrdered(g,b):b[0]);dojo.isObject(this._options)&&(b=dojo.mixin(b,this._options));g=a._schema||a.returns;e=d.serialize.apply(this,
[c,a,b]);e._envDef=d;return dojo.mixin(e,{sync:dojox.rpc._sync,contentType:a.contentType||c.contentType||e.contentType,headers:a.headers||c.headers||e.headers||{},target:e.target||dojox.rpc.getTarget(c,a),transport:a.transport||c.transport||e.transport,envelope:a.envelope||c.envelope||e.envelope,timeout:a.timeout||c.timeout,callbackParamName:a.callbackParamName||c.callbackParamName,rpcObjectParamName:a.rpcObjectParamName||c.rpcObjectParamName,schema:g,handleAs:e.handleAs||"auto",preventCache:a.preventCache||
c.preventCache,frameDoc:this._options.frameDoc||void 0})},_executeMethod:function(a){var b=[],c;for(c=1;c<arguments.length;c++)b.push(arguments[c]);var d=this._getRequest(a,b),b=dojox.rpc.transportRegistry.match(d.transport).fire(d);b.addBoth(function(a){return d._envDef.deserialize.call(this,a)});return b}}),dojox.rpc.getTarget=function(a,b){var c=a._baseUrl;a.target&&(c=new dojo._Url(c,a.target)+"");b.target&&(c=new dojo._Url(c,b.target)+"");return c},dojox.rpc.toOrdered=function(a,b){if(dojo.isArray(b))return b;
for(var c=[],d=0;d<a.length;d++)c.push(b[a[d].name]);return c},dojox.rpc.transportRegistry=new dojo.AdapterRegistry(!0),dojox.rpc.envelopeRegistry=new dojo.AdapterRegistry(!0),dojox.rpc.envelopeRegistry.register("URL",function(a){return a=="URL"},{serialize:function(a,b,c){return{data:dojo.objectToQuery(c),transport:"POST"}},deserialize:function(a){return a},namedParams:!0}),dojox.rpc.envelopeRegistry.register("JSON",function(a){return a=="JSON"},{serialize:function(a,b,c){return{data:dojo.toJson(c),
handleAs:"json",contentType:"application/json"}},deserialize:function(a){return a}}),dojox.rpc.envelopeRegistry.register("PATH",function(a){return a=="PATH"},{serialize:function(a,b,c){var d,a=dojox.rpc.getTarget(a,b);if(dojo.isArray(c))for(d=0;d<c.length;d++)a+="/"+c[d];else for(d in c)a+="/"+d+"/"+c[d];return{data:"",target:a}},deserialize:function(a){return a}}),dojox.rpc.transportRegistry.register("POST",function(a){return a=="POST"},{fire:function(a){a.url=a.target;a.postData=a.data;return dojo.rawXhrPost(a)}}),
dojox.rpc.transportRegistry.register("GET",function(a){return a=="GET"},{fire:function(a){a.url=a.target+(a.data?"?"+(a.rpcObjectParamName?a.rpcObjectParamName+"=":"")+a.data:"");return dojo.xhrGet(a)}}),dojox.rpc.transportRegistry.register("JSONP",function(a){return a=="JSONP"},{fire:function(a){a.url=a.target+(a.target.indexOf("?")==-1?"?":"&")+(a.rpcObjectParamName?a.rpcObjectParamName+"=":"")+a.data;a.callbackParamName=a.callbackParamName||"callback";return dojo.io.script.get(a)}}),dojox.rpc.Service._nextId=
1,dojo._contentHandlers.auto=function(a){var b=dojo._contentHandlers,c=a.getResponseHeader("Content-Type");return!c?b.text(a):c.match(/\/.*json/)?b.json(a):c.match(/\/javascript/)?b.javascript(a):c.match(/\/xml/)?b.xml(a):b.text(a)};