/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.rpc.JsonRest"]){dojo._hasResource["dojox.rpc.JsonRest"]=!0;dojo.provide("dojox.rpc.JsonRest");dojo.require("dojox.json.ref");dojo.require("dojox.rpc.Rest");var dirtyObjects=[],Rest=dojox.rpc.Rest,jr,resolveJson=function(a,c,b,d){(c=c.ioArgs&&c.ioArgs.xhr&&c.ioArgs.xhr.getResponseHeader("Last-Modified"))&&Rest._timeStamps&&(Rest._timeStamps[d]=c);var e=a._schema&&a._schema.hrefProperty;if(e)dojox.json.ref.refAttribute=e;b=b&&dojox.json.ref.resolveJson(b,{defaultId:d,index:Rest._index,
timeStamps:c&&Rest._timeStamps,time:c,idPrefix:a.servicePath.replace(/[^\/]*$/,""),idAttribute:jr.getIdAttribute(a),schemas:jr.schemas,loader:jr._loader,idAsRef:a.idAsRef,assignAbsoluteIds:!0});dojox.json.ref.refAttribute="$ref";return b};jr=dojox.rpc.JsonRest={serviceClass:dojox.rpc.Rest,conflictDateHeader:"If-Unmodified-Since",commit:function(a){for(var a=a||{},c=[],b={},d=[],e=0;e<dirtyObjects.length;e++){var g=dirtyObjects[e],f=g.object,i=g.old;if((!a.service||!f&&!i||!(f||i).__id.indexOf(a.service.servicePath))&&
g.save){delete f.__isDirty;if(f)if(i){var h;if(h=f.__id.match(/(.*)#.*/))f=Rest._index[h[1]];if(!(f.__id in b)){b[f.__id]=f;if(a.incrementalUpdates&&!h)var j=(typeof a.incrementalUpdates=="function"?a.incrementalUpdates:function(){j={};for(var a in f)if(f.hasOwnProperty(a))f[a]!==i[a]&&(j[a]=f[a]);else if(i.hasOwnProperty(a))return null;return j})(f,i);j?c.push({method:"post",target:f,content:j}):c.push({method:"put",target:f,content:f})}}else h=jr.getServiceAndId(f.__id).service,jr.getIdAttribute(h)in
f&&!a.alwaysPostNewItems?c.push({method:"put",target:f,content:f}):c.push({method:"post",target:{__id:h.servicePath},content:f});else i&&c.push({method:"delete",target:i});d.push(g);dirtyObjects.splice(e--,1)}}dojo.connect(a,"onError",function(){if(a.revertOnError!==!1){var b=dirtyObjects;dirtyObjects=d;jr.revert();dirtyObjects=b}else dirtyObjects=dirtyObject.concat(d)});jr.sendToServer(c,a);return c},sendToServer:function(a,c){var b=dojo.xhr,d=a.length,e,g,f,i=this.conflictDateHeader;dojo.xhr=function(c,
d){d.headers=d.headers||{};d.headers.Transaction=a.length-1==e?"commit":"open";i&&f&&(d.headers[i]=f);g&&(d.headers["Content-ID"]="<"+g+">");return b.apply(dojo,arguments)};for(e=0;e<a.length;e++){var h=a[e];dojox.rpc.JsonRest._contentId=h.content&&h.content.__id;var j=h.method=="post";(f=h.method=="put"&&Rest._timeStamps[h.content.__id])&&(Rest._timeStamps[h.content.__id]=new Date+"");g=j&&dojox.rpc.JsonRest._contentId;var k=jr.getServiceAndId(h.target.__id),j=k.service,k=h.deferred=j[h.method](k.id.replace(/#/,
""),dojox.json.ref.toJson(h.content,!1,j.servicePath,!0));(function(b,e,f){e.addCallback(function(g){try{var h=e.ioArgs.xhr&&e.ioArgs.xhr.getResponseHeader("Location");if(h){var i=h.match(/(^\w+:\/\/)/)&&h.indexOf(f.servicePath),h=i>0?h.substring(i):(f.servicePath+h).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3");b.__id=h;Rest._index[h]=b}g=resolveJson(f,e,g,b&&b.__id)}catch(j){}--d||c.onComplete&&c.onComplete.call(c.scope,a);return g})})(h.content,k,j);k.addErrback(function(a){d=
-1;c.onError.call(c.scope,a)})}dojo.xhr=b},getDirtyObjects:function(){return dirtyObjects},revert:function(a){for(var c=dirtyObjects.length;c>0;){c--;var b=dirtyObjects[c],d=b.object,b=b.old,e=dojox.data._getStoreForItem(d||b);if(!a||!d&&!b||!(d||b).__id.indexOf(a.servicePath)){if(d&&b){for(var g in b)if(b.hasOwnProperty(g)&&d[g]!==b[g]){if(e)e.onSet(d,g,d[g],b[g]);d[g]=b[g]}for(g in d)if(!b.hasOwnProperty(g)){if(e)e.onSet(d,g,d[g]);delete d[g]}}else if(b){if(e)e.onNew(b)}else if(e)e.onDelete(d);
delete (d||b).__isDirty;dirtyObjects.splice(c,1)}}},changing:function(a,c){if(a.__id){a.__isDirty=!0;for(var b=0;b<dirtyObjects.length;b++){var d=dirtyObjects[b];if(a==d.object){if(c&&(d.object=!1,!this._saveNotNeeded))d.save=!0;return}}d=a instanceof Array?[]:{};for(b in a)a.hasOwnProperty(b)&&(d[b]=a[b]);dirtyObjects.push({object:!c&&a,old:d,save:!this._saveNotNeeded})}},deleteObject:function(a){this.changing(a,!0)},getConstructor:function(a,c){if(typeof a=="string"){var b=a,a=new dojox.rpc.Rest(a,
!0);this.registerService(a,b,c)}if(a._constructor)return a._constructor;a._constructor=function(b){function c(a){if(a){c(a["extends"]);i=a.properties;for(var b in i){var d=i[b];d&&typeof d=="object"&&"default"in d&&(g[b]=d["default"])}}a&&a.prototype&&a.prototype.initialize&&(h=!0,a.prototype.initialize.apply(g,f))}var g=this,f=arguments,i,h;c(a._schema);!h&&b&&typeof b=="object"&&dojo.mixin(g,b);var j=jr.getIdAttribute(a);Rest._index[this.__id=this.__clientId=a.servicePath+(this[j]||Math.random().toString(16).substring(2,
14)+"@"+(dojox.rpc.Client&&dojox.rpc.Client.clientId||"client"))]=this;dojox.json.schema&&i&&dojox.json.schema.mustBeValid(dojox.json.schema.validate(this,a._schema));dirtyObjects.push({object:this,save:!0})};return dojo.mixin(a._constructor,a._schema,{load:a})},fetch:function(a){a=jr.getServiceAndId(a);return this.byId(a.service,a.id)},getIdAttribute:function(a){var a=a._schema,c;if(a&&!(c=a._idAttr))for(var b in a.properties)if(a.properties[b].identity||a.properties[b].link=="self")a._idAttr=c=
b;return c||"id"},getServiceAndId:function(a){var c="",b;for(b in jr.services)a.substring(0,b.length)==b&&b.length>=c.length&&(c=b);if(c)return{service:jr.services[c],id:a.substring(c.length)};a=a.match(/^(.*\/)([^\/]*)$/);return{service:new jr.serviceClass(a[1],!0),id:a[2]}},services:{},schemas:{},registerService:function(a,c,b){c=a.servicePath=c||a.servicePath;a._schema=jr.schemas[c]=b||a._schema||{};jr.services[c]=a},byId:function(a,c){var b,d=Rest._index[(a.servicePath||"")+c];return d&&!d._loadObject?
(b=new dojo.Deferred,b.callback(d),b):this.query(a,c)},query:function(a,c,b){var d=a(c,b);d.addCallback(function(e){return e.nodeType&&e.cloneNode?e:resolveJson(a,d,e,typeof c!="string"||b&&(b.start||b.count)?void 0:c)});return d},_loader:function(a){var c=jr.getServiceAndId(this.__id),b=this;jr.query(c.service,c.id).addBoth(function(c){c==b?(delete c.$ref,delete c._loadObject):b._loadObject=function(a){a(c)};a(c)})},isDirty:function(a){return!a?!!dirtyObjects.length:a.__isDirty}}};