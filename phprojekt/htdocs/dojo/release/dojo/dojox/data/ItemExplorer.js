/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.ItemExplorer"]||(dojo._hasResource["dojox.data.ItemExplorer"]=!0,dojo.provide("dojox.data.ItemExplorer"),dojo.require("dijit.Tree"),dojo.require("dijit.Dialog"),dojo.require("dijit.Menu"),dojo.require("dijit.form.ValidationTextBox"),dojo.require("dijit.form.Textarea"),dojo.require("dijit.form.Button"),dojo.require("dijit.form.CheckBox"),dojo.require("dijit.form.FilteringSelect"),function(){var k=function(b,a,c){var d=b.getValues(a,c);d.length<2&&(d=b.getValue(a,c));return d};
dojo.declare("dojox.data.ItemExplorer",dijit.Tree,{useSelect:!1,refSelectSearchAttr:null,constructor:function(b){dojo.mixin(this,b);var a=this,c={},d=this.rootModelNode={value:c,id:"root"};this._modelNodeIdMap={};this._modelNodePropMap={};var e=1;this.model={getRoot:function(a){a(d)},mayHaveChildren:function(a){return a.value&&typeof a.value=="object"&&!(a.value instanceof Date)},getChildren:function(b,d){function e(){if(l)g=a.store.getAttributes(f),i=f;else if(f&&typeof f=="object"){i=b.value;g=
[];for(var c in f)f.hasOwnProperty(c)&&c!="__id"&&c!="__clientId"&&g.push(c)}if(g){for(var j=0;c=g[j++];)m.push({property:c,value:l?k(a.store,f,c):f[c],parent:i});m.push({addNew:!0,parent:i,parentNode:b})}d(m)}var g,i,f=b.value,m=[];if(f==c)d([]);else{var l=a.store&&a.store.isItem(f,!0);l&&!a.store.isItemLoaded(f)?a.store.loadItem({item:f,onItem:function(a){f=a;e()}}):e()}},getIdentity:function(b){if(!b.id){if(b.addNew)b.property="--addNew";b.id=e++;if(a.store){if(a.store.isItem(b.value)){var c=a.store.getIdentity(b.value);
(a._modelNodeIdMap[c]=a._modelNodeIdMap[c]||[]).push(b)}b.parent&&(c=a.store.getIdentity(b.parent)+"."+b.property,(a._modelNodePropMap[c]=a._modelNodePropMap[c]||[]).push(b))}}return b.id},getLabel:function(a){return a===d?"Object Properties":a.addNew?a.parent instanceof Array?"Add new value":"Add new property":a.property+": "+(a.value instanceof Array?"("+a.value.length+" elements)":a.value)},onChildrenChange:function(){},onChange:function(){}}},postCreate:function(){this.inherited(arguments);dojo.connect(this,
"onClick",function(a,b){this.lastFocused=b;a.addNew?this._addProperty():this._editProperty()});var b=new dijit.Menu({targetNodeIds:[this.rootNode.domNode],id:"contextMenu"});dojo.connect(b,"_openMyself",this,function(a){if(a=dijit.getEnclosingWidget(a.target)){var c=a.item;this.store.isItem(c.value,!0)&&!c.parent?(dojo.forEach(b.getChildren(),function(a){a.attr("disabled",a.label!="Add")}),this.lastFocused=a):c.value&&typeof c.value=="object"&&!(c.value instanceof Date)?(dojo.forEach(b.getChildren(),
function(a){a.attr("disabled",a.label!="Add"&&a.label!="Delete")}),this.lastFocused=a):c.property&&dojo.indexOf(this.store.getIdentityAttributes(),c.property)>=0?(this.focusNode(a),alert("Cannot modify an Identifier node.")):c.addNew?this.focusNode(a):(dojo.forEach(b.getChildren(),function(a){a.attr("disabled",a.label!="Edit"&&a.label!="Delete")}),this.lastFocused=a)}});b.addChild(new dijit.MenuItem({label:"Add",onClick:dojo.hitch(this,"_addProperty")}));b.addChild(new dijit.MenuItem({label:"Edit",
onClick:dojo.hitch(this,"_editProperty")}));b.addChild(new dijit.MenuItem({label:"Delete",onClick:dojo.hitch(this,"_destroyProperty")}));b.startup()},store:null,setStore:function(b){this.store=b;var a=this;this._editDialog&&(this._editDialog.destroyRecursive(),delete this._editDialog);dojo.connect(b,"onSet",function(b,d,e,h){var k=a.store.getIdentity(b);if((b=a._modelNodeIdMap[k])&&(e===void 0||h===void 0||e instanceof Array||h instanceof Array||typeof e=="object"||typeof h=="object"))for(e=0;e<b.length;e++)(function(b){a.model.getChildren(b,
function(c){a.model.onChildrenChange(b,c)})})(b[e]);if(b=a._modelNodePropMap[k+"."+d])for(e=0;e<b.length;e++)b[e].value=h,a.model.onChange(b[e])});this.rootNode.setChildItems([])},setItem:function(b){(this._modelNodeIdMap={})[this.store.getIdentity(b)]=[this.rootModelNode];this._modelNodePropMap={};this.rootModelNode.value=b;var a=this;this.model.getChildren(this.rootModelNode,function(b){a.rootNode.setChildItems(b)})},refreshItem:function(){this.setItem(this.rootModelNode.value)},_createEditDialog:function(){this._editDialog=
new dijit.Dialog({title:"Edit Property",execute:dojo.hitch(this,"_updateItem"),preload:!0});this._editDialog.placeAt(dojo.body());this._editDialog.startup();var b=dojo.doc.createElement("div"),a=dojo.doc.createElement("label");dojo.attr(a,"for","property");dojo.style(a,"fontWeight","bold");dojo.attr(a,"innerHTML","Property:");b.appendChild(a);(new dijit.form.ValidationTextBox({name:"property",value:"",required:!0,disabled:!0})).placeAt(b);b.appendChild(dojo.doc.createElement("br"));b.appendChild(dojo.doc.createElement("br"));
(new dijit.form.RadioButton({name:"itemType",value:"value",onClick:dojo.hitch(this,function(){this._enableFields("value")})})).placeAt(b);a=dojo.doc.createElement("label");dojo.attr(a,"for","value");dojo.attr(a,"innerHTML","Value (JSON):");b.appendChild(a);a=dojo.doc.createElement("div");dojo.addClass(a,"value");(new dijit.form.Textarea({name:"jsonVal"})).placeAt(a);b.appendChild(a);(new dijit.form.RadioButton({name:"itemType",value:"reference",onClick:dojo.hitch(this,function(){this._enableFields("reference")})})).placeAt(b);
a=dojo.doc.createElement("label");dojo.attr(a,"for","_reference");dojo.attr(a,"innerHTML","Reference (ID):");b.appendChild(a);b.appendChild(dojo.doc.createElement("br"));a=dojo.doc.createElement("div");dojo.addClass(a,"reference");this.useSelect?(new dijit.form.FilteringSelect({name:"_reference",store:this.store,searchAttr:this.refSelectSearchAttr||this.store.getIdentityAttributes()[0],required:!1,value:null,pageSize:10})).placeAt(a):(new dijit.form.ValidationTextBox({name:"_reference",value:"",promptMessage:"Enter the ID of the item to reference",
isValid:dojo.hitch(this,function(){return!0})})).placeAt(a);b.appendChild(a);b.appendChild(dojo.doc.createElement("br"));b.appendChild(dojo.doc.createElement("br"));a=document.createElement("div");a.setAttribute("dir","rtl");(new dijit.form.Button({type:"reset",label:"Cancel"})).placeAt(a).onClick=dojo.hitch(this._editDialog,"onCancel");(new dijit.form.Button({type:"submit",label:"OK"})).placeAt(a);b.appendChild(a);this._editDialog.attr("content",b)},_enableFields:function(b){switch(b){case "reference":dojo.query(".value [widgetId]",
this._editDialog.containerNode).forEach(function(a){dijit.getEnclosingWidget(a).attr("disabled",!0)});dojo.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(a){dijit.getEnclosingWidget(a).attr("disabled",!1)});break;case "value":dojo.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(a){dijit.getEnclosingWidget(a).attr("disabled",!1)}),dojo.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(a){dijit.getEnclosingWidget(a).attr("disabled",
!0)})}},_updateItem:function(b){function a(){try{var a,f=[],j=b.property;if(n){for(;!g.isItem(d.parent,!0);)c=c.getParent(),f.push(d.property),d=c.item;if(f.length==0)g.setValue(d.parent,d.property,e);else{h=k(g,d.parent,d.property);h instanceof Array&&(h=h.concat());for(a=h;f.length>1;)a=a[f.pop()];a[f]=e;g.setValue(d.parent,d.property,h)}}else if(g.isItem(i,!0))if(g.isItemLoaded(i)){if(i instanceof Array)j=i.length;g.setValue(i,j,e)}else g.loadItem({item:i,onItem:function(a){if(a instanceof Array)j=
a.length;g.setValue(a,j,e)}});else{for(d.value instanceof Array?f.push(d.value.length):f.push(b.property);!g.isItem(d.parent,!0);)c=c.getParent(),f.push(d.property),d=c.item;for(a=h=k(g,d.parent,d.property);f.length>1;)a=a[f.pop()];a[f]=e;g.setValue(d.parent,d.property,h)}}catch(o){alert(o)}}var c,d,e,h,n=this._editDialog.attr("title")=="Edit Property",j=this._editDialog,g=this.store;if(j.validate()){c=this.lastFocused;d=c.item;var i=d.value;if(d.addNew)i=c.item.parent,c=c.getParent(),d=c.item;e=
null;switch(b.itemType){case "reference":this.store.fetchItemByIdentity({identity:b._reference,onItem:function(b){e=b;a()},onError:function(){alert("The id could not be found")}});break;case "value":var f=b.jsonVal;e=dojo.fromJson(f);if(typeof e=="function")e.toString=function(){return f};a()}}else j.show()},_editProperty:function(){var b=dojo.mixin({},this.lastFocused.item);this._editDialog?this._editDialog.reset():this._createEditDialog();if(dojo.indexOf(this.store.getIdentityAttributes(),b.property)>=
0)alert("Cannot Edit an Identifier!");else if(this._editDialog.attr("title","Edit Property"),dijit.getEnclosingWidget(dojo.query("input",this._editDialog.containerNode)[0]).attr("disabled",!0),this.store.isItem(b.value,!0)){if(b.parent)b.itemType="reference",this._enableFields(b.itemType),b._reference=this.store.getIdentity(b.value),this._editDialog.attr("value",b),this._editDialog.show()}else if(!b.value||typeof b.value!="object"||b.value instanceof Date)b.itemType="value",this._enableFields(b.itemType),
b.jsonVal=typeof b.value=="function"?b.value.toString():b.value instanceof Date?'new Date("'+b.value+'")':dojo.toJson(b.value),this._editDialog.attr("value",b),this._editDialog.show()},_destroyProperty:function(){for(var b=this.lastFocused,a=b.item,c=[];!this.store.isItem(a.parent,!0)||a.parent instanceof Array;)b=b.getParent(),c.push(a.property),a=b.item;if(dojo.indexOf(this.store.getIdentityAttributes(),a.property)>=0)alert("Cannot Delete an Identifier!");else try{if(c.length>0){var d,e=k(this.store,
a.parent,a.property);for(d=e;c.length>1;)d=d[c.pop()];dojo.isArray(d)?d.splice(c,1):delete d[c];this.store.setValue(a.parent,a.property,e)}else this.store.unsetAttribute(a.parent,a.property)}catch(h){alert(h)}},_addProperty:function(){var b=this.lastFocused.item,a=b.value,c=dojo.hitch(this,function(){var b=null;this._editDialog?this._editDialog.reset():this._createEditDialog();a instanceof Array?(b=a.length,dijit.getEnclosingWidget(dojo.query("input",this._editDialog.containerNode)[0]).attr("disabled",
!0)):dijit.getEnclosingWidget(dojo.query("input",this._editDialog.containerNode)[0]).attr("disabled",!1);this._editDialog.attr("title","Add Property");this._enableFields("value");this._editDialog.attr("value",{itemType:"value",property:b});this._editDialog.show()});if(b.addNew)b=this.lastFocused.getParent().item,a=this.lastFocused.item.parent;b.property&&dojo.indexOf(this.store.getIdentityAttributes(),b.property)>=0?alert("Cannot add properties to an ID node!"):this.store.isItem(a,!0)&&!this.store.isItemLoaded(a)?
this.store.loadItem({item:a,onItem:function(b){a=b;c()}}):c()}})}());