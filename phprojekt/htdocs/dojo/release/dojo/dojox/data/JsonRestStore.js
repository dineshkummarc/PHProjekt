/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.data.JsonRestStore"])dojo._hasResource["dojox.data.JsonRestStore"]=!0,dojo.provide("dojox.data.JsonRestStore"),dojo.require("dojox.rpc.JsonRest"),dojo.require("dojox.data.ServiceStore"),dojo.declare("dojox.data.JsonRestStore",dojox.data.ServiceStore,{constructor:function(a){dojo.connect(dojox.rpc.Rest._index,"onUpdate",this,function(a,b,c,e){var j=this.service.servicePath;if(a.__id){if(a.__id.substring(0,j.length)==j)this.onSet(a,b,c,e)}else console.log("no id on updated object ",
a)});this.idAttribute=this.idAttribute||"id";if(typeof a.target=="string"&&(a.target=a.target.match(/\/$/)||this.allowNoTrailingSlash?a.target:a.target+"/",!this.service))this.service=dojox.rpc.JsonRest.services[a.target]||dojox.rpc.Rest(a.target,!0);dojox.rpc.JsonRest.registerService(this.service,a.target,this.schema);this.schema=this.service._schema=this.schema||this.service._schema||{};this.service._store=this;this.service.idAsRef=this.idAsRef;this.schema._idAttr=this.idAttribute;var b=dojox.rpc.JsonRest.getConstructor(this.service),
c=this;this._constructor=function(a){b.call(this,a);c.onNew(this)};this._constructor.prototype=b.prototype;this._index=dojox.rpc.Rest._index},loadReferencedSchema:!0,idAsRef:!1,referenceIntegrity:!0,target:"",allowNoTrailingSlash:!1,newItem:function(a,b){a=new this._constructor(a);if(b){var c=this.getValue(b.parent,b.attribute,[]),c=c.concat([a]);a.__parent=c;this.setValue(b.parent,b.attribute,c)}return a},deleteItem:function(a){var b=[],c=dojox.data._getStoreForItem(a)||this;if(this.referenceIntegrity){dojox.rpc.JsonRest._saveNotNeeded=
!0;var i=dojox.rpc.Rest._index,d=function(e){var j;var f;b.push(e);e.__checked=1;for(var g in e)if(g.substring(0,2)!="__"){var h=e[g];h==a?e!=i&&(e instanceof Array?(f=f||[]).push(g):(dojox.data._getStoreForItem(e)||c).unsetAttribute(e,g)):typeof h=="object"&&h&&(h.__checked||d(h),typeof h.__checked=="object"&&e!=i&&(dojox.data._getStoreForItem(e)||c).setValue(e,g,h.__checked))}if(f){g=f.length;for(j=e.__checked=e.concat(),e=j;g--;)e.splice(f[g],1);return e}return null};d(i);dojox.rpc.JsonRest._saveNotNeeded=
!1;for(var f=0;b[f];)delete b[f++].__checked}dojox.rpc.JsonRest.deleteObject(a);c.onDelete(a)},changing:function(a,b){dojox.rpc.JsonRest.changing(a,b)},setValue:function(a,b,c){var i=a[b],d=a.__id?dojox.data._getStoreForItem(a):this;dojox.json.schema&&d.schema&&d.schema.properties&&dojox.json.schema.mustBeValid(dojox.json.schema.checkPropertyChange(c,d.schema.properties[b]));if(b==d.idAttribute)throw Error("Can not change the identity attribute for an item");d.changing(a);if((a[b]=c)&&!c.__parent)c.__parent=
a;d.onSet(a,b,i,c)},setValues:function(a,b,c){if(!dojo.isArray(c))throw Error("setValues expects to be passed an Array object as its value");this.setValue(a,b,c)},unsetAttribute:function(a,b){this.changing(a);var c=a[b];delete a[b];this.onSet(a,b,c,void 0)},save:function(a){if(!a||!a.global)(a=a||{}).service=this.service;if("syncMode"in a?a.syncMode:this.syncMode)dojox.rpc._sync=!0;a=dojox.rpc.JsonRest.commit(a);this.serverVersion=this._updates&&this._updates.length;return a},revert:function(a){dojox.rpc.JsonRest.revert(a&&
a.global&&this.service)},isDirty:function(a){return dojox.rpc.JsonRest.isDirty(a)},isItem:function(a,b){return a&&a.__id&&(b||this.service==dojox.rpc.JsonRest.getServiceAndId(a.__id).service)},_doQuery:function(a){var b=dojox.rpc.JsonRest.query(this.service,typeof a.queryStr=="string"?a.queryStr:a.query,a),c=this;this.loadReferencedSchema&&b.addCallback(function(a){var d=b.ioArgs&&b.ioArgs.xhr&&b.ioArgs.xhr.getResponseHeader("Content-Type"),f=d&&d.match(/definedby\s*=\s*([^;]*)/);d&&!f&&(f=(f=b.ioArgs.xhr.getResponseHeader("Link"))&&
f.match(/<([^>]*)>;\s*rel="?definedby"?/));if(f=f&&f[1])return d=dojox.rpc.JsonRest.getServiceAndId((c.target+f).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3")),d=dojox.rpc.JsonRest.byId(d.service,d.id),d.addCallbacks(function(b){dojo.mixin(c.schema,b);return a},function(b){console.error(b);return a}),d});return b},_processResults:function(a,b){var c=a.length;return{totalCount:b.fullLength||(b.request.count==c?(b.request.start||0)+c*2:c),items:a}},getConstructor:function(){return this._constructor},
getIdentity:function(a){a=a.__clientId||a.__id;if(!a)return a;var b=this.service.servicePath.replace(/[^\/]*$/,"");return a.substring(0,b.length)!=b?a:a.substring(b.length)},fetchItemByIdentity:function(a){var b=a.identity,c=this;if(b.toString().match(/^(\w*:)?\//))b=dojox.rpc.JsonRest.getServiceAndId(b),c=b.service._store,a.identity=b.id;a._prefix=c.service.servicePath.replace(/[^\/]*$/,"");return c.inherited(arguments)},onSet:function(){},onNew:function(){},onDelete:function(){},getFeatures:function(){var a=
this.inherited(arguments);a["dojo.data.api.Write"]=!0;a["dojo.data.api.Notification"]=!0;return a},getParent:function(a){return a&&a.__parent}}),dojox.data.JsonRestStore.getStore=function(a,b){if(typeof a.target=="string"){a.target=a.target.match(/\/$/)||a.allowNoTrailingSlash?a.target:a.target+"/";var c=(dojox.rpc.JsonRest.services[a.target]||{})._store;if(c)return c}return new (b||dojox.data.JsonRestStore)(a)},dojox.data._getStoreForItem=function(a){if(a.__id){var b=dojox.rpc.JsonRest.getServiceAndId(a.__id);
return b&&b.service._store?b.service._store:(a=a.__id.toString().match(/.*\//)[0],new dojox.data.JsonRestStore({target:a}))}return null},dojox.json.ref._useRefs=!0;