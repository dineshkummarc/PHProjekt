/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.ClientFilter"]||(dojo._hasResource["dojox.data.ClientFilter"]=!0,dojo.provide("dojox.data.ClientFilter"),dojo.require("dojo.data.util.filter"),function(){var h,i=function(a,c,b){return function(d){a._updates.push({create:c&&d,remove:b&&d});h.onUpdate()}};h=dojo.declare("dojox.data.ClientFilter",null,{cacheByDefault:!1,constructor:function(){this.onSet=i(this,!0,!0);this.onNew=i(this,!0,!1);this.onDelete=i(this,!1,!0);this._updates=[];this._fetchCache=[]},clearCache:function(){this._fetchCache=
[]},updateResultSet:function(a,c){if(this.isUpdateable(c)){for(var b=c._version||0;b<this._updates.length;b++){var d=this._updates[b].create,f=this._updates[b].remove;if(f)for(var e=0;e<a.length;e++)if(this.getIdentity(a[e])==this.getIdentity(f)){a.splice(e--,1);var g=!0}d&&this.matchesQuery(d,c)&&dojo.indexOf(a,d)==-1&&(a.push(d),g=!0)}c.sort&&g&&a.sort(this.makeComparator(c.sort.concat()));a._fullLength=a.length;c.count&&g&&c.count!==Infinity&&a.splice(c.count,a.length);c._version=this._updates.length;
return g?2:1}return 0},querySuperSet:function(a,c){if(a.query==c.query)return{};if(!(c.query instanceof Object&&(!a.query||typeof a.query=="object")))return!1;var b=dojo.mixin({},c.query),d;for(d in a.query)if(b[d]==a.query[d])delete b[d];else if(!(typeof a.query[d]=="string"&&dojo.data.util.filter.patternToRegExp(a.query[d]).test(b[d])))return!1;return b},serverVersion:0,cachingFetch:function(a){for(var c=this,b=0;b<this._fetchCache.length;b++){var d=this._fetchCache[b],f=this.querySuperSet(d,a);
if(f!==!1){var e=d._loading;e||(e=new dojo.Deferred,e.callback(d.cacheResults));e.addCallback(function(b){b=c.clientSideFetch(dojo.mixin(dojo.mixin({},a),{query:f}),b);e.fullLength=b._fullLength;return b});a._version=d._version;break}}if(!e){var b=dojo.mixin({},a),d=(a.queryOptions||0).cache,g=this._fetchCache;if(d===void 0?this.cacheByDefault:d){if(a.start||a.count)delete b.start,delete b.count,a.clientQuery=dojo.mixin(a.clientQuery||{},{start:a.start,count:a.count});a=b;g.push(a)}e=a._loading=this._doQuery(a);
e.addErrback(function(){g.splice(dojo.indexOf(g,a),1)})}var j=this.serverVersion;e.addCallback(function(b){delete a._loading;if(b&&(a._version=typeof a._version=="number"?a._version:j,c.updateResultSet(b,a),a.cacheResults=b,!a.count||b.length<a.count))e.fullLength=(a.start?a.start:0)+b.length;return b});return e},isUpdateable:function(a){return typeof a.query=="object"},clientSideFetch:function(a,c){if(a.queryOptions&&a.queryOptions.results)c=a.queryOptions.results;if(a.query)for(var b=[],d=0;d<c.length;d++){var f=
c[d];f&&this.matchesQuery(f,a)&&b.push(c[d])}else b=a.sort?c.concat():c;a.sort&&b.sort(this.makeComparator(a.sort.concat()));return this.clientSidePaging(a,b)},clientSidePaging:function(a,c){var b=a.start||0,b=b||a.count?c.slice(b,b+(a.count||c.length)):c;b._fullLength=c.length;return b},matchesQuery:function(a,c){var b=c.query,d=c.queryOptions&&c.queryOptions.ignoreCase,f;for(f in b){var e=b[f],g=this.getValue(a,f);if(typeof e=="string"&&(e.match(/[\*\.]/)||d)?!dojo.data.util.filter.patternToRegExp(e,
d).test(g):g!=e)return!1}return!0},makeComparator:function(a){var c=a.shift();if(!c)return function(){return 0};var b=c.attribute,d=!!c.descending,f=this.makeComparator(a),e=this;return function(a,c){var h=e.getValue(a,b),i=e.getValue(c,b);return h!=i?h<i==d?1:-1:f(a,c)}}});h.onUpdate=function(){}}());