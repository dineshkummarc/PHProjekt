/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.StoreExplorer"]||(dojo._hasResource["dojox.data.StoreExplorer"]=!0,dojo.provide("dojox.data.StoreExplorer"),dojo.require("dojox.grid.DataGrid"),dojo.require("dojox.data.ItemExplorer"),dojo.require("dijit.layout.BorderContainer"),dojo.require("dijit.layout.ContentPane"),dojo.declare("dojox.data.StoreExplorer",dijit.layout.BorderContainer,{constructor:function(a){dojo.mixin(this,a)},store:null,columnWidth:"",stringQueries:!1,showAllColumns:!1,postCreate:function(){function a(d,
a){var b=new dijit.form.Button({label:d});h.containerNode.appendChild(b.domNode);b.onClick=a;return b}var c=this;this.inherited(arguments);var h=(new dijit.layout.ContentPane({region:"top"})).placeAt(this),f=h.containerNode.appendChild(document.createElement("span"));f.innerHTML="Enter query: &nbsp;";f.id="queryText";var j=h.containerNode.appendChild(document.createElement("input"));j.type="text";j.id="queryTextBox";a("Query",function(){var d=j.value;c.setQuery(c.stringQueries?d:dojo.fromJson(d))});
h.containerNode.appendChild(document.createElement("span")).innerHTML="&nbsp;&nbsp;&nbsp;";var k=a("Create New",dojo.hitch(this,"createNew")),l=a("Delete",function(){for(var d=b.selection.getSelected(),a=0;a<d.length;a++)c.store.deleteItem(d[a])});this.setItemName=function(a){k.attr("label","<img style='width:12px; height:12px' src='"+dojo.moduleUrl("dijit.themes.tundra.images","dndCopy.png")+"' /> Create New "+a);l.attr("label","Delete "+a)};a("Save",function(){c.store.save({onError:function(a){alert(a)}});
c.tree.refreshItem()});a("Revert",function(){c.store.revert()});a("Add Column",function(){var a=prompt("Enter column name:","property");a&&(c.gridLayout.push({field:a,name:a,formatter:dojo.hitch(c,"_formatCell"),editable:!0}),c.grid.attr("structure",c.gridLayout))});var f=(new dijit.layout.ContentPane({region:"center"})).placeAt(this),b=this.grid=new dojox.grid.DataGrid({store:this.store});f.attr("content",b);b.canEdit=function(a,b){var c=this._copyAttr(b,a.field);return!(c&&typeof c=="object")||
c instanceof Date};var f=(new dijit.layout.ContentPane({region:"trailing",splitter:!0,style:"width: 300px"})).placeAt(this),e=this.tree=new dojox.data.ItemExplorer({store:this.store});f.attr("content",e);dojo.connect(b,"onCellClick",function(){var a=b.selection.getSelected()[0];e.setItem(a)});this.gridOnFetchComplete=b._onFetchComplete;this.setStore(this.store)},setQuery:function(a,c){this.grid.setQuery(a,c)},_formatCell:function(a){return this.store.isItem(a)?this.store.getLabel(a)||this.store.getIdentity(a):
a},setStore:function(a){function c(a){return h._formatCell(a)}this.store=a;var h=this,f=this.grid;f._pending_requests[0]=!1;var j=this.gridOnFetchComplete;f._onFetchComplete=function(k,l){var b=h.gridLayout=[],e,d,i,g,m;e=a.getIdentityAttributes();for(i=0;i<e.length;i++)d=e[i],b.push({field:d,name:d,_score:100,formatter:c,editable:!1});for(i=0;d=k[i++];){var o=a.getAttributes(d);for(m=0;d=o[m++];){var n=!1;for(g=0;e=b[g++];)if(e.field==d){e._score++;n=!0;break}n||b.push({field:d,name:d,_score:1,formatter:c,
styles:"white-space:nowrap; ",editable:!0})}}b=b.sort(function(a,b){return b._score-a._score});if(!h.showAllColumns)for(g=0;e=b[g];g++)if(e._score<k.length/40*g){b.splice(g,b.length-g);break}for(g=0;e=b[g++];)e.width=h.columnWidth||Math.round(100/b.length)+"%";f._onFetchComplete=j;f.attr("structure",b);j.apply(this,arguments)};f.setStore(a);this.queryOptions={cache:!0};this.tree.setStore(a)},createNew:function(){var a=prompt("Enter any properties (in JSON literal form) to put in the new item (passed to the newItem constructor):",
"{ }");if(a)try{this.store.newItem(dojo.fromJson(a))}catch(c){alert(c)}}}));