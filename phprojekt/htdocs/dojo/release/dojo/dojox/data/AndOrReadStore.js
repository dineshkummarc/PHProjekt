/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.AndOrReadStore"]||(dojo._hasResource["dojox.data.AndOrReadStore"]=!0,dojo.provide("dojox.data.AndOrReadStore"),dojo.require("dojo.data.util.filter"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.date.stamp"),dojo.declare("dojox.data.AndOrReadStore",null,{constructor:function(a){this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=!1;this.url=this._ccUrl=this._jsonFileUrl=a.url;this._jsonData=a.data;this.data=null;this._datatypeMap=
a.typeMap||{};this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(a){return dojo.date.stamp.fromISOString(a)}});this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._itemsByIdentity=null;this._storeRefPropName="_S";this._itemNumPropName="_0";this._rootItemPropName="_RI";this._reverseRefMap="_RRM";this._loadInProgress=!1;this._queuedFetches=[];if(a.urlPreventCache!==void 0)this.urlPreventCache=a.urlPreventCache?!0:!1;if(a.hierarchical!==void 0)this.hierarchical=
a.hierarchical?!0:!1;if(a.clearOnClose)this.clearOnClose=!0},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,hierarchical:!0,_assertIsItem:function(a){if(!this.isItem(a))throw Error("dojox.data.AndOrReadStore: Invalid item argument.");},_assertIsAttribute:function(a){if(typeof a!=="string")throw Error("dojox.data.AndOrReadStore: Invalid attribute argument.");},getValue:function(a,b,e){a=this.getValues(a,b);return a.length>0?a[0]:e},getValues:function(a,b){this._assertIsItem(a);
this._assertIsAttribute(b);var e=a[b]||[];return e.slice(0,e.length)},getAttributes:function(a){this._assertIsItem(a);var b=[],e;for(e in a)e!==this._storeRefPropName&&e!==this._itemNumPropName&&e!==this._rootItemPropName&&e!==this._reverseRefMap&&b.push(e);return b},hasAttribute:function(a,b){this._assertIsItem(a);this._assertIsAttribute(b);return b in a},containsValue:function(a,b,e){var j=void 0;typeof e==="string"&&(j=dojo.data.util.filter.patternToRegExp(e,!1));return this._containsValue(a,b,
e,j)},_containsValue:function(a,b,e,j){return dojo.some(this.getValues(a,b),function(a){if(a!==null&&!dojo.isObject(a)&&j){if(a.toString().match(j))return!0}else if(e===a)return!0})},isItem:function(a){return a&&a[this._storeRefPropName]===this&&this._arrayOfAllItems[a[this._itemNumPropName]]===a?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(a){this._assertIsItem(a.item)},getFeatures:function(){return this._features},getLabel:function(a){if(this._labelAttr&&this.isItem(a))return this.getValue(a,
this._labelAttr)},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},_fetchItems:function(a,b,e){var j=this,g=function(a,e){var g=[];if(a.query){var i=dojo.fromJson(dojo.toJson(a.query));if(typeof i=="object"){var c=0,d;for(d in i)c++;if(c>1&&i.complexQuery){var c=i.complexQuery,h=!1;for(d in i)if(d!=="complexQuery"){h||(c="( "+c+" )",h=!0);var o=a.query[d];dojo.isString(o)&&(o="'"+o+"'");c+=" AND "+d+":"+o;delete i[d]}i.complexQuery=c}}d=a.queryOptions?a.queryOptions.ignoreCase:
!1;typeof i!="string"&&(i=dojo.toJson(i),i=i.replace(/\\\\/g,"\\"));var i=i.replace(/\\"/g,'"'),c=dojo.trim(i.replace(/{|}/g,"")),f;if(c.match(/"? *complexQuery *"?:/)){for(var c=dojo.trim(c.replace(/"?\s*complexQuery\s*"?:/,"")),h=["'",'"'],l,s=!1,i=0;i<h.length;i++)if(o=c.indexOf(h[i]),f=c.indexOf(h[i],1),l=c.indexOf(":",1),o===0&&f!=-1&&l<f){s=!0;break}s&&(c=c.replace(/^\"|^\'|\"$|\'$/g,""))}var h=c,o=/^,|^NOT |^AND |^OR |^\(|^\)|^!|^&&|^\|\|/i,t="";f="";var m=-1;l=!1;var u="",n="";f="";for(i=
0;i<e.length;++i){c=!0;s=e[i];if(s===null)c=!1;else{c=h;for(t="";c.length>0&&!l;){for(f=c.match(o);f&&!l;)c=dojo.trim(c.replace(f[0],"")),f=dojo.trim(f[0]).toUpperCase(),f=f=="NOT"?"!":f=="AND"||f==","?"&&":f=="OR"?"||":f,f=" "+f+" ",t+=f,f=c.match(o);if(c.length>0)if(m=c.indexOf(":"),m==-1){l=!0;break}else{u=dojo.trim(c.substring(0,m).replace(/\"|\'/g,""));c=dojo.trim(c.substring(m+1));if(f=c.match(/^\'|^\"/)){f=f[0];m=c.indexOf(f);f=c.indexOf(f,m+1);if(f==-1){l=!0;break}n=c.substring(m+1,f);c=f==
c.length-1?"":dojo.trim(c.substring(f+1))}else if(f=c.match(/\s|\)|,/)){for(var n=Array(f.length),q=0;q<f.length;q++)n[q]=c.indexOf(f[q]);m=n[0];if(n.length>1)for(q=1;q<n.length;q++)m=Math.min(m,n[q]);n=dojo.trim(c.substring(0,m));c=dojo.trim(c.substring(m))}else n=dojo.trim(c),c="";t+=j._containsValue(s,u,n,dojo.data.util.filter.patternToRegExp(n,d))}}c=eval(t)}c&&g.push(s)}l&&(g=[],console.log("The store's _fetchItems failed, probably due to a syntax error in query."))}else for(i=0;i<e.length;++i)d=
e[i],d!==null&&g.push(d);b(g,a)};if(this._loadFinished)g(a,this._getItemsArray(a.queryOptions));else{if(this._jsonFileUrl!==this._ccUrl)dojo.deprecated("dojox.data.AndOrReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=this._jsonFileUrl;else if(this.url!==this._ccUrl)this._ccUrl=this._jsonFileUrl=this.url;if(this.data!=null&&this._jsonData==null)this._jsonData=this.data,this.data=null;if(this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:a,
filter:g});else{this._loadInProgress=!0;var d=dojo.xhrGet({url:j._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache});d.addCallback(function(b){try{j._getItemsFromLoadedData(b),j._loadFinished=!0,j._loadInProgress=!1,g(a,j._getItemsArray(a.queryOptions)),j._handleQueuedFetches()}catch(d){j._loadFinished=!0,j._loadInProgress=!1,e(d,a)}});d.addErrback(function(b){j._loadInProgress=!1;e(b,a)});var h=null;if(a.abort)h=a.abort;a.abort=function(){d&&d.fired===-1&&d.cancel();
h&&h.call(a)}}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,g(a,this._getItemsArray(a.queryOptions))}catch(l){e(l,a)}else e(Error("dojox.data.AndOrReadStore: No JSON source data was provided as either URL or a nested Javascript object."),a)}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var a=0;a<this._queuedFetches.length;a++){var b=this._queuedFetches[a],e=b.args;(b=b.filter)?b(e,this._getItemsArray(e.queryOptions)):
this.fetchItemByIdentity(e)}this._queuedFetches=[]}},_getItemsArray:function(a){return a&&a.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(){if(this.clearOnClose&&this._loadFinished&&!this._loadInProgress)(this._jsonFileUrl==""||this._jsonFileUrl==null)&&(this.url==""||this.url==null)&&this.data==null&&console.debug("dojox.data.AndOrReadStore: WARNING!  Data reload  information has not been provided.  Please set 'url' or 'data' to the appropriate value before the next fetch"),
this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[]},_getItemsFromLoadedData:function(a){function b(a){return a!==null&&typeof a==="object"&&!dojo.isArray(a)&&!dojo.isFunction(a)&&a.constructor==Object&&typeof a._reference==="undefined"&&typeof a._type==="undefined"&&typeof a._value==="undefined"&&j.hierarchical}function e(a){j._arrayOfAllItems.push(a);for(var c in a){var d=a[c];if(d)if(dojo.isArray(d))for(var f=
0;f<d.length;++f){var g=d[f];b(g)&&e(g)}else b(d)&&e(d)}}var j=this;this._labelAttr=a.label;var g,d;this._arrayOfAllItems=[];this._arrayOfTopLevelItems=a.items;for(g=0;g<this._arrayOfTopLevelItems.length;++g)d=this._arrayOfTopLevelItems[g],e(d),d[this._rootItemPropName]=!0;var h={},l;for(g=0;g<this._arrayOfAllItems.length;++g)for(l in d=this._arrayOfAllItems[g],d){if(l!==this._rootItemPropName){var k=d[l];k!==null?dojo.isArray(k)||(d[l]=[k]):d[l]=[null]}h[l]=l}for(;h[this._storeRefPropName];)this._storeRefPropName+=
"_";for(;h[this._itemNumPropName];)this._itemNumPropName+="_";for(;h[this._reverseRefMap];)this._reverseRefMap+="_";if(h=a.identifier){this._itemsByIdentity={};this._features["dojo.data.api.Identity"]=h;for(g=0;g<this._arrayOfAllItems.length;++g)if(d=this._arrayOfAllItems[g],a=d[h],a=a[0],this._itemsByIdentity[a])if(this._jsonFileUrl)throw Error("dojox.data.AndOrReadStore:  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+h+"].  Value collided: ["+
a+"]");else{if(this._jsonData)throw Error("dojox.data.AndOrReadStore:  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+h+"].  Value collided: ["+a+"]");}else this._itemsByIdentity[a]=d}else this._features["dojo.data.api.Identity"]=Number;for(g=0;g<this._arrayOfAllItems.length;++g)d=this._arrayOfAllItems[g],d[this._storeRefPropName]=this,d[this._itemNumPropName]=g;for(g=0;g<this._arrayOfAllItems.length;++g)for(l in d=this._arrayOfAllItems[g],
d){a=d[l];for(h=0;h<a.length;++h)if(k=a[h],k!==null&&typeof k=="object"){if("_type"in k&&"_value"in k){var r=k._type,p=this._datatypeMap[r];if(p)if(dojo.isFunction(p))a[h]=new p(k._value);else if(dojo.isFunction(p.deserialize))a[h]=p.deserialize(k._value);else throw Error("dojox.data.AndOrReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");else throw Error("dojox.data.AndOrReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+
r+"'");}if(k._reference){k=k._reference;if(dojo.isObject(k))for(r=0;r<this._arrayOfAllItems.length;++r){var p=this._arrayOfAllItems[r],i=!0,c;for(c in k)p[c]!=k[c]&&(i=!1);i&&(a[h]=p)}else a[h]=this._getItemByIdentity(k);this.referenceIntegrity&&(k=a[h],this.isItem(k)&&this._addReferenceToMap(k,d,l))}else this.isItem(k)&&this.referenceIntegrity&&this._addReferenceToMap(k,d,l)}}},_addReferenceToMap:function(){},getIdentity:function(a){var b=this._features["dojo.data.api.Identity"];if(b===Number)return a[this._itemNumPropName];
else if(a=a[b])return a[0];return null},fetchItemByIdentity:function(a){if(this._loadFinished)e=this._getItemByIdentity(a.identity),a.onItem&&(j=a.scope?a.scope:dojo.global,a.onItem.call(j,e));else{var b=this;if(this._jsonFileUrl!==this._ccUrl)dojo.deprecated("dojox.data.AndOrReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=this._jsonFileUrl;else if(this.url!==this._ccUrl)this._ccUrl=this._jsonFileUrl=
this.url;if(this.data!=null&&this._jsonData==null)this._jsonData=this.data,this.data=null;if(this._jsonFileUrl)this._loadInProgress?this._queuedFetches.push({args:a}):(this._loadInProgress=!0,e=dojo.xhrGet({url:b._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache}),e.addCallback(function(e){var d=a.scope?a.scope:dojo.global;try{b._getItemsFromLoadedData(e);b._loadFinished=!0;b._loadInProgress=!1;var h=b._getItemByIdentity(a.identity);a.onItem&&a.onItem.call(d,h);b._handleQueuedFetches()}catch(j){b._loadInProgress=
!1,a.onError&&a.onError.call(d,j)}}),e.addErrback(function(e){b._loadInProgress=!1;a.onError&&a.onError.call(a.scope?a.scope:dojo.global,e)}));else if(this._jsonData){b._getItemsFromLoadedData(b._jsonData);b._jsonData=null;b._loadFinished=!0;var e=b._getItemByIdentity(a.identity);if(a.onItem){var j=a.scope?a.scope:dojo.global;a.onItem.call(j,e)}}}},_getItemByIdentity:function(a){var b=null,b=this._itemsByIdentity?this._itemsByIdentity[a]:this._arrayOfAllItems[a];b===void 0&&(b=null);return b},getIdentityAttributes:function(){var a=
this._features["dojo.data.api.Identity"];return a===Number?null:[a]},_forceLoad:function(){var a=this;if(this._jsonFileUrl!==this._ccUrl)dojo.deprecated("dojox.data.AndOrReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=this._jsonFileUrl;else if(this.url!==this._ccUrl)this._ccUrl=this._jsonFileUrl=this.url;if(this.data!=null&&this._jsonData==null)this._jsonData=this.data,this.data=null;if(this._jsonFileUrl){var b=
dojo.xhrGet({url:a._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,sync:!0});b.addCallback(function(b){try{if(a._loadInProgress!==!0&&!a._loadFinished)a._getItemsFromLoadedData(b),a._loadFinished=!0;else if(a._loadInProgress)throw Error("dojox.data.AndOrReadStore:  Unable to perform a synchronous load, an async load is in progress.");}catch(j){throw console.log(j),j;}});b.addErrback(function(a){throw a;})}else if(this._jsonData)a._getItemsFromLoadedData(a._jsonData),
a._jsonData=null,a._loadFinished=!0}}),dojo.extend(dojox.data.AndOrReadStore,dojo.data.util.simpleFetch));