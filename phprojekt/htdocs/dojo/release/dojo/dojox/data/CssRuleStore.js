/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.CssRuleStore"]||(dojo._hasResource["dojox.data.CssRuleStore"]=!0,dojo.provide("dojox.data.CssRuleStore"),dojo.require("dojo.data.util.sorter"),dojo.require("dojo.data.util.filter"),dojo.require("dojox.data.css"),dojo.declare("dojox.data.CssRuleStore",null,{_storeRef:"_S",_labelAttribute:"selector",_cache:null,_browserMap:null,_cName:"dojox.data.CssRuleStore",constructor:function(a){a&&dojo.mixin(this,a);this._cache={};this._allItems=null;this._waiting=[];this.gatherHandle=
null;var c=this;this.gatherHandle=setInterval(function(){try{c.context=dojox.data.css.determineContext(c.context);if(c.gatherHandle)clearInterval(c.gatherHandle),c.gatherHandle=null;for(;c._waiting.length;){var a=c._waiting.pop();dojox.data.css.rules.forEach(a.forFunc,null,c.context);a.finishFunc()}}catch(e){}},250)},setContext:function(a){if(a)this.close(),this.context=dojox.data.css.determineContext(a)},getFeatures:function(){return{"dojo.data.api.Read":!0}},isItem:function(a){return a&&a[this._storeRef]==
this?!0:!1},hasAttribute:function(a,c){this._assertIsItem(a);this._assertIsAttribute(c);var b=this.getAttributes(a);return dojo.indexOf(b,c)!=-1?!0:!1},getAttributes:function(a){this._assertIsItem(a);var c=["selector","classes","rule","style","cssText","styleSheet","parentStyleSheet","parentStyleSheetHref"];if(a=a.rule.style)for(var b in a)c.push("style."+b);return c},getValue:function(a,c,b){return(a=this.getValues(a,c))&&a.length>0?a[0]:b},getValues:function(a,c){this._assertIsItem(a);this._assertIsAttribute(c);
var b=null;if(c==="selector")(b=a.rule.selectorText)&&dojo.isString(b)&&(b=b.split(","));else if(c==="classes")b=a.classes;else if(c==="rule")b=a.rule.rule;else if(c==="style")b=a.rule.style;else if(c==="cssText")if(dojo.isIE){if(a.rule.style)(b=a.rule.style.cssText)&&(b="{ "+b.toLowerCase()+" }")}else(b=a.rule.cssText)&&(b=b.substring(b.indexOf("{"),b.length));else if(c==="styleSheet")b=a.rule.styleSheet;else if(c==="parentStyleSheet")b=a.rule.parentStyleSheet;else if(c==="parentStyleSheetHref"){if(a.href)b=
a.href}else c.indexOf("style.")===0?(b=c.substring(c.indexOf("."),c.length),b=a.rule.style[b]):b=[];b!==void 0&&(dojo.isArray(b)||(b=[b]));return b},getLabel:function(a){this._assertIsItem(a);return this.getValue(a,this._labelAttribute)},getLabelAttributes:function(){return[this._labelAttribute]},containsValue:function(a,c,b){var e=void 0;typeof b==="string"&&(e=dojo.data.util.filter.patternToRegExp(b,!1));return this._containsValue(a,c,b,e)},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(a){this._assertIsItem(a.item)},
fetch:function(a){a=a||{};if(!a.store)a.store=this;this._pending&&this._pending.length>0?this._pending.push({request:a,fetch:!0}):(this._pending=[{request:a,fetch:!0}],this._fetch(a));return a},_fetch:function(a){var c=a.scope||dojo.global;if(this._allItems===null){this._allItems={};try{this.gatherHandle?this._waiting.push({forFunc:dojo.hitch(this,this._handleRule),finishFunc:dojo.hitch(this,this._handleReturn)}):(dojox.data.css.rules.forEach(dojo.hitch(this,this._handleRule),null,this.context),this._handleReturn())}catch(b){a.onError&&
a.onError.call(c,b,a)}}else this._handleReturn()},_handleRule:function(a,c,b){for(var e=a.selectorText,d=e.split(" "),f=[],j=0;j<d.length;j++){var g=d[j],h=g.indexOf(".");if(g&&g.length>0&&h!==-1){var i=g.indexOf(",")||g.indexOf("["),g=g.substring(h,i!==-1&&i>h?i:g.length);f.push(g)}}d={};d.rule=a;d.styleSheet=c;d.href=b;d.classes=f;d[this._storeRef]=this;this._allItems[e]||(this._allItems[e]=[]);this._allItems[e].push(d)},_handleReturn:function(){var a=[],c=[],b=null,e;for(e in this._allItems){var b=
this._allItems[e],d;for(d in b)c.push(b[d])}for(;this._pending.length;)b=this._pending.pop(),b.request._items=c,a.push(b);for(;a.length;)b=a.pop(),this._handleFetchReturn(b.request)},_handleFetchReturn:function(a){var c=a.scope||dojo.global,b=[],e="all",d;a.query&&(e=dojo.toJson(a.query));if(this._cache[e])b=this._cache[e];else if(a.query){for(d in a._items){var f=a._items[d],j=dojo.isWebKit?!0:a.queryOptions?a.queryOptions.ignoreCase:!1,g={},h,i;for(h in a.query)i=a.query[h],typeof i==="string"&&
(g[h]=dojo.data.util.filter.patternToRegExp(i,j));j=!0;for(h in a.query)i=a.query[h],this._containsValue(f,h,i,g[h])||(j=!1);j&&b.push(f)}this._cache[e]=b}else for(d in a._items)b.push(a._items[d]);e=b.length;a.sort&&b.sort(dojo.data.util.sorter.createSortFunction(a.sort,this));d=0;f=b.length;if(a.start>0&&a.start<b.length)d=a.start;if(a.count&&a.count)f=a.count;f=d+f;if(f>b.length)f=b.length;b=b.slice(d,f);a.onBegin&&a.onBegin.call(c,e,a);if(a.onItem){if(dojo.isArray(b)){for(d=0;d<b.length;d++)a.onItem.call(c,
b[d],a);a.onComplete&&a.onComplete.call(c,null,a)}}else a.onComplete&&a.onComplete.call(c,b,a);return a},close:function(){this._cache={};this._allItems=null},_assertIsItem:function(a){if(!this.isItem(a))throw Error(this._cName+": Invalid item argument.");},_assertIsAttribute:function(a){if(typeof a!=="string")throw Error(this._cName+": Invalid attribute argument.");},_containsValue:function(a,c,b,e){return dojo.some(this.getValues(a,c),function(a){if(a!==null&&!dojo.isObject(a)&&e){if(a.toString().match(e))return!0}else if(b===
a)return!0;return!1})}}));