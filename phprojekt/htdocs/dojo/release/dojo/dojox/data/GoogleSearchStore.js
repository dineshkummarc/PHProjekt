/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.GoogleSearchStore"]||(dojo._hasResource["dojox.data.GoogleSearchStore"]=!0,dojo.provide("dojox.data.GoogleSearchStore"),dojo.require("dojo.io.script"),dojo.provide("dojox.data.GoogleWebSearchStore"),dojo.provide("dojox.data.GoogleBlogSearchStore"),dojo.provide("dojox.data.GoogleLocalSearchStore"),dojo.provide("dojox.data.GoogleVideoSearchStore"),dojo.provide("dojox.data.GoogleNewsSearchStore"),dojo.provide("dojox.data.GoogleBookSearchStore"),dojo.provide("dojox.data.GoogleImageSearchStore"),
dojo.experimental("dojox.data.GoogleSearchStore"),dojo.declare("dojox.data.GoogleSearchStore",null,{constructor:function(a){if(a){if(a.label)this.label=a.label;if(a.key)this._key=a.key;if(a.lang)this._lang=a.lang;if("urlPreventCache"in a)this.urlPreventCache=a.urlPreventCache?!0:!1}this._id=dojox.data.GoogleSearchStore.prototype._id++},_id:0,_requestCount:0,_googleUrl:"http://ajax.googleapis.com/ajax/services/search/",_storeRef:"_S",_attributes:["unescapedUrl","url","visibleUrl","cacheUrl","title",
"titleNoFormatting","content","estimatedResultCount"],_aggregatedAttributes:{estimatedResultCount:"cursor.estimatedResultCount"},label:"titleNoFormatting",_type:"web",urlPreventCache:!0,_queryAttrs:{text:"q"},_assertIsItem:function(a){if(!this.isItem(a))throw Error("dojox.data.GoogleSearchStore: a function was passed an item argument that was not an item");},_assertIsAttribute:function(a){if(typeof a!=="string")throw Error("dojox.data.GoogleSearchStore: a function was passed an attribute argument that was not an attribute name string");
},getFeatures:function(){return{"dojo.data.api.Read":!0}},getValue:function(a,b,c){return(a=this.getValues(a,b))&&a.length>0?a[0]:c},getAttributes:function(){return this._attributes},hasAttribute:function(a,b){return this.getValue(a,b)?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(){},getLabel:function(a){return this.getValue(a,this.label)},getLabelAttributes:function(){return[this.label]},containsValue:function(a,b,c){a=this.getValues(a,b);for(b=0;b<a.length;b++)if(a[b]===
c)return!0;return!1},getValues:function(a,b){this._assertIsItem(a);this._assertIsAttribute(b);var c=a[b];return dojo.isArray(c)?c:c!==void 0?[c]:[]},isItem:function(a){return a&&a[this._storeRef]===this?!0:!1},close:function(){},_format:function(a){return a},fetch:function(a){function b(b){r++;n.content.context=n.content.start=b.start;b=dojo.io.script.get(n);o.push(b.ioArgs.id);b.addErrback(function(b){a.onError&&a.onError.call(c,b,a)})}var a=a||{},c=a.scope||dojo.global;if(!a.query&&a.onError)a.onError.call(c,
Error(this.declaredClass+": A query must be specified."));else{var d={},i;for(i in this._queryAttrs)d[i]=a.query[i];var a={query:d,onComplete:a.onComplete,onError:a.onError,onItem:a.onItem,onBegin:a.onBegin,start:a.start,count:a.count},l="GoogleSearchStoreCallback_"+this._id+"_"+ ++this._requestCount,d=this._createContent(d,l,a);if(typeof a.start==="undefined"||a.start===null)a.start=0;if(!a.count)a.count=8;i={start:a.start-a.start%8};var p=this,n={url:this._googleUrl+this._type,preventCache:this.urlPreventCache,
content:d},j=[],q=0,s=!1,k=a.start-1,r=0,o=[],t=function(d,g){o.length>0&&dojo.query("#"+o.splice(0,1)).forEach(dojo.destroy);if(!s){var h=p._getItems(g),e=g?g.cursor:null;if(h){for(var f=0;f<h.length&&f+d<a.count+a.start;f++)p._processItem(h[f],g),j[f+d]=h[f];q++;if(q==1){var i=(f=e?e.pages:null)?Number(f[f.length-1].start):0;a.onBegin&&(e=e?e.estimatedResultCount:h.length,a.onBegin.call(c,e?Math.min(e,i+h.length):i+h.length,a));h=a.start-a.start%8+8;for(e=1;f;){if(!f[e]||Number(f[e].start)>=a.start+
a.count)break;Number(f[e].start)>=h&&b({start:f[e].start});e++}}if(a.onItem&&j[k+1]){do k++,a.onItem.call(c,j[k],a);while(j[k+1]&&k<a.start+a.count)}q==r&&(s=!0,dojo.global[l]=null,a.onItem?a.onComplete.call(c,null,a):(j=j.slice(a.start,a.start+a.count),a.onComplete.call(c,j,a)))}}},g=[],m=i.start-1;dojo.global[l]=function(b,d,h){try{if(h!=200)a.onError&&a.onError.call(c,Error("Response from Google was: "+h),a),dojo.global[l]=function(){};else if(b==m+1){if(t(Number(b),d),m+=8,g.length>0)for(g.sort(p._getSort());g.length>
0&&g[0].start==m+1;)t(Number(g[0].start),g[0].data),g.splice(0,1),m+=8}else g.push({start:b,data:d})}catch(e){a.onError.call(c,e,a)}};b(i)}},_getSort:function(){return function(a,b){return a.start<b.start?-1:b.start<a.start?1:0}},_processItem:function(a,b){a[this._storeRef]=this;for(var c in this._aggregatedAttributes)a[c]=dojo.getObject(this._aggregatedAttributes[c],!1,b)},_getItems:function(a){return a.results||a},_createContent:function(a,b){var c={v:"1.0",rsz:"large",callback:b,key:this._key,
hl:this._lang},d;for(d in this._queryAttrs)c[this._queryAttrs[d]]=a[d];return c}}),dojo.declare("dojox.data.GoogleWebSearchStore",dojox.data.GoogleSearchStore,{}),dojo.declare("dojox.data.GoogleBlogSearchStore",dojox.data.GoogleSearchStore,{_type:"blogs",_attributes:["blogUrl","postUrl","title","titleNoFormatting","content","author","publishedDate"],_aggregatedAttributes:{}}),dojo.declare("dojox.data.GoogleLocalSearchStore",dojox.data.GoogleSearchStore,{_type:"local",_attributes:["title","titleNoFormatting",
"url","lat","lng","streetAddress","city","region","country","phoneNumbers","ddUrl","ddUrlToHere","ddUrlFromHere","staticMapUrl","viewport"],_aggregatedAttributes:{viewport:"viewport"},_queryAttrs:{text:"q",centerLatLong:"sll",searchSpan:"sspn"}}),dojo.declare("dojox.data.GoogleVideoSearchStore",dojox.data.GoogleSearchStore,{_type:"video",_attributes:["title","titleNoFormatting","content","url","published","publisher","duration","tbWidth","tbHeight","tbUrl","playUrl"],_aggregatedAttributes:{}}),dojo.declare("dojox.data.GoogleNewsSearchStore",
dojox.data.GoogleSearchStore,{_type:"news",_attributes:["title","titleNoFormatting","content","url","unescapedUrl","publisher","clusterUrl","location","publishedDate","relatedStories"],_aggregatedAttributes:{}}),dojo.declare("dojox.data.GoogleBookSearchStore",dojox.data.GoogleSearchStore,{_type:"books",_attributes:["title","titleNoFormatting","authors","url","unescapedUrl","bookId","pageCount","publishedYear"],_aggregatedAttributes:{}}),dojo.declare("dojox.data.GoogleImageSearchStore",dojox.data.GoogleSearchStore,
{_type:"images",_attributes:["title","titleNoFormatting","visibleUrl","url","unescapedUrl","originalContextUrl","width","height","tbWidth","tbHeight","tbUrl","content","contentNoFormatting"],_aggregatedAttributes:{}}));