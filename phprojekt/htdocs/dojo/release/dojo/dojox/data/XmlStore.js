/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.XmlStore"]||(dojo._hasResource["dojox.data.XmlStore"]=!0,dojo.provide("dojox.data.XmlStore"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.data.util.filter"),dojo.require("dojox.xml.parser"),dojo.provide("dojox.data.XmlItem"),dojo.declare("dojox.data.XmlStore",null,{constructor:function(a){if(a&&(this.url=a.url,this.rootItem=a.rootItem||a.rootitem||this.rootItem,this.keyAttribute=a.keyAttribute||a.keyattribute||this.keyAttribute,this._attributeMap=a.attributeMap||
a.attributemap,this.label=a.label||this.label,this.sendQuery=a.sendQuery||a.sendquery||this.sendQuery,"urlPreventCache"in a))this.urlPreventCache=a.urlPreventCache?!0:!1;this._newItems=[];this._deletedItems=[];this._modifiedItems=[]},url:"",rootItem:"",keyAttribute:"",label:"",sendQuery:!1,attributeMap:null,urlPreventCache:!0,getValue:function(a,b,c){var a=a.element,e,d;if(b==="tagName")return a.nodeName;else if(b==="childNodes"){for(e=0;e<a.childNodes.length;e++)if(d=a.childNodes[e],d.nodeType===
1)return this._getItem(d);return c}else if(b==="text()"){for(e=0;e<a.childNodes.length;e++)if(d=a.childNodes[e],d.nodeType===3||d.nodeType===4)return d.nodeValue;return c}else if(b=this._getAttribute(a.nodeName,b),b.charAt(0)==="@")return b=b.substring(1),(b=a.getAttribute(b))?b:c;else{for(e=0;e<a.childNodes.length;e++)if(d=a.childNodes[e],d.nodeType===1&&d.nodeName===b)return this._getItem(d);return c}},getValues:function(a,b){var c=a.element,e=[],d,f;if(b==="tagName")return[c.nodeName];else if(b===
"childNodes"){for(d=0;d<c.childNodes.length;d++)f=c.childNodes[d],f.nodeType===1&&e.push(this._getItem(f));return e}else if(b==="text()"){c=c.childNodes;for(d=0;d<c.length;d++)f=c[d],(f.nodeType===3||f.nodeType===4)&&e.push(f.nodeValue);return e}else if(b=this._getAttribute(c.nodeName,b),b.charAt(0)==="@")return e=b.substring(1),c=c.getAttribute(e),c!==void 0?[c]:[];else{for(d=0;d<c.childNodes.length;d++)f=c.childNodes[d],f.nodeType===1&&f.nodeName===b&&e.push(this._getItem(f));return e}},getAttributes:function(a){var a=
a.element,b=[],c;b.push("tagName");if(a.childNodes.length>0){var e={},d=!0,f=!1;for(c=0;c<a.childNodes.length;c++){var h=a.childNodes[c];h.nodeType===1?(d=h.nodeName,e[d]||(b.push(d),e[d]=d),d=!0):h.nodeType===3&&(f=!0)}d&&b.push("childNodes");f&&b.push("text()")}for(c=0;c<a.attributes.length;c++)b.push("@"+a.attributes[c].nodeName);if(this._attributeMap)for(var g in this._attributeMap)c=g.indexOf("."),c>0?g.substring(0,c)===a.nodeName&&b.push(g.substring(c+1)):b.push(g);return b},hasAttribute:function(a,
b){return this.getValue(a,b)!==void 0},containsValue:function(a,b,c){a=this.getValues(a,b);for(b=0;b<a.length;b++)if(typeof c==="string"){if(a[b].toString&&a[b].toString()===c)return!0}else if(a[b]===c)return!0;return!1},isItem:function(a){return a&&a.element&&a.store&&a.store===this?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(){},getFeatures:function(){var a={"dojo.data.api.Read":!0,"dojo.data.api.Write":!0};if(!this.sendQuery||this.keyAttribute!=="")a["dojo.data.api.Identity"]=
!0;return a},getLabel:function(a){if(this.label!==""&&this.isItem(a)&&(a=this.getValue(a,this.label)))return a.toString()},getLabelAttributes:function(){return this.label!==""?[this.label]:null},_fetchItems:function(a,b,c){var e=this._getFetchUrl(a);console.log("XmlStore._fetchItems(): url="+e);if(e){var d=!this.sendQuery?a:{},f=this,e=dojo.xhrGet({url:e,handleAs:"xml",preventCache:f.urlPreventCache});e.addCallback(function(c){c=f._getItems(c,d);console.log("XmlStore._fetchItems(): length="+(c?c.length:
0));c&&c.length>0?b(c,a):b([],a)});e.addErrback(function(b){c(b,a)})}else c(Error("No URL specified."))},_getFetchUrl:function(a){if(!this.sendQuery)return this.url;var b=a.query;if(!b)return this.url;if(dojo.isString(b))return this.url+b;var a="",c;for(c in b){var e=b[c];e&&(a&&(a+="&"),a+=c+"="+e)}if(!a)return this.url;c=this.url;c+=c.indexOf("?")<0?"?":"&";return c+a},_getItems:function(a,b){var c=null;if(b)c=b.query;var e=[],d=null,d=this.rootItem!==""?dojo.query(this.rootItem,a):a.documentElement.childNodes;
b.queryOptions&&b.queryOptions.deep&&(d=this._flattenNodes(d));for(var f=0;f<d.length;f++){var h=d[f];if(h.nodeType==1)if(h=this._getItem(h),c){var g=b.queryOptions?b.queryOptions.ignoreCase:!1,i,j=!1,n=!0,k={},m;for(m in c)i=c[m],typeof i==="string"&&(k[m]=dojo.data.util.filter.patternToRegExp(i,g));for(var l in c){for(var n=!1,o=this.getValues(h,l),g=0;g<o.length;g++){if(i=o[g]){var p=c[l];typeof i==="string"&&k[l]?j=i.match(k[l])!==null?!0:!1:typeof i==="object"&&(j=i.toString&&k[l]?i.toString().match(k[l])!==
null?!0:!1:p==="*"||p===i?!0:!1)}if(j)break}if(!j)break}(n||j)&&e.push(h)}else e.push(h)}dojo.forEach(e,function(a){a.element.parentNode&&a.element.parentNode.removeChild(a.element)},this);return e},_flattenNodes:function(a){var b=[];if(a){var c;for(c=0;c<a.length;c++){var e=a[c];b.push(e);e.childNodes&&e.childNodes.length>0&&(b=b.concat(this._flattenNodes(e.childNodes)))}}return b},close:function(){},newItem:function(a,b){console.log("XmlStore.newItem()");var a=a||{},c=a.tagName;if(!c&&(c=this.rootItem,
c===""))return null;var e=this._getDocument(),d=e.createElement(c),f;for(f in a){var h;if(f!=="tagName")if(f==="text()")h=e.createTextNode(a[f]),d.appendChild(h);else if(f=this._getAttribute(c,f),f.charAt(0)==="@")h=f.substring(1),d.setAttribute(h,a[f]);else{var g=e.createElement(f);h=e.createTextNode(a[f]);g.appendChild(h);d.appendChild(g)}}c=this._getItem(d);this._newItems.push(c);e=null;if(b&&b.parent&&b.attribute)e={item:b.parent,attribute:b.attribute,oldValue:void 0},(d=this.getValues(b.parent,
b.attribute))&&d.length>0?(f=d.slice(0,d.length),e.oldValue=d.length===1?d[0]:d.slice(0,d.length),f.push(c),this.setValues(b.parent,b.attribute,f),e.newValue=this.getValues(b.parent,b.attribute)):(this.setValues(b.parent,b.attribute,c),e.newValue=c);return c},deleteItem:function(a){console.log("XmlStore.deleteItem()");var b=a.element;if(b.parentNode)return this._backupItem(a),b.parentNode.removeChild(b),!0;this._forgetItem(a);this._deletedItems.push(a);return!0},setValue:function(a,b,c){if(b==="tagName")return!1;
this._backupItem(a);var a=a.element,e;if(b==="childNodes")e=c.element,a.appendChild(e);else if(b==="text()"){for(;a.firstChild;)a.removeChild(a.firstChild);c=this._getDocument(a).createTextNode(c);a.appendChild(c)}else if(b=this._getAttribute(a.nodeName,b),b.charAt(0)==="@")e=b.substring(1),a.setAttribute(e,c);else{for(var d=0;d<a.childNodes.length;d++){var f=a.childNodes[d];if(f.nodeType===1&&f.nodeName===b){e=f;break}}d=this._getDocument(a);if(e)for(;e.firstChild;)e.removeChild(e.firstChild);else e=
d.createElement(b),a.appendChild(e);c=d.createTextNode(c);e.appendChild(c)}return!0},setValues:function(a,b,c){if(b==="tagName")return!1;this._backupItem(a);var a=a.element,e,d,f;if(b==="childNodes"){for(;a.firstChild;)a.removeChild(a.firstChild);for(e=0;e<c.length;e++)d=c[e].element,a.appendChild(d)}else if(b==="text()"){for(;a.firstChild;)a.removeChild(a.firstChild);b="";for(e=0;e<c.length;e++)b+=c[e];f=this._getDocument(a).createTextNode(b);a.appendChild(f)}else if(b=this._getAttribute(a.nodeName,
b),b.charAt(0)==="@")b=b.substring(1),a.setAttribute(b,c[0]);else{for(e=a.childNodes.length-1;e>=0;e--)d=a.childNodes[e],d.nodeType===1&&d.nodeName===b&&a.removeChild(d);var h=this._getDocument(a);for(e=0;e<c.length;e++)d=h.createElement(b),f=h.createTextNode(c[e]),d.appendChild(f),a.appendChild(d)}return!0},unsetAttribute:function(a,b){if(b==="tagName")return!1;this._backupItem(a);var c=a.element;if(b==="childNodes"||b==="text()")for(;c.firstChild;)c.removeChild(c.firstChild);else if(b=this._getAttribute(c.nodeName,
b),b.charAt(0)==="@"){var e=b.substring(1);c.removeAttribute(e)}else for(e=c.childNodes.length-1;e>=0;e--){var d=c.childNodes[e];d.nodeType===1&&d.nodeName===b&&c.removeChild(d)}return!0},save:function(a){a||(a={});var b;for(b=0;b<this._modifiedItems.length;b++)this._saveItem(this._modifiedItems[b],a,"PUT");for(b=0;b<this._newItems.length;b++)this._newItems[b].element.parentNode?(this._newItems.splice(b,1),b--):this._saveItem(this._newItems[b],a,"POST");for(b=0;b<this._deletedItems.length;b++)this._saveItem(this._deletedItems[b],
a,"DELETE")},revert:function(){console.log("XmlStore.revert() _newItems="+this._newItems.length);console.log("XmlStore.revert() _deletedItems="+this._deletedItems.length);console.log("XmlStore.revert() _modifiedItems="+this._modifiedItems.length);this._newItems=[];this._restoreItems(this._deletedItems);this._deletedItems=[];this._restoreItems(this._modifiedItems);this._modifiedItems=[];return!0},isDirty:function(a){return a?(a=this._getRootElement(a.element),this._getItemIndex(this._newItems,a)>=
0||this._getItemIndex(this._deletedItems,a)>=0||this._getItemIndex(this._modifiedItems,a)>=0):this._newItems.length>0||this._deletedItems.length>0||this._modifiedItems.length>0},_saveItem:function(a,b,c){var e,d;if(e=c==="PUT"?this._getPutUrl(a):c==="DELETE"?this._getDeleteUrl(a):this._getPostUrl(a)){e={url:e,method:c||"POST",contentType:"text/xml",handleAs:"xml"};c==="PUT"?(e.putData=this._getPutContent(a),c=dojo.rawXhrPut(e)):c==="DELETE"?c=dojo.xhrDelete(e):(e.postData=this._getPostContent(a),
c=dojo.rawXhrPost(e));d=b.scope||dojo.global;var f=this;c.addCallback(function(){f._forgetItem(a);b.onComplete&&b.onComplete.call(d)});c.addErrback(function(a){b.onError&&b.onError.call(d,a)})}else b.onError&&(d=b.scope||dojo.global,b.onError.call(d,Error("No URL for saving content: "+this._getPostContent(a))))},_getPostUrl:function(){return this.url},_getPutUrl:function(){return this.url},_getDeleteUrl:function(a){var b=this.url;if(a&&this.keyAttribute!==""&&(a=this.getValue(a,this.keyAttribute))){var c=
this.keyAttribute.charAt(0)==="@"?this.keyAttribute.substring(1):this.keyAttribute;b+=b.indexOf("?")<0?"?":"&";b+=c+"="+a}return b},_getPostContent:function(a){return'<?xml version="1.0"?>'+dojox.xml.parser.innerXML(a.element)},_getPutContent:function(a){return'<?xml version="1.0"?>'+dojox.xml.parser.innerXML(a.element)},_getAttribute:function(a,b){if(this._attributeMap){var c=this._attributeMap[a+"."+b];c?b=c:(c=this._attributeMap[b])&&(b=c)}return b},_getItem:function(a){try{var b=null;this.keyAttribute===
""&&(b=this._getXPath(a));return new dojox.data.XmlItem(a,this,b)}catch(c){console.log(c)}return null},_getItemIndex:function(a,b){for(var c=0;c<a.length;c++)if(a[c].element===b)return c;return-1},_backupItem:function(a){var b=this._getRootElement(a.element);if(!(this._getItemIndex(this._newItems,b)>=0||this._getItemIndex(this._modifiedItems,b)>=0))b!=a.element&&(a=this._getItem(b)),a._backup=b.cloneNode(!0),this._modifiedItems.push(a)},_restoreItems:function(a){dojo.forEach(a,function(a){if(a._backup)a.element=
a._backup,a._backup=null},this)},_forgetItem:function(a){var a=a.element,b=this._getItemIndex(this._newItems,a);b>=0&&this._newItems.splice(b,1);b=this._getItemIndex(this._deletedItems,a);b>=0&&this._deletedItems.splice(b,1);b=this._getItemIndex(this._modifiedItems,a);b>=0&&this._modifiedItems.splice(b,1)},_getDocument:function(a){if(a)return a.ownerDocument;else if(!this._document)return dojox.xml.parser.parse();return null},_getRootElement:function(a){for(;a.parentNode;)a=a.parentNode;return a},
_getXPath:function(a){var b=null;if(!this.sendQuery)for(var c=a,b="";c&&c!=a.ownerDocument;){for(var e=0,d=c,f=c.nodeName;d;)(d=d.previousSibling)&&d.nodeName===f&&e++;e="/"+f+"["+e+"]";b=b?e+b:e;c=c.parentNode}return b},getIdentity:function(a){if(this.isItem(a)){var b=null;this.sendQuery&&this.keyAttribute!==""?b=this.getValue(a,this.keyAttribute).toString():this.serverQuery||(b=this.keyAttribute!==""?this.getValue(a,this.keyAttribute).toString():a.q);return b}else throw Error("dojox.data.XmlStore: Object supplied to getIdentity is not an item");
},getIdentityAttributes:function(a){if(this.isItem(a))return this.keyAttribute!==""?[this.keyAttribute]:null;else throw Error("dojox.data.XmlStore: Object supplied to getIdentity is not an item");},fetchItemByIdentity:function(a){var b=null,c=null,e=this,d=null,d=d=null;e.sendQuery?e.keyAttribute!==""?(b={query:{}},b.query[e.keyAttribute]=a.identity,d=this._getFetchUrl(b),b=function(b){var c=null;b&&(b=e._getItems(b,{}),b.length===1?c=b[0]:a.onError&&(b=a.scope||dojo.global,a.onError.call(b,Error("More than one item was returned from the server for the denoted identity"))));
a.onItem&&(b=a.scope||dojo.global,a.onItem.call(b,c))},d={url:d,handleAs:"xml",preventCache:e.urlPreventCache},d=dojo.xhrGet(d),d.addCallback(b),a.onError&&d.addErrback(function(b){a.onError.call(a.scope||dojo.global,b)})):a.onError&&a.onError.call(a.scope||dojo.global,Error("XmlStore is not told that the server to provides identity support.  No keyAttribute specified.")):(b=function(b){if(b)if(e.keyAttribute!==""){var d={query:{}};d.query[e.keyAttribute]=a.identity;d.queryOptions={deep:!0};d=e._getItems(b,
d);c=a.scope||dojo.global;d.length===1?a.onItem&&a.onItem.call(c,d[0]):d.length===0?a.onItem&&a.onItem.call(c,null):a.onError&&a.onError.call(c,Error("Items array size for identity lookup greater than 1, invalid keyAttribute."))}else{for(var d=a.identity.split("/"),g=b,b=0;b<d.length;b++)if(d[b]&&d[b]!==""){var i=d[b],i=i.substring(0,i.length-1),j=i.split("["),i=j[0],j=parseInt(j[1],10),n=0;if(g)if(g=g.childNodes){var k,m=null;for(k=0;k<g.length;k++){var l=g[k];if(l.nodeName===i)if(n<j)n++;else{m=
l;break}}g=m?m:null}else g=null;else break}d=null;g&&(d=e._getItem(g),d.element.parentNode&&d.element.parentNode.removeChild(d.element));a.onItem&&(c=a.scope||dojo.global,a.onItem.call(c,d))}},d=this._getFetchUrl(null),d={url:d,handleAs:"xml",preventCache:e.urlPreventCache},d=dojo.xhrGet(d),d.addCallback(b),a.onError&&d.addErrback(function(b){a.onError.call(a.scope||dojo.global,b)}))}}),dojo.declare("dojox.data.XmlItem",null,{constructor:function(a,b,c){this.element=a;this.store=b;this.q=c},toString:function(){var a=
"";if(this.element)for(var b=0;b<this.element.childNodes.length;b++){var c=this.element.childNodes[b];if(c.nodeType===3||c.nodeType===4)a+=c.nodeValue}return a}}),dojo.extend(dojox.data.XmlStore,dojo.data.util.simpleFetch));