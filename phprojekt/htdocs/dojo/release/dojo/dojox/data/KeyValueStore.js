/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.KeyValueStore"]||(dojo._hasResource["dojox.data.KeyValueStore"]=!0,dojo.provide("dojox.data.KeyValueStore"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.data.util.filter"),dojo.declare("dojox.data.KeyValueStore",null,{constructor:function(a){if(a.url)this.url=a.url;this._keyValueString=a.data;this._keyValueVar=a.dataVar;this._keyAttribute="key";this._valueAttribute="value";this._storeProp="_keyValueStore";this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};
this._loadInProgress=!1;this._queuedFetches=[];if(a&&"urlPreventCache"in a)this.urlPreventCache=a.urlPreventCache?!0:!1},url:"",data:"",urlPreventCache:!1,_assertIsItem:function(a){if(!this.isItem(a))throw Error("dojox.data.KeyValueStore: a function was passed an item argument that was not an item");},_assertIsAttribute:function(a,b){if(!dojo.isString(b))throw Error("dojox.data.KeyValueStore: a function was passed an attribute argument that was not an attribute object nor an attribute name string");
},getValue:function(a,b,c){this._assertIsItem(a);this._assertIsAttribute(a,b);a=b==this._keyAttribute?a[this._keyAttribute]:a[this._valueAttribute];a===void 0&&(a=c);return a},getValues:function(a,b){var c=this.getValue(a,b);return c?[c]:[]},getAttributes:function(a){return[this._keyAttribute,this._valueAttribute,a[this._keyAttribute]]},hasAttribute:function(a,b){this._assertIsItem(a);this._assertIsAttribute(a,b);return b==this._keyAttribute||b==this._valueAttribute||b==a[this._keyAttribute]},containsValue:function(a,
b,c){var d=void 0;typeof c==="string"&&(d=dojo.data.util.filter.patternToRegExp(c,!1));return this._containsValue(a,b,c,d)},_containsValue:function(a,b,c,d){a=this.getValues(a,b);for(b=0;b<a.length;++b){var e=a[b];if(typeof e==="string"&&d)return e.match(d)!==null;else if(c===e)return!0}return!1},isItem:function(a){return a&&a[this._storeProp]===this?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(){},getFeatures:function(){return this._features},close:function(){},getLabel:function(a){return a[this._keyAttribute]},
getLabelAttributes:function(){return[this._keyAttribute]},_fetchItems:function(a,b){var c=this,d=function(a,d){var e=null;if(a.query){var e=[],g=a.queryOptions?a.queryOptions.ignoreCase:!1,h={},f;for(f in a.query){var i=a.query[f];typeof i==="string"&&(h[f]=dojo.data.util.filter.patternToRegExp(i,g))}for(g=0;g<d.length;++g){var j=!0,k=d[g];for(f in a.query)i=a.query[f],c._containsValue(k,f,i,h[f])||(j=!1);j&&e.push(k)}}else if(a.identity)for(f in e=[],d){if(h=d[f],h[c._keyAttribute]==a.identity){e.push(h);
break}}else d.length>0&&(e=d.slice(0,d.length));b(e,a)};if(this._loadFinished)d(a,this._arrayOfAllItems);else if(this.url!=="")if(this._loadInProgress)this._queuedFetches.push({args:a,filter:d});else{this._loadInProgress=!0;var e=dojo.xhrGet({url:c.url,handleAs:"json-comment-filtered",preventCache:this.urlPreventCache});e.addCallback(function(b){c._processData(b);d(a,c._arrayOfAllItems);c._handleQueuedFetches()});e.addErrback(function(a){c._loadInProgress=!1;throw a;})}else if(this._keyValueString)this._processData(eval(this._keyValueString)),
this._keyValueString=null,d(a,this._arrayOfAllItems);else if(this._keyValueVar)this._processData(this._keyValueVar),this._keyValueVar=null,d(a,this._arrayOfAllItems);else throw Error("dojox.data.KeyValueStore: No source data was provided as either URL, String, or Javascript variable data input.");},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var a=0;a<this._queuedFetches.length;a++){var b=this._queuedFetches[a],c=b.filter,d=b.args;c?c(d,this._arrayOfAllItems):this.fetchItemByIdentity(b.args)}this._queuedFetches=
[]}},_processData:function(a){this._arrayOfAllItems=[];for(var b=0;b<a.length;b++)this._arrayOfAllItems.push(this._createItem(a[b]));this._loadFinished=!0;this._loadInProgress=!1},_createItem:function(a){var b={};b[this._storeProp]=this;for(var c in a){b[this._keyAttribute]=c;b[this._valueAttribute]=a[c];break}return b},getIdentity:function(a){return this.isItem(a)?a[this._keyAttribute]:null},getIdentityAttributes:function(){return[this._keyAttribute]},fetchItemByIdentity:function(a){a.oldOnItem=
a.onItem;a.onItem=null;a.onComplete=this._finishFetchItemByIdentity;this.fetch(a)},_finishFetchItemByIdentity:function(a,b){var c=b.scope||dojo.global;a.length?b.oldOnItem.call(c,a[0]):b.oldOnItem.call(c,null)}}),dojo.extend(dojox.data.KeyValueStore,dojo.data.util.simpleFetch));