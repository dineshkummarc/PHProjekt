/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.data.HtmlTableStore"]||(dojo._hasResource["dojox.data.HtmlTableStore"]=!0,dojo.provide("dojox.data.HtmlTableStore"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.data.util.filter"),dojo.require("dojox.xml.parser"),dojo.declare("dojox.data.HtmlTableStore",null,{constructor:function(a){dojo.deprecated("dojox.data.HtmlTableStore","Please use dojox.data.HtmlStore");if(a.url){if(!a.tableId)throw Error("dojo.data.HtmlTableStore: Cannot instantiate using url without an id!");
this.url=a.url;this.tableId=a.tableId}else{a.tableId?(this._rootNode=dojo.byId(a.tableId),this.tableId=this._rootNode.id):this._rootNode=dojo.byId(this.tableId);this._getHeadings();for(a=0;a<this._rootNode.rows.length;a++)this._rootNode.rows[a].store=this}},url:"",tableId:"",_getHeadings:function(){this._headings=[];dojo.forEach(this._rootNode.tHead.rows[0].cells,dojo.hitch(this,function(a){this._headings.push(dojox.xml.parser.textContent(a))}))},_getAllItems:function(){for(var a=[],d=1;d<this._rootNode.rows.length;d++)a.push(this._rootNode.rows[d]);
return a},_assertIsItem:function(a){if(!this.isItem(a))throw Error("dojo.data.HtmlTableStore: a function was passed an item argument that was not an item");},_assertIsAttribute:function(a){if(typeof a!=="string")throw Error("dojo.data.HtmlTableStore: a function was passed an attribute argument that was not an attribute name string");return dojo.indexOf(this._headings,a)},getValue:function(a,d,b){a=this.getValues(a,d);return a.length>0?a[0]:b},getValues:function(a,d){this._assertIsItem(a);var b=this._assertIsAttribute(d);
return b>-1?[dojox.xml.parser.textContent(a.cells[b])]:[]},getAttributes:function(a){this._assertIsItem(a);for(var d=[],b=0;b<this._headings.length;b++)this.hasAttribute(a,this._headings[b])&&d.push(this._headings[b]);return d},hasAttribute:function(a,d){return this.getValues(a,d).length>0},containsValue:function(a,d,b){var e=void 0;typeof b==="string"&&(e=dojo.data.util.filter.patternToRegExp(b,!1));return this._containsValue(a,d,b,e)},_containsValue:function(a,d,b,e){a=this.getValues(a,d);for(d=
0;d<a.length;++d){var c=a[d];if(typeof c==="string"&&e)return c.match(e)!==null;else if(b===c)return!0}return!1},isItem:function(a){return a&&a.store&&a.store===this?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(a){this._assertIsItem(a.item)},_fetchItems:function(a,d,b){if(this._rootNode)this._finishFetchItems(a,d,b);else if(this.url){var e=this,c=dojo.xhrGet({url:this.url,handleAs:"text"});c.addCallback(function(c){var f=function(a,b){if(a.id==b)return a;if(a.childNodes)for(var c=
0;c<a.childNodes.length;c++){var d=f(a.childNodes[c],b);if(d)return d}return null},g=document.createElement("div");g.innerHTML=c;e._rootNode=f(g,e.tableId);e._getHeadings.call(e);for(c=0;c<e._rootNode.rows.length;c++)e._rootNode.rows[c].store=e;e._finishFetchItems(a,d,b)});c.addErrback(function(c){b(c,a)})}else{this._rootNode=dojo.byId(this.tableId);this._getHeadings();for(c=0;c<this._rootNode.rows.length;c++)this._rootNode.rows[c].store=this}},_finishFetchItems:function(a,d){var b=null,e=this._getAllItems();
if(a.query){var c=a.queryOptions?a.queryOptions.ignoreCase:!1,b=[],h={},f,g;for(g in a.query)f=a.query[g]+"",typeof f==="string"&&(h[g]=dojo.data.util.filter.patternToRegExp(f,c));for(c=0;c<e.length;++c){var i=!0,j=e[c];for(g in a.query)f=a.query[g]+"",this._containsValue(j,g,f,h[g])||(i=!1);i&&b.push(j)}}else e.length>0&&(b=e.slice(0,e.length));d(b,a)},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0}},close:function(){},getLabel:function(a){if(this.isItem(a))return"Table Row #"+
this.getIdentity(a)},getLabelAttributes:function(){return null},getIdentity:function(a){this._assertIsItem(a);return dojo.isOpera?dojo.indexOf(this._rootNode.rows,a)-1:a.sectionRowIndex},getIdentityAttributes:function(){return null},fetchItemByIdentity:function(a){var d=a.identity,b=this,e=null,c=null;if(this._rootNode)this._rootNode.rows[d+1]&&(e=this._rootNode.rows[d+1],a.onItem&&(c=a.scope?a.scope:dojo.global,a.onItem.call(c,e)));else if(this.url){var h=dojo.xhrGet({url:this.url,handleAs:"text"});
h.addCallback(function(f){var g=function(a,c){if(a.id==c)return a;if(a.childNodes)for(var b=0;b<a.childNodes.length;b++){var d=g(a.childNodes[b],c);if(d)return d}return null},h=document.createElement("div");h.innerHTML=f;b._rootNode=g(h,b.tableId);b._getHeadings.call(b);for(f=0;f<b._rootNode.rows.length;f++)b._rootNode.rows[f].store=b;e=b._rootNode.rows[d+1];a.onItem&&(c=a.scope?a.scope:dojo.global,a.onItem.call(c,e))});h.addErrback(function(b){a.onError&&(c=a.scope?a.scope:dojo.global,a.onError.call(c,
b))})}else{this._rootNode=dojo.byId(this.tableId);this._getHeadings();for(h=0;h<this._rootNode.rows.length;h++)this._rootNode.rows[h].store=this;e=this._rootNode.rows[d+1];a.onItem&&(c=a.scope?a.scope:dojo.global,a.onItem.call(c,e))}}}),dojo.extend(dojox.data.HtmlTableStore,dojo.data.util.simpleFetch));