/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.json.ref"])dojo._hasResource["dojox.json.ref"]=!0,dojo.provide("dojox.json.ref"),dojo.require("dojo.date.stamp"),dojox.json.ref={resolveJson:function(f,h){function m(d,x,i,a,o,j){var c,u,b,i=n in d?d[n]:i;if(n in d||i!==void 0&&a)i=(p+i).replace(s,"$2$3");a=j||d;if(i!==void 0){if(v)d.__id=i;if(h.schemas&&!(d instanceof Array)&&(b=i.match(/^(.+\/)[^\.\[]*$/)))o=h.schemas[b[1]];if(l[i]&&d instanceof Array==l[i]instanceof Array)a=l[i],delete a.$ref,delete a._loadObject,u=
!0;else if(b=o&&o.prototype)k.prototype=b,a=new k;l[i]=a;if(r)r[i]=h.time}for(;o;){if(b=o.properties)for(c in d){var t=b[c];t&&t.format=="date-time"&&typeof d[c]=="string"&&(d[c]=dojo.date.stamp.fromISOString(d[c]))}o=o["extends"]}o=d.length;for(c in d){if(c==o)break;if(d.hasOwnProperty(c)){b=d[c];if(typeof b=="object"&&b&&!(b instanceof Date)&&c!="__parent"){g=b[q]||w&&b[n];if((!g||!b.__parent)&&d!=e)b.__parent=a;if(g)if(delete d[c],j=g.toString().replace(/(#)([^\.\[])/,"$1.$2").match(/(^([^\[]*\/)?[^#\.\[]*)#?([\.\[].*)?/),
l[(p+g).replace(s,"$2$3")]?g=l[(p+g).replace(s,"$2$3")]:(g=j[1]=="$"||j[1]=="this"||j[1]==""?f:l[(p+j[1]).replace(s,"$2$3")])&&j[3]&&j[3].replace(/(\[([^\]]+)\])|(\.?([^\.\[]+))/g,function(a,c,b,d,e){g=g&&g[b?b.replace(/[\"\'\\]/,""):e]}),g)b=g;else{if(!x){var y;y||e.push(a);y=!0;b=m(b,!1,b[q],!0,t);b._loadObject=h.loader}}else x||(b=m(b,e==d,i===void 0?void 0:z(i,c),!1,t,a!=d&&typeof a[c]=="object"&&a[c]))}d[c]=b;if(a!=d&&!a.__isDirty&&(j=a[c],a[c]=b,u&&b!==j&&!a._loadObject&&!(c.charAt(0)=="_"&&
c.charAt(1)=="_")&&c!="$ref"&&!(b instanceof Date&&j instanceof Date&&b.getTime()==j.getTime())&&!(typeof b=="function"&&typeof j=="function"&&b.toString()==j.toString())&&l.onUpdate))l.onUpdate(a,c,j,b)}}if(u&&(n in d||a instanceof Array))for(c in a){if(!a.__isDirty&&a.hasOwnProperty(c)&&!d.hasOwnProperty(c)&&!(c.charAt(0)=="_"&&c.charAt(1)=="_")&&!(a instanceof Array&&isNaN(c))){if(l.onUpdate&&c!="_loadObject"&&c!="_idAttr")l.onUpdate(a,c,a[c],void 0);for(delete a[c];a instanceof Array&&a.length&&
a[a.length-1]===void 0;)a.length--}}else if(l.onLoad)l.onLoad(a);return a}var h=h||{},n=h.idAttribute||"id",q=this.refAttribute,w=h.idAsRef,p=h.idPrefix||"",v=h.assignAbsoluteIds,l=h.index||{},r=h.timeStamps,g,e=[],s=/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,z=this._addProp,k=function(){};f&&typeof f=="object"&&(f=m(f,!1,h.defaultId,!0),m(e,!1));return f},fromJson:function(f,h){try{var m=eval("("+f+")")}catch(n){throw new SyntaxError("Invalid JSON string: "+n.message+" parsing: "+f);}return m?
this.resolveJson(m,h):m},toJson:function(f,h,m,n){function q(e,f,g){if(typeof e=="object"&&e){if(e instanceof Date)return'"'+dojo.date.stamp.toISOString(e,{zulu:!0})+'"';var k=e.__id;if(k){if(f!="#"&&(w&&!k.match(/#/)||l[k]))return g=k,k.charAt(0)!="#"&&(g=e.__clientId==k?"cid:"+k:k.substring(0,m.length)==m?k.substring(m.length):k),e={},e[v]=g,q(e,"#");f=k}else e.__id=f,r[f]=e;l[f]=e;var g=g||"",d=h?g+dojo.toJsonIndentStr:"",n=h?"\n":"",k=h?" ":"";if(e instanceof Array)return"["+dojo.map(e,function(a,
e){var b=q(a,p(f,e),d);typeof b!="string"&&(b="undefined");return n+d+b}).join(","+k)+n+g+"]";var i=[],a;for(a in e)if(e.hasOwnProperty(a)){var o;if(typeof a=="number")o='"'+a+'"';else if(typeof a=="string"&&(a.charAt(0)!="_"||a.charAt(1)!="_"))o=dojo._escapeString(a);else continue;var j=q(e[a],p(f,a),d);typeof j=="string"&&i.push(n+d+o+":"+k+j)}return"{"+i.join(","+k)+n+g+"}"}else if(typeof e=="function"&&dojox.json.ref.serializeFunctions)return e.toString();return dojo.toJson(e)}var w=this._useRefs,
p=this._addProp,v=this.refAttribute,m=m||"",l={},r={},f=q(f,"#","");if(!n)for(var g in r)delete r[g].__id;return f},_addProp:function(f,h){return f+(f.match(/#/)?f.length==1?"":".":"#")+h},refAttribute:"$ref",_useRefs:!1,serializeFunctions:!1};