/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.grid._View"]||(dojo._hasResource["dojox.grid._View"]=!0,dojo.provide("dojox.grid._View"),dojo.require("dijit._Widget"),dojo.require("dijit._Templated"),dojo.require("dojox.grid._Builder"),dojo.require("dojox.html.metrics"),dojo.require("dojox.grid.util"),dojo.require("dojo.dnd.Source"),dojo.require("dojo.dnd.Manager"),function(){dojo.declare("dojox.grid._View",[dijit._Widget,dijit._Templated],{defaultWidth:"18em",viewWidth:"",templateString:'<div class="dojoxGridView" role="presentation">\n\t<div class="dojoxGridHeader" dojoAttachPoint="headerNode" role="presentation">\n\t\t<div dojoAttachPoint="headerNodeContainer" style="width:9000em" role="presentation">\n\t\t\t<div dojoAttachPoint="headerContentNode" role="row"></div>\n\t\t</div>\n\t</div>\n\t<input type="checkbox" class="dojoxGridHiddenFocus" dojoAttachPoint="hiddenFocusNode" role="presentation" />\n\t<input type="checkbox" class="dojoxGridHiddenFocus" role="presentation" />\n\t<div class="dojoxGridScrollbox" dojoAttachPoint="scrollboxNode" role="presentation">\n\t\t<div class="dojoxGridContent" dojoAttachPoint="contentNode" hidefocus="hidefocus" role="presentation"></div>\n\t</div>\n</div>\n',
themeable:!1,classTag:"dojoxGrid",marginBottom:0,rowPad:2,_togglingColumn:-1,_headerBuilderClass:dojox.grid._HeaderBuilder,_contentBuilderClass:dojox.grid._ContentBuilder,postMixInProperties:function(){this.rowNodes={}},postCreate:function(){this.connect(this.scrollboxNode,"onscroll","doscroll");dojox.grid.util.funnelEvents(this.contentNode,this,"doContentEvent",["mouseover","mouseout","click","dblclick","contextmenu","mousedown"]);dojox.grid.util.funnelEvents(this.headerNode,this,"doHeaderEvent",
["dblclick","mouseover","mouseout","mousemove","mousedown","click","contextmenu"]);this.content=new this._contentBuilderClass(this);this.header=new this._headerBuilderClass(this);if(!dojo._isBodyLtr())this.headerNodeContainer.style.width=""},destroy:function(){dojo.destroy(this.headerNode);delete this.headerNode;for(var a in this.rowNodes)dojo.destroy(this.rowNodes[a]);this.rowNodes={};this.source&&this.source.destroy();this.inherited(arguments)},focus:function(){dojo.isIE||dojo.isWebKit||dojo.isOpera?
this.hiddenFocusNode.focus():this.scrollboxNode.focus()},setStructure:function(a){a=this.structure=a;this.viewWidth=a.width&&!isNaN(a.width)?a.width+"em":a.width||(a.noscroll?"auto":this.viewWidth);this._onBeforeRow=a.onBeforeRow||function(){};this._onAfterRow=a.onAfterRow||function(){};if(this.noscroll=a.noscroll)this.scrollboxNode.style.overflow="hidden";this.simpleStructure=Boolean(a.cells.length==1);this.testFlexCells();this.updateStructure()},_cleanupRowWidgets:function(a){a&&dojo.forEach(dojo.query("[widgetId]",
a).map(dijit.byNode),function(a){a._destroyOnRemove?(a.destroy(),delete a):a.domNode&&a.domNode.parentNode&&a.domNode.parentNode.removeChild(a.domNode)})},onBeforeRow:function(a,b){this._onBeforeRow(a,b);a>=0&&this._cleanupRowWidgets(this.getRowNode(a))},onAfterRow:function(a,b,c){this._onAfterRow(a,b,c);var e=this.grid;dojo.forEach(dojo.query(".dojoxGridStubNode",c),function(a){if(a&&a.parentNode){var b=a.getAttribute("linkWidget"),c=window.parseInt(dojo.attr(a,"cellIdx"),10);e.getCell(c);(b=dijit.byId(b))?
(a.parentNode.replaceChild(b.domNode,a),b._started||b.startup()):a.innerHTML=""}},this)},testFlexCells:function(){this.flexCells=!1;for(var a=0,b;b=this.structure.cells[a];a++)for(var c=0,e;e=b[c];c++)e.view=this,this.flexCells=this.flexCells||e.isFlex();return this.flexCells},updateStructure:function(){this.header.update();this.content.update()},getScrollbarWidth:function(){var a=this.hasVScrollbar(),b=dojo.style(this.scrollboxNode,"overflow");this.noscroll||!b||b=="hidden"?a=!1:b=="scroll"&&(a=
!0);return a?dojox.html.metrics.getScrollbar().w:0},getColumnsWidth:function(){var a=this.headerContentNode;return a&&a.firstChild?a.firstChild.offsetWidth:0},setColumnsWidth:function(a){this.headerContentNode.firstChild.style.width=a+"px";if(this.viewWidth)this.viewWidth=a+"px"},getWidth:function(){return this.viewWidth||this.getColumnsWidth()+this.getScrollbarWidth()+"px"},getContentWidth:function(){return Math.max(0,dojo._getContentBox(this.domNode).w-this.getScrollbarWidth())+"px"},render:function(){this.scrollboxNode.style.height=
"";this.renderHeader();if(this._togglingColumn>=0)this.setColumnsWidth(this.getColumnsWidth()-this._togglingColumn),this._togglingColumn=-1;var a=this.grid.layout.cells,b=dojo.hitch(this,function(b,d){!dojo._isBodyLtr()&&(d=!d);for(var c=d?-1:1,g=this.header.getCellNodeIndex(b)+c,h=a[g];h&&h.getHeaderNode()&&h.getHeaderNode().style.display=="none";)g+=c,h=a[g];return h?h.getHeaderNode():null});if(this.grid.columnReordering&&this.simpleStructure){this.source&&this.source.destroy();this.bottomMarker&&
dojo.destroy(this.bottomMarker);this.bottomMarker=dojo.byId("dojoxGrid_bottomMarker");this.topMarker&&dojo.destroy(this.topMarker);this.topMarker=dojo.byId("dojoxGrid_topMarker");if(!this.bottomMarker)this.bottomMarker=dojo.create("div",{id:"dojoxGrid_bottomMarker","class":"dojoxGridColPlaceBottom"},dojo.body()),this._hide(this.bottomMarker),this.topMarker=dojo.create("div",{id:"dojoxGrid_topMarker","class":"dojoxGridColPlaceTop"},dojo.body()),this._hide(this.topMarker);this.arrowDim=dojo.contentBox(this.bottomMarker);
var c=dojo.contentBox(this.headerContentNode.firstChild.rows[0]).h;this.source=new dojo.dnd.Source(this.headerContentNode.firstChild.rows[0],{horizontal:!0,accept:["gridColumn_"+this.grid.id],viewIndex:this.index,generateText:!1,onMouseDown:dojo.hitch(this,function(a){this.header.decorateEvent(a);if((this.header.overRightResizeArea(a)||this.header.overLeftResizeArea(a))&&this.header.canResize(a)&&!this.header.moveable)this.header.beginColumnResize(a);else{if(this.grid.headerMenu)this.grid.headerMenu.onCancel(!0);
a.button===(dojo.isIE?1:0)&&dojo.dnd.Source.prototype.onMouseDown.call(this.source,a)}}),onMouseOver:dojo.hitch(this,function(a){var b=this.source;b._getChildByEvent(a)&&dojo.dnd.Source.prototype.onMouseOver.apply(b,arguments)}),_markTargetAnchor:dojo.hitch(this,function(a){var d=this.source;if(!(d.current==d.targetAnchor&&d.before==a)){d.targetAnchor&&b(d.targetAnchor,d.before)&&d._removeItemClass(b(d.targetAnchor,d.before),d.before?"After":"Before");dojo.dnd.Source.prototype._markTargetAnchor.call(d,
a);var f=a?d.targetAnchor:b(d.targetAnchor,d.before),a=0;if(!f)f=d.targetAnchor,a=dojo.contentBox(f).w+this.arrowDim.w/2+2;f=(dojo.position||dojo._abs)(f,!0);a=Math.floor(f.x-this.arrowDim.w/2+a);dojo.style(this.bottomMarker,"visibility","visible");dojo.style(this.topMarker,"visibility","visible");dojo.style(this.bottomMarker,{left:a+"px",top:c+f.y+"px"});dojo.style(this.topMarker,{left:a+"px",top:f.y-this.arrowDim.h+"px"});d.targetAnchor&&b(d.targetAnchor,d.before)&&d._addItemClass(b(d.targetAnchor,
d.before),d.before?"After":"Before")}}),_unmarkTargetAnchor:dojo.hitch(this,function(){var a=this.source;a.targetAnchor&&(a.targetAnchor&&b(a.targetAnchor,a.before)&&a._removeItemClass(b(a.targetAnchor,a.before),a.before?"After":"Before"),this._hide(this.bottomMarker),this._hide(this.topMarker),dojo.dnd.Source.prototype._unmarkTargetAnchor.call(a))}),destroy:dojo.hitch(this,function(){dojo.disconnect(this._source_conn);dojo.unsubscribe(this._source_sub);dojo.dnd.Source.prototype.destroy.call(this.source);
this.bottomMarker&&(dojo.destroy(this.bottomMarker),delete this.bottomMarker);this.topMarker&&(dojo.destroy(this.topMarker),delete this.topMarker)}),onDndCancel:dojo.hitch(this,function(){dojo.dnd.Source.prototype.onDndCancel.call(this.source);this._hide(this.bottomMarker);this._hide(this.topMarker)})});this._source_conn=dojo.connect(this.source,"onDndDrop",this,"_onDndDrop");this._source_sub=dojo.subscribe("/dnd/drop/before",this,"_onDndDropBefore");this.source.startup()}},_hide:function(a){dojo.style(a,
{left:"-10000px",top:"-10000px",visibility:"hidden"})},_onDndDropBefore:function(a){if(dojo.dnd.manager().target===this.source){this.source._targetNode=this.source.targetAnchor;this.source._beforeTarget=this.source.before;var b=this.grid.views.views,a=b[a.viewIndex],b=b[this.index];b!=a&&(a.convertColPctToFixed(),b.convertColPctToFixed())}},_onDndDrop:function(a,b){if(dojo.dnd.manager().target!==this.source){if(dojo.dnd.manager().source===this.source)this._removingColumn=!0}else{this._hide(this.bottomMarker);
this._hide(this.topMarker);var c=dojo.marginBox(b[0]).w;if(a.viewIndex!==this.index){var e=this.grid.views.views,d=e[a.viewIndex],e=e[this.index];d.viewWidth&&d.viewWidth!="auto"&&d.setColumnsWidth(d.getColumnsWidth()-c);e.viewWidth&&e.viewWidth!="auto"&&e.setColumnsWidth(e.getColumnsWidth())}c=this.source._targetNode;d=this.source._beforeTarget;!dojo._isBodyLtr()&&(d=!d);var e=this.grid.layout,f=this.index;delete this.source._targetNode;delete this.source._beforeTarget;e.moveColumn(a.viewIndex,f,
b[0]?dojo.attr(b[0],"idx"):null,c?dojo.attr(c,"idx"):null,d)}},renderHeader:function(){this.headerContentNode.innerHTML=this.header.generateHtml(this._getHeaderContent);if(this.flexCells)this.contentWidth=this.getContentWidth(),this.headerContentNode.firstChild.style.width=this.contentWidth;dojox.grid.util.fire(this,"onAfterRow",[-1,this.structure.cells,this.headerContentNode])},_getHeaderContent:function(a){var b=a.name||a.grid.getCellName(a),c=['<div class="dojoxGridSortNode'];a.index!=a.grid.getSortIndex()?
c.push('">'):c=c.concat([" ",a.grid.sortInfo>0?"dojoxGridSortUp":"dojoxGridSortDown",'"><div class="dojoxGridArrowButtonChar">',a.grid.sortInfo>0?"&#9650;":"&#9660;",'</div><div class="dojoxGridArrowButtonNode" role="presentation"></div>','<div class="dojoxGridColCaption">']);c=c.concat([b,"</div></div>"]);return c.join("")},resize:function(){this.adaptHeight();this.adaptWidth()},hasHScrollbar:function(a){var b=this._hasHScroll||!1;if(this._hasHScroll==void 0||a)this.noscroll?this._hasHScroll=!1:
(a=dojo.style(this.scrollboxNode,"overflow"),this._hasHScroll=a=="hidden"?!1:a=="scroll"?!0:this.scrollboxNode.offsetWidth-this.getScrollbarWidth()<this.contentNode.offsetWidth);b!==this._hasHScroll&&this.grid.update();return this._hasHScroll},hasVScrollbar:function(a){var b=this._hasVScroll||!1;if(this._hasVScroll==void 0||a)this.noscroll?this._hasVScroll=!1:(a=dojo.style(this.scrollboxNode,"overflow"),this._hasVScroll=a=="hidden"?!1:a=="scroll"?!0:this.scrollboxNode.scrollHeight>this.scrollboxNode.clientHeight);
b!==this._hasVScroll&&this.grid.update();return this._hasVScroll},convertColPctToFixed:function(){var a=!1;this.grid.initialWidth="";var b=dojo.query("th",this.headerContentNode),c=dojo.map(b,function(b,d){var c=b.style.width;dojo.attr(b,"vIdx",d);if(c&&c.slice(-1)=="%")a=!0;else if(c&&c.slice(-2)=="px")return window.parseInt(c,10);return dojo.contentBox(b).w});return a?(dojo.forEach(this.grid.layout.cells,function(a,b){if(a.view==this){var f=a.view.getHeaderCellNode(a.index);if(f&&dojo.hasAttr(f,
"vIdx")){var g=window.parseInt(dojo.attr(f,"vIdx"));this.setColWidth(b,c[g]);dojo.removeAttr(f,"vIdx")}}},this),!0):!1},adaptHeight:function(a){if(!this.grid._autoHeight){var b=this.domNode.style.height&&parseInt(this.domNode.style.height.replace(/px/,""),10)||this.domNode.clientHeight,c=this;if(a||this.noscroll&&function(){var a,b;for(b in c.grid.views.views)if(a=c.grid.views.views[b],a!==c&&a.hasHScrollbar())return!0;return!1}())b-=dojox.html.metrics.getScrollbar().h;dojox.grid.util.setStyleHeightPx(this.scrollboxNode,
b)}this.hasVScrollbar(!0)},adaptWidth:function(){if(this.flexCells)this.contentWidth=this.getContentWidth(),this.headerContentNode.firstChild.style.width=this.contentWidth;var a=this.scrollboxNode.offsetWidth-this.getScrollbarWidth();this._removingColumn?(a=Math.min(a,this.getColumnsWidth())+"px",this._removingColumn=!1):a=Math.max(a,this.getColumnsWidth())+"px";this.contentNode.style.width=a;this.hasHScrollbar(!0)},setSize:function(a,b){var c=this.domNode.style,e=this.headerNode.style;if(a)c.width=
a,e.width=a;c.height=b>=0?b+"px":""},renderRow:function(a){var b=this.createRowNode(a);this.buildRow(a,b);this.grid.edit.restore(this,a);return b},createRowNode:function(a){var b=document.createElement("div");b.className=this.classTag+"Row";this instanceof dojox.grid._RowSelector?dojo.attr(b,"role","presentation"):(dojo.attr(b,"role","row"),this.grid.selectionMode!="none"&&dojo.attr(b,"aria-selected","false"));b[dojox.grid.util.gridViewTag]=this.id;b[dojox.grid.util.rowIndexTag]=a;return this.rowNodes[a]=
b},buildRow:function(a,b){this.buildRowContent(a,b);this.styleRow(a,b)},buildRowContent:function(a,b){b.innerHTML=this.content.generateHtml(a,a);if(this.flexCells&&this.contentWidth)b.firstChild.style.width=this.contentWidth;dojox.grid.util.fire(this,"onAfterRow",[a,this.structure.cells,b])},rowRemoved:function(a){a>=0&&this._cleanupRowWidgets(this.getRowNode(a));this.grid.edit.save(this,a);delete this.rowNodes[a]},getRowNode:function(a){return this.rowNodes[a]},getCellNode:function(a,b){var c=this.getRowNode(a);
if(c)return this.content.getCellNode(c,b)},getHeaderCellNode:function(a){if(this.headerContentNode)return this.header.getCellNode(this.headerContentNode,a)},styleRow:function(a,b){b._style=b.style.cssText==void 0?b.getAttribute("style"):b.style.cssText;this.styleRowNode(a,b)},styleRowNode:function(a,b){b&&this.doStyleRowNode(a,b)},doStyleRowNode:function(a,b){this.grid.styleRowNode(a,b)},updateRow:function(a){var b=this.getRowNode(a);if(b)b.style.height="",this.buildRow(a,b);return b},updateRowStyles:function(a){this.styleRowNode(a,
this.getRowNode(a))},lastTop:0,firstScroll:0,doscroll:function(){var a=dojo._isBodyLtr();if(this.firstScroll<2){if(!a&&this.firstScroll==1||a&&this.firstScroll===0){var b=dojo.marginBox(this.headerNodeContainer);if(dojo.isIE)this.headerNodeContainer.style.width=b.w+this.getScrollbarWidth()+"px";else if(dojo.isMoz)this.headerNodeContainer.style.width=b.w-this.getScrollbarWidth()+"px",this.scrollboxNode.scrollLeft=a?this.scrollboxNode.clientWidth-this.scrollboxNode.scrollWidth:this.scrollboxNode.scrollWidth-
this.scrollboxNode.clientWidth}this.firstScroll++}this.headerNode.scrollLeft=this.scrollboxNode.scrollLeft;a=this.scrollboxNode.scrollTop;a!==this.lastTop&&this.grid.scrollTo(a)},setScrollTop:function(a){this.lastTop=a;this.scrollboxNode.scrollTop=a;return this.scrollboxNode.scrollTop},doContentEvent:function(a){if(this.content.decorateEvent(a))this.grid.onContentEvent(a)},doHeaderEvent:function(a){if(this.header.decorateEvent(a))this.grid.onHeaderEvent(a)},dispatchContentEvent:function(a){return this.content.dispatchEvent(a)},
dispatchHeaderEvent:function(a){return this.header.dispatchEvent(a)},setColWidth:function(a,b){this.grid.setCellWidth(a,b+"px")},update:function(){if(this.domNode){this.content.update();this.grid.update();var a=this.scrollboxNode.scrollLeft;this.scrollboxNode.scrollLeft=a;this.headerNode.scrollLeft=a}}});dojo.declare("dojox.grid._GridAvatar",dojo.dnd.Avatar,{construct:function(){var a=dojo.doc,b=a.createElement("table");b.cellPadding=b.cellSpacing="0";b.className="dojoxGridDndAvatar";b.style.position=
"absolute";b.style.zIndex=1999;b.style.margin="0px";var c=a.createElement("tbody"),e=a.createElement("tr"),d=a.createElement("td"),f=a.createElement("td");e.className="dojoxGridDndAvatarItem";f.className="dojoxGridDndAvatarItemImage";f.style.width="16px";var g=this.manager.source;if(g.creator)g=g._normalizedCreator(g.getItem(this.manager.nodes[0].id).data,"avatar").node;else{var g=this.manager.nodes[0].cloneNode(!0),h,i;if(g.tagName.toLowerCase()=="tr")h=a.createElement("table"),i=a.createElement("tbody"),
i.appendChild(g),h.appendChild(i),g=h;else if(g.tagName.toLowerCase()=="th")h=a.createElement("table"),i=a.createElement("tbody"),a=a.createElement("tr"),h.cellPadding=h.cellSpacing="0",a.appendChild(g),i.appendChild(a),h.appendChild(i),g=h}g.id="";d.appendChild(g);e.appendChild(f);e.appendChild(d);dojo.style(e,"opacity",0.9);c.appendChild(e);b.appendChild(c);this.node=b;b=dojo.dnd.manager();this.oldOffsetY=b.OFFSET_Y;b.OFFSET_Y=1},destroy:function(){dojo.dnd.manager().OFFSET_Y=this.oldOffsetY;this.inherited(arguments)}});
var j=dojo.dnd.manager().makeAvatar;dojo.dnd.manager().makeAvatar=function(){return this.source.viewIndex!==void 0&&!dojo.hasClass(dojo.body(),"dijit_a11y")?new dojox.grid._GridAvatar(this):j.call(dojo.dnd.manager())}}());