/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.grid.enhanced.plugins.Rearrange"]||(dojo._hasResource["dojox.grid.enhanced.plugins.Rearrange"]=!0,dojo.provide("dojox.grid.enhanced.plugins.Rearrange"),dojo.require("dojox.grid.enhanced._Plugin"),dojo.require("dojox.grid.enhanced.plugins._RowMapLayer"),dojo.declare("dojox.grid.enhanced.plugins.Rearrange",dojox.grid.enhanced._Plugin,{name:"rearrange",constructor:function(a,b){this.grid=a;this.setArgs(b);var g=new dojox.grid.enhanced.plugins._RowMapLayer(a);dojox.grid.enhanced.plugins.wrap(a,
"_storeLayerFetch",g)},setArgs:function(a){this.args=dojo.mixin(this.args||{},a||{});this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||function(b){return b}},destroy:function(){this.inherited(arguments);this.grid.unwrap("rowmap")},onSetStore:function(){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(a){var b=this.grid,g=b.store,e=b.layout.cells;return g.getFeatures()["dojo.data.api.Identity"]&&dojo.some(a,function(a){return g.getIdentityAttributes(b._by_idx[a.r].item)==
e[a.c].field})?!0:!1},moveColumns:function(a,b){var g=this.grid,e=g.layout,f=e.cells,h,c,d=0,j=!0;h={};var i={};a.sort(function(a,c){return a-c});for(c=0;c<a.length;++c)h[a[c]]=c,a[c]<b&&++d;var k=0,l=0,n=Math.max(a[a.length-1],b);n==f.length&&--n;for(c=a[0];c<=n;++c){var m=h[c];m>=0?(c!=b-d+m&&(i[c]=b-d+m),k=m+1,l=a.length-m-1):c<b&&k>0?i[c]=c-k:c>=b&&l>0&&(i[c]=c+l)}d=0;b==f.length&&(--b,j=!1);g._notRefreshSelection=!0;for(c=0;c<a.length;++c){h=a[c];h<b&&(h-=d);++d;if(h!=b)e.moveColumn(f[h].view.idx,
f[b].view.idx,h,b,j),f=e.cells;b<=h&&++b}delete g._notRefreshSelection;dojo.publish("dojox/grid/rearrange/move/"+g.id,["col",i,a])},moveRows:function(a,b){var g=this.grid,e={},f=[],h=[],c=a.length,d,j,i;for(d=0;d<c;++d){h=a[d];if(h>=b)break;f.push(h)}h=a.slice(d);d=f;if(c=d.length){j={};dojo.forEach(d,function(a){j[a]=!0});e[d[0]]=b-c;f=0;d=d[f]+1;for(i=d-1;d<b;++d)j[d]?(++f,e[d]=b-c+f):(e[d]=i,++i)}d=h;if(c=d.length){j={};dojo.forEach(d,function(a){j[a]=!0});e[d[c-1]]=b+c-1;f=c-1;d=d[f]-1;for(i=
d+1;d>=b;--d)j[d]?(--f,e[d]=b+f):(e[d]=i,--i)}var k=dojo.clone(e);g.layer("rowmap").setMapping(e);g.forEachLayer(function(a){return a.name()!="rowmap"?(a.invalidate(),!0):!1},!1);g.selection.selected=[];g._noInternalMapping=!0;g._refresh();setTimeout(function(){dojo.publish("dojox/grid/rearrange/move/"+g.id,["row",k,a]);g._noInternalMapping=!1},0)},moveCells:function(a,b){var g=this.grid,e=g.store;if(e.getFeatures()["dojo.data.api.Write"]&&!(a.min.row==b.min.row&&a.min.col==b.min.col)){var f=g.layout.cells,
h,c,d,j,i=[],k=[];h=a.min.row;for(d=b.min.row;h<=a.max.row;++h,++d){c=a.min.col;for(j=b.min.col;c<=a.max.col;++c,++j){for(;f[c]&&f[c].hidden;)++c;for(;f[j]&&f[j].hidden;)++j;i.push({r:h,c:c});k.push({r:d,c:j,v:f[c].get(h,g._by_idx[h].item)})}}this._hasIdentity(i.concat(k))?console.warn("Can not write to identity!"):(dojo.forEach(i,function(a){e.setValue(g._by_idx[a.r].item,f[a.c].field,"")}),dojo.forEach(k,function(a){e.setValue(g._by_idx[a.r].item,f[a.c].field,a.v)}),e.save({onComplete:function(){dojo.publish("dojox/grid/rearrange/move/"+
g.id,["cell",{from:a,to:b}])}}))}},copyCells:function(a,b){var g=this.grid,e=g.store;if(e.getFeatures()["dojo.data.api.Write"]&&!(a.min.row==b.min.row&&a.min.col==b.min.col)){var f=g.layout.cells,h,c,d,j,i=[];h=a.min.row;for(d=b.min.row;h<=a.max.row;++h,++d){c=a.min.col;for(j=b.min.col;c<=a.max.col;++c,++j){for(;f[c]&&f[c].hidden;)++c;for(;f[j]&&f[j].hidden;)++j;i.push({r:d,c:j,v:f[c].get(h,g._by_idx[h].item)})}}this._hasIdentity(i)?console.warn("Can not write to identity!"):(dojo.forEach(i,function(a){e.setValue(g._by_idx[a.r].item,
f[a.c].field,a.v)}),e.save({onComplete:function(){setTimeout(function(){dojo.publish("dojox/grid/rearrange/copy/"+g.id,["cell",{from:a,to:b}])},0)}}))}},changeCells:function(a,b,g){var e=this.grid,f=e.store;if(f.getFeatures()["dojo.data.api.Write"]){var h=e.layout.cells,c=a.layout.cells,d,j,i,k,l=[];d=b.min.row;for(i=g.min.row;d<=b.max.row;++d,++i){j=b.min.col;for(k=g.min.col;j<=b.max.col;++j,++k){for(;c[j]&&c[j].hidden;)++j;for(;h[k]&&h[k].hidden;)++k;l.push({r:i,c:k,v:c[j].get(d,a._by_idx[d].item)})}}this._hasIdentity(l)?
console.warn("Can not write to identity!"):(dojo.forEach(l,function(a){f.setValue(e._by_idx[a.r].item,h[a.c].field,a.v)}),f.save({onComplete:function(){dojo.publish("dojox/grid/rearrange/change/"+e.id,["cell",g])}}))}},clearCells:function(a){var b=this.grid,g=b.store;if(g.getFeatures()["dojo.data.api.Write"]){var e=b.layout.cells,f,h,c=[];for(f=a.min.row;f<=a.max.row;++f)for(h=a.min.col;h<=a.max.col;++h){for(;e[h]&&e[h].hidden;)++h;c.push({r:f,c:h})}this._hasIdentity(c)?console.warn("Can not write to identity!"):
(dojo.forEach(c,function(a){g.setValue(b._by_idx[a.r].item,e[a.c].field,"")}),g.save({onComplete:function(){dojo.publish("dojox/grid/rearrange/change/"+b.id,["cell",a])}}))}},insertRows:function(a,b,g){try{var e=this.grid,f=e.store,h=e.rowCount,c={},d={idx:0},j=[],i,k=this,l=b.length;for(i=g;i<e.rowCount;++i)c[i]=i+l;if(f.getFeatures()["dojo.data.api.Write"]){if(a){var n=a.store,m;for(i=0;!m;++i)m=e._by_idx[i];var o=f.getAttributes(m.item),p=[];dojo.forEach(b,function(b,e){var i={},l=a._by_idx[b];
if(l){dojo.forEach(o,function(a){i[a]=n.getValue(l.item,a)});i=k.args.setIdentifierForNewItem(i,f,h+d.idx)||i;try{f.newItem(i),j.push(g+e),c[h+d.idx]=g+e,++d.idx}catch(m){console.log("insertRows newItem:",m,i)}}else p.push(b)})}else if(b.length&&dojo.isObject(b[0]))dojo.forEach(b,function(a,b){var e=k.args.setIdentifierForNewItem(a,f,h+d.idx)||a;try{f.newItem(e),j.push(g+b),c[h+d.idx]=g+b,++d.idx}catch(i){console.log("insertRows newItem:",i,e)}});else return;e.layer("rowmap").setMapping(c);f.save({onComplete:function(){e._refresh();
setTimeout(function(){dojo.publish("dojox/grid/rearrange/insert/"+e.id,["row",j])},0)}})}}catch(q){console.log("insertRows:",q)}},removeRows:function(a){var b=this.grid,g=b.store;try{dojo.forEach(dojo.map(a,function(a){return b._by_idx[a]}),function(a){a&&g.deleteItem(a.item)}),g.save({onComplete:function(){dojo.publish("dojox/grid/rearrange/remove/"+b.id,["row",a])}})}catch(e){console.log("removeRows:",e)}},_getPageInfo:function(){var a=this.grid.scroller,b=a.page,g=a.page,e=a.firstVisibleRow,f=
a.lastVisibleRow,h=a.rowsPerPage,c,d,j,i=[];dojo.forEach(a.pageNodes[0],function(a,l){a&&(j=!1,c=l*h,d=(l+1)*h-1,e>=c&&e<=d&&(b=l,j=!0),f>=c&&f<=d&&(g=l,j=!0),!j&&(c>f||d<e)&&i.push(l))});return{topPage:b,bottomPage:g,invalidPages:i}}}),dojox.grid.EnhancedGrid.registerPlugin(dojox.grid.enhanced.plugins.Rearrange));