/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.grid.enhanced.plugins.Printer"]||(dojo._hasResource["dojox.grid.enhanced.plugins.Printer"]=!0,dojo.provide("dojox.grid.enhanced.plugins.Printer"),dojo.require("dojox.grid.enhanced._Plugin"),dojo.require("dojox.grid.enhanced.plugins.exporter.TableWriter"),dojo.declare("dojox.grid.enhanced.plugins.Printer",dojox.grid.enhanced._Plugin,{name:"printer",constructor:function(a){this.grid=a;this._mixinGrid(a);a.setExportFormatter(function(a,d,e,b){return d.format(e,b)})},_mixinGrid:function(){var a=
this.grid;a.printGrid=dojo.hitch(this,this.printGrid);a.printSelected=dojo.hitch(this,this.printSelected);a.exportToHTML=dojo.hitch(this,this.exportToHTML);a.exportSelectedToHTML=dojo.hitch(this,this.exportSelectedToHTML);a.normalizePrintedGrid=dojo.hitch(this,this.normalizeRowHeight)},printGrid:function(a){this.exportToHTML(a,dojo.hitch(this,this._print))},printSelected:function(a){this._print(this.exportSelectedToHTML(a))},exportToHTML:function(a,c){var a=this._formalizeArgs(a),d=this;this.grid.exportGrid("table",
a,function(e){c(d._wrapHTML(a.title,a.cssFiles,a.titleInBody+e))})},exportSelectedToHTML:function(a){var a=this._formalizeArgs(a),c=this.grid.exportSelected("table",a.writerArgs);return this._wrapHTML(a.title,a.cssFiles,a.titleInBody+c)},_print:function(a){var c,d=this,e=function(){var b=c.document;b.open();b.write(a);b.close();d.normalizeRowHeight(b)};if(window.print)if(dojo.isChrome||dojo.isOpera)c=window.open("javascript: ''","","status=0,menubar=0,location=0,toolbar=0,width=1,height=1,resizable=0,scrollbars=0"),
e(c),c.print(),c.close();else{var b=this._printFrame,g=this.grid.domNode;if(!b){var f=g.id+"_print_frame";if(!(b=dojo.byId(f)))b=dojo.create("iframe"),b.id=f,b.frameBorder=0,dojo.style(b,{width:"1px",height:"1px",position:"absolute",right:0,bottoom:0,border:"none",overflow:"hidden"}),dojo.isIE||dojo.style(b,"visibility","hidden"),g.appendChild(b);this._printFrame=b}c=b.contentWindow;e(c);dijit.focus(b);c.print()}},_wrapHTML:function(a,c,d){for(var a=['<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">',
"<html><head><title>",a,'</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>'],e=0;e<c.length;++e)a.push('<link rel="stylesheet" type="text/css" href="'+c[e]+'" />');a.push("</head>");d.search(/^\s*<body/i)<0&&(d="<body>"+d+"</body>");a.push(d);return a.join("\n")},normalizeRowHeight:function(a){var a=dojo.query("table.grid_view",a.body),c=dojo.map(a,function(a){return dojo.query("thead.grid_header",a)[0]}),d=dojo.map(a,function(a){return dojo.query("tbody.grid_row",
a)}),e=d[0].length,b,g,f=0;for(b=a.length-1;b>=0;--b)g=dojo.contentBox(c[b]).h,g>f&&(f=g);for(b=a.length-1;b>=0;--b)dojo.style(c[b],"height",f+"px");for(c=0;c<e;++c){f=0;for(b=a.length-1;b>=0;--b)g=dojo.contentBox(d[b][c]).h,g>f&&(f=g);for(b=a.length-1;b>=0;--b)dojo.style(d[b][c],"height",f+"px")}for(b=d=0;b<a.length;++b)dojo.style(a[b],"left",d+"px"),d+=dojo.marginBox(a[b]).w},_formalizeArgs:function(a){a=a&&dojo.isObject(a)?a:{};a.title=String(a.title)||"";if(!dojo.isArray(a.cssFiles))a.cssFiles=
[a.cssFiles];a.titleInBody=a.title?["<h1>",a.title,"</h1>"].join(""):"";return a}}),dojox.grid.EnhancedGrid.registerPlugin(dojox.grid.enhanced.plugins.Printer,{dependency:["exporter"]}));