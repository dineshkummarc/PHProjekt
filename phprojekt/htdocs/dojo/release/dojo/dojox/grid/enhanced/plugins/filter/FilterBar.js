/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.grid.enhanced.plugins.filter.FilterBar"]||(dojo._hasResource["dojox.grid.enhanced.plugins.filter.FilterBar"]=!0,dojo.provide("dojox.grid.enhanced.plugins.filter.FilterBar"),dojo.require("dijit.form.Button"),dojo.require("dojo.string"),dojo.require("dojo.fx"),function(){var d=function(a){try{a&&a.preventDefault&&dojo.stopEvent(a)}catch(b){}};dojo.declare("dojox.grid.enhanced.plugins.filter.FilterBar",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("dojox.grid",
"enhanced/templates/FilterBar.html",'<table class="dojoxGridFBar" border="0" cellspacing="0" dojoAttachEvent="onclick:_onClickFilterBar, onmouseenter:_onMouseEnter, onmouseleave:_onMouseLeave, onmousemove:_onMouseMove"\n\t><tr><td class="dojoxGridFBarBtnTD"\n\t\t><span dojoType="dijit.form.Button" class="dojoxGridFBarBtn" dojoAttachPoint="defineFilterButton" label="..." iconClass="dojoxGridFBarDefFilterBtnIcon" showLabel="true" dojoAttachEvent="onClick:_showFilterDefDialog, onMouseEnter:_onEnterButton, onMouseLeave:_onLeaveButton, onMouseMove:_onMoveButton"></span\n\t></td><td class="dojoxGridFBarInfoTD"\n\t\t><span class="dojoxGridFBarInner"\n\t\t\t><span class="dojoxGridFBarStatus" dojoAttachPoint="statusBarNode">${_noFilterMsg}</span\n\t\t\t><span dojoType="dijit.form.Button" class="dojoxGridFBarClearFilterBtn" dojoAttachPoint="clearFilterButton" \n\t\t\t\tlabel="${_filterBarClearBtnLabel}" iconClass="dojoxGridFBarClearFilterBtnIcon" showLabel="true" \n\t\t\t\tdojoAttachEvent="onClick:_clearFilterDefDialog, onMouseEnter:_onEnterButton, onMouseLeave:_onLeaveButton, onMouseMove:_onMoveButton"></span\n\t\t\t><span dojotype="dijit.form.Button" class="dojoxGridFBarCloseBtn" dojoAttachPoint="closeFilterBarButton" \n\t\t\t\tlabel="${_closeFilterBarBtnLabel}" iconClass="dojoxGridFBarCloseBtnIcon" showLabel="false" \n\t\t\t\tdojoAttachEvent="onClick:_closeFilterBar, onMouseEnter:_onEnterButton, onMouseLeave:_onLeaveButton, onMouseMove:_onMoveButton"></span\n\t\t></span\n\t></td></tr\n></table>\n'),
widgetsInTemplate:!0,_timeout_statusTooltip:300,_handle_statusTooltip:null,_curColIdx:-1,plugin:null,postMixInProperties:function(){var a=this.plugin,b=a.nls;this._filterBarDefBtnLabel=b.filterBarDefButton;this._filterBarClearBtnLabel=b.filterBarClearButton;this._closeFilterBarBtnLabel=b.closeFilterBarBtn;this._noFilterMsg=dojo.string.substitute(b.filterBarMsgNoFilterTemplate,["",a.args.itemsName||b.defaultItemsName]);b=this.plugin.args.statusTipTimeout;if(typeof b=="number")this._timeout_statusTooltip=
b;a=a.grid;a.showFilterBar=dojo.hitch(this,"showFilterBar");a.toggleFilterBar=dojo.hitch(this,"toggleFilterBar");a.isFilterBarShown=dojo.hitch(this,"isFilterBarShown")},postCreate:function(){this.inherited(arguments);this.plugin.args.closeFilterbarButton||dojo.style(this.closeFilterBarButton.domNode,"display","none");var a=this,b=this.plugin.grid,c=this.oldGetHeaderHeight=dojo.hitch(b,b._getHeaderHeight);this.placeAt(b.viewsHeaderNode,"after");this.connect(this.plugin.filterDefDialog,"showDialog",
"_onShowFilterDefDialog");this.connect(this.plugin.filterDefDialog,"closeDialog","_onCloseFilterDefDialog");this.connect(b.layer("filter"),"onFiltered",this._onFiltered);this.defineFilterButton.domNode.title=this.plugin.nls.filterBarDefButton;dojo.hasClass(dojo.body(),"dijit_a11y")&&this.defineFilterButton.set("label",this.plugin.nls.a11yFilterBarDefButton);this.connect(this.defineFilterButton.domNode,"click",d);this.connect(this.clearFilterButton.domNode,"click",d);this.connect(this.closeFilterBarButton.domNode,
"click",d);this.toggleClearFilterBtn(!0);this._initAriaInfo();b._getHeaderHeight=function(){return c()+dojo.marginBox(a.domNode).h};b.focus.addArea({name:"filterbar",onFocus:dojo.hitch(this,this._onFocusFilterBar,!1),onBlur:dojo.hitch(this,this._onBlurFilterBar)});b.focus.placeArea("filterbar","after","header")},uninitialize:function(){var a=this.plugin.grid;a._getHeaderHeight=this.oldGetHeaderHeight;a.focus.removeArea("filterbar");this.plugin=null},isFilterBarShown:function(){return dojo.style(this.domNode,
"display")!="none"},showFilterBar:function(a,b,c){var e=this.plugin.grid;if(b){if(Boolean(a)!=this.isFilterBarShown()){var c=c||{},f=[];f.push(dojo.fx[a?"wipeIn":"wipeOut"](dojo.mixin({node:this.domNode,duration:500},c)));var d=e.views.views[0].domNode.offsetHeight,g={duration:500,properties:{height:{end:dojo.hitch(this,function(){var b=this.domNode.scrollHeight;dojo.isFF&&(b-=2);return a?d-b:d+b})}}};dojo.forEach(e.views.views,function(a){f.push(dojo.animateProperty(dojo.mixin({node:a.domNode},g,
c)),dojo.animateProperty(dojo.mixin({node:a.scrollboxNode},g,c)))});f.push(dojo.animateProperty(dojo.mixin({node:e.viewsNode},g,c)));dojo.fx.combine(f).play()}}else dojo.style(this.domNode,"display",a?"":"none"),e.update()},toggleFilterBar:function(a,b){this.showFilterBar(!this.isFilterBarShown(),a,b)},getColumnIdx:function(a){for(var b=dojo.query("[role='columnheader']",this.plugin.grid.viewsHeaderNode),c=-1,e=b.length-1;e>=0;--e){var f=dojo.coords(b[e]);if(a>=f.x&&a<f.x+f.w){c=e;break}}return c>=
0&&this.plugin.grid.layout.cells[c].filterable!==!1?c:-1},toggleClearFilterBtn:function(a){dojo.style(this.clearFilterButton.domNode,"display",a?"none":"")},_closeFilterBar:function(a){d(a);if(this.plugin.filterDefDialog.getCriteria()){var b=dojo.connect(this.plugin.filterDefDialog,"clearFilter",this,function(){this.showFilterBar(!1,!0);dojo.disconnect(b)});this._clearFilterDefDialog(a)}else this.showFilterBar(!1,!0)},_showFilterDefDialog:function(a){d(a);this.plugin.filterDefDialog.showDialog(this._curColIdx);
this.plugin.grid.focus.focusArea("filterbar")},_clearFilterDefDialog:function(a){d(a);this.plugin.filterDefDialog.onClearFilter();this.plugin.grid.focus.focusArea("filterbar")},_onEnterButton:function(a){this._onBlurFilterBar();d(a)},_onMoveButton:function(){this._onBlurFilterBar()},_onLeaveButton:function(){this._leavingBtn=!0},_onShowFilterDefDialog:function(a){if(typeof a=="number")this._curColIdx=a;this._defPaneIsShown=!0},_onCloseFilterDefDialog:function(){this._defPaneIsShown=!1;this._curColIdx=
-1;dijit.focus(this.defineFilterButton.domNode)},_onClickFilterBar:function(a){d(a);this._clearStatusTipTimeout();this.plugin.grid.focus.focusArea("filterbar");this.plugin.filterDefDialog.showDialog(this.getColumnIdx(a.clientX))},_onMouseEnter:function(a){this._onFocusFilterBar(!0,null);this._updateTipPosition(a);this._setStatusTipTimeout()},_onMouseMove:function(a){if(this._leavingBtn)this._onFocusFilterBar(!0,null),this._leavingBtn=!1;this._isFocused&&(this._setStatusTipTimeout(),this._highlightHeader(this.getColumnIdx(a.clientX)),
this._handle_statusTooltip&&this._updateTipPosition(a))},_onMouseLeave:function(){this._onBlurFilterBar()},_updateTipPosition:function(a){this._tippos={x:a.pageX,y:a.pageY}},_onFocusFilterBar:function(a,b,c){if(!this.isFilterBarShown())return!1;this._isFocused=!0;dojo.addClass(this.domNode,"dojoxGridFBarHover");if(!a){var a=dojo.style(this.clearFilterButton.domNode,"display")!=="none",e=dojo.style(this.closeFilterBarButton.domNode,"display")!=="none";if(typeof this._focusPos=="undefined")c>0?this._focusPos=
0:(this._focusPos=e?1:0,a&&++this._focusPos);this._focusPos===0?dijit.focus(this.defineFilterButton.focusNode):this._focusPos===1&&a?dijit.focus(this.clearFilterButton.focusNode):dijit.focus(this.closeFilterBarButton.focusNode)}d(b);return!0},_onBlurFilterBar:function(a,b){if(this._isFocused)this._isFocused=!1,dojo.removeClass(this.domNode,"dojoxGridFBarHover"),this._clearStatusTipTimeout(),this._clearHeaderHighlight();var c=!0;if(b){var e=3;dojo.style(this.closeFilterBarButton.domNode,"display")===
"none"&&--e;dojo.style(this.clearFilterButton.domNode,"display")==="none"&&--e;if(e==1)delete this._focusPos;else{for(var f=this._focusPos,d=f+b;d<0;d+=e);d%=e;b>0&&d<f||b<0&&d>f?delete this._focusPos:(this._focusPos=d,c=!1)}}return c},_onFiltered:function(a,b){var c=this.plugin,e=c.args.itemsName||c.nls.defaultItemsName,d="";c.grid.layer("filter").filterDef()?(d=dojo.string.substitute(c.nls.filterBarMsgHasFilterTemplate,[a,b,e]),dojo.addClass(this.domNode,"dojoxGridFBarFiltered")):(d=dojo.string.substitute(c.nls.filterBarMsgNoFilterTemplate,
[b,e]),dojo.removeClass(this.domNode,"dojoxGridFBarFiltered"));this.statusBarNode.innerHTML=d;this._focusPos=0},_initAriaInfo:function(){dijit.setWaiState(this.defineFilterButton.domNode,"label",this.plugin.nls.waiFilterBarDefButton);dijit.setWaiState(this.clearFilterButton.domNode,"label",this.plugin.nls.waiFilterBarClearButton)},_isInColumn:function(a,b){var c=dojo.coords(b);return a>=c.x&&a<c.x+c.w},_setStatusTipTimeout:function(){this._clearStatusTipTimeout();if(!this._defPaneIsShown)this._handle_statusTooltip=
setTimeout(dojo.hitch(this,this._showStatusTooltip),this._timeout_statusTooltip)},_clearStatusTipTimeout:function(){clearTimeout(this._handle_statusTooltip);this._handle_statusTooltip=null},_showStatusTooltip:function(){this._handle_statusTooltip=null;this.plugin.filterStatusTip.showDialog(this._tippos.x,this._tippos.y,this.getColumnIdx(this._tippos.x))},_highlightHeader:function(a){if(a!=this._previousHeaderIdx){var b=this.plugin.grid,c=b.getCell(this._previousHeaderIdx);c&&dojo.removeClass(c.getHeaderNode(),
"dojoxGridCellOver");(c=b.getCell(a))&&dojo.addClass(c.getHeaderNode(),"dojoxGridCellOver");this._previousHeaderIdx=a}},_clearHeaderHighlight:function(){if(typeof this._previousHeaderIdx!="undefined"){var a=this.plugin.grid,b=a.getCell(this._previousHeaderIdx);if(b)a.onHeaderCellMouseOut({cellNode:b.getHeaderNode()});delete this._previousHeaderIdx}}})}());