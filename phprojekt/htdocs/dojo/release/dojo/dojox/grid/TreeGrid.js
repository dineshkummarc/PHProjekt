/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dojox.grid.TreeGrid"])dojo._hasResource["dojox.grid.TreeGrid"]=!0,dojo.experimental("dojox.grid.TreeGrid"),dojo.provide("dojox.grid.TreeGrid"),dojo.require("dojox.grid.DataGrid"),dojo.require("dojox.grid._TreeView"),dojo.require("dojox.grid.cells.tree"),dojo.require("dojox.grid.TreeSelection"),dojo.declare("dojox.grid._TreeAggregator",null,{cells:[],grid:null,childFields:[],constructor:function(a){this.cells=a.cells||[];this.childFields=a.childFields||[];this.grid=a.grid;this.store=
this.grid.store},_cacheValue:function(a,b,c){return a[b]=c},clearSubtotalCache:function(){this.store&&delete this.store._cachedAggregates},cnt:function(a,b,c){var e=0,d=this.store,f=this.childFields;f[b]?(c=d.getValues(c,f[b]),a.index<=b+1?e=c.length:dojo.forEach(c,function(c){e+=this.getForCell(a,b+1,c,"cnt")},this)):e=1;return e},sum:function(a,b,c){var e=0,d=this.store,f=this.childFields;f[b]?dojo.forEach(d.getValues(c,f[b]),function(c){e+=this.getForCell(a,b+1,c,"sum")},this):e+=d.getValue(c,
a.field);return e},value:function(){},getForCell:function(a,b,c,e){var i;var h;var d=this.store;if(!d||!c||!d.isItem(c))return"";var f=d._cachedAggregates=d._cachedAggregates||{},g=d.getIdentity(c),f=f[g]=f[g]||[];a.getOpenState||(a=this.grid.getCell(a.layoutIndex+b+1));g=a.index;h=f[g]=f[g]||{},f=h;e=e||(a.parentCell?a.parentCell.aggregate:"sum")||"sum";a.field==d.getLabelAttributes()[0]&&(e="cnt");i=f[e]=f[e]||[],f=i;if(f[b]!=void 0)return f[b];if((g=(a.parentCell&&a.parentCell.itemAggregates?a.parentCell.itemAggregates[a.idxInParent]:
"")||"")&&d.hasAttribute(c,g))return this._cacheValue(f,b,d.getValue(c,g));else if(g)return this._cacheValue(f,b,0);return this._cacheValue(f,b,this[e](a,b,c))}}),dojo.declare("dojox.grid._TreeLayout",dojox.grid._Layout,{_isCollapsable:!1,_getInternalStructure:function(a){var b=this.grid,c={type:"dojox.grid._TreeView",cells:[[]]},e=[],d=0,f=function(a,b){var c=function(c,d){var e,f={};for(e in c)f[e]=c[e];return f=dojo.mixin(f,{level:b,idxInParent:b>0?d:-1,parentCell:b>0?a:null})},i=[];dojo.forEach(a.children,
function(a,d){"children"in a?(e.push(a.field),i[i.length-1].isCollapsable=!0,a.level=b,i=i.concat(f(a,b+1))):i.push(c(a,d))});d=Math.max(d,b);return i};c.cells[0]=f({children:a[0].cells[0],itemAggregates:[]},0);b.aggregator=new dojox.grid._TreeAggregator({cells:c.cells[0],grid:b,childFields:e});if(b.scroller&&b.defaultOpen)b.scroller.defaultRowHeight=b.scroller._origDefaultRowHeight*(2*d+1);return[c]},setStructure:function(a){var b=a,c=this.grid;c&&c.treeModel&&!dojo.every(b,function(a){return"cells"in
a})&&(b=arguments[0]=[{cells:[b]}]);if(b.length==1&&b[0].cells.length==1)if(c&&c.treeModel)b[0].type="dojox.grid._TreeView",this._isCollapsable=!0,b[0].cells[0][this.grid.treeModel?this.grid.expandoCell:0].isCollapsable=!0;else if(dojo.filter(b[0].cells[0],function(a){return"children"in a}).length===1)this._isCollapsable=!0;if(this._isCollapsable&&(!c||!c.treeModel))arguments[0]=this._getInternalStructure(b);this.inherited(arguments)},addCellDef:function(a,b,c){var e=this.inherited(arguments);return dojo.mixin(e,
dojox.grid.cells.TreeCell)}}),dojo.declare("dojox.grid.TreePath",null,{level:0,_str:"",_arr:null,grid:null,store:null,cell:null,item:null,constructor:function(a,b){dojo.isString(a)?(this._str=a,this._arr=dojo.map(a.split("/"),function(a){return parseInt(a,10)})):dojo.isArray(a)?(this._str=a.join("/"),this._arr=a.slice(0)):typeof a=="number"?(this._str=String(a),this._arr=[a]):(this._str=a._str,this._arr=a._arr.slice(0));this.level=this._arr.length-1;this.grid=b;this.store=this.grid.store;this.cell=
b.treeModel?b.layout.cells[b.expandoCell]:b.layout.cells[this.level]},item:function(){if(!this._item)this._item=this.grid.getItem(this._arr);return this._item},compare:function(a){if(dojo.isString(a)||dojo.isArray(a)){if(this._str==a)return 0;if(a.join&&this._str==a.join("/"))return 0;a=new dojox.grid.TreePath(a,this.grid)}else if(a instanceof dojox.grid.TreePath&&this._str==a._str)return 0;for(var b=0,c=this._arr.length<a._arr.length?this._arr.length:a._arr.length;b<c;b++){if(this._arr[b]<a._arr[b])return-1;
if(this._arr[b]>a._arr[b])return 1}return this._arr.length<a._arr.length?-1:this._arr.length>a._arr.length?1:0},isOpen:function(){return this.cell.openStates&&this.cell.getOpenState(this.item())},previous:function(){var a=this._arr.slice(0);if(this._str=="0")return null;var b=a.length-1;if(a[b]===0)return a.pop(),new dojox.grid.TreePath(a,this.grid);a[b]--;return(new dojox.grid.TreePath(a,this.grid)).lastChild(!0)},next:function(){var a=this._arr.slice(0);if(this.isOpen())a.push(0);else{a[a.length-
1]++;for(var b=this.level;b>=0;b--){var c=this.grid.getItem(a.slice(0,b+1));if(b>0)c||(a.pop(),a[b-1]++);else if(!c)return null}}return new dojox.grid.TreePath(a,this.grid)},children:function(a){if(!this.isOpen()&&!a)return null;var b=[];if(a=this.grid.treeModel){var c=this.item(),e=a.store;if(!a.mayHaveChildren(c))return null;dojo.forEach(a.childrenAttrs,function(a){b=b.concat(e.getValues(c,a))})}else if(b=this.store.getValues(this.item(),this.grid.layout.cells[this.cell.level+1].parentCell.field),
b.length>1&&this.grid.sortChildItems&&(a=this.grid.getSortProps())&&a.length){var d=a[0].attribute,f=this.grid;if(d&&b[0][d]){var g=!!a[0].descending,b=b.slice(0);b.sort(function(a,b){return f._childItemSorter(a,b,d,g)})}}return b},childPaths:function(){var a=this.children();return!a?[]:dojo.map(a,function(a,c){return new dojox.grid.TreePath(this._str+"/"+c,this.grid)},this)},parent:function(){return this.level===0?null:new dojox.grid.TreePath(this._arr.slice(0,this.level),this.grid)},lastChild:function(a){var b=
this.children();if(!b||!b.length)return this;b=new dojox.grid.TreePath(this._str+"/"+String(b.length-1),this.grid);return!a?b:b.lastChild(!0)},toString:function(){return this._str}}),dojo.declare("dojox.grid._TreeFocusManager",dojox.grid._FocusManager,{setFocusCell:function(a,b){a&&a.getNode(b)&&this.inherited(arguments)},isLastFocusCell:function(){if(this.cell&&this.cell.index==this.grid.layout.cellCount-1){var a=new dojox.grid.TreePath(this.grid.rowCount-1,this.grid),a=a.lastChild(!0);return this.rowIndex==
a._str}return!1},next:function(){if(this.cell){var a=this.cell.index+1,b=this.grid.layout.cellCount-1,c=new dojox.grid.TreePath(this.rowIndex,this.grid);a>b&&((b=c.next())?(a=0,c=b):a--);if(this.grid.edit.isEditing()&&(b=this.grid.getCell(a),!this.isLastFocusCell()&&!b.editable)){this._focusifyCellNode(!1);this.cell=b;this.rowIndex=c._str;this.next();return}this.setFocusIndex(c._str,a)}},previous:function(){if(this.cell){var a=(this.cell.index||0)-1,b=new dojox.grid.TreePath(this.rowIndex||0,this.grid);
if(a<0){var c=b.previous();c?(a=this.grid.layout.cellCount-1,b=c):a=0}if(this.grid.edit.isEditing()&&(c=this.grid.getCell(a),!this.isFirstFocusCell()&&!c.editable)){this._focusifyCellNode(!1);this.cell=c;this.rowIndex=b._str;this.previous();return}this.setFocusIndex(b._str,a)}},move:function(a,b){if(this.isNavHeader())this.inherited(arguments);else if(this.cell){var c=this.grid.scroller,e=this.rowIndex,d=new dojox.grid.TreePath(this.rowIndex,this.grid);if(a){var f;a>0?(d=d.next(),f=d._arr[0],f>c.getLastPageRow(c.page)&&
this.grid.setScrollTop(this.grid.scrollTop+c.findScrollTop(f)-c.findScrollTop(e))):a<0&&(d=d.previous(),f=d._arr[0],f<=c.getPageRow(c.page)&&this.grid.setScrollTop(this.grid.scrollTop-c.findScrollTop(e)-c.findScrollTop(f)))}c=this.grid.layout.cellCount-1;f=this.cell.index;for(var g=Math.min(c,Math.max(0,f+b)),h=this.grid.getCell(g),j=b<0?-1:1;g>=0&&g<c&&h&&h.hidden===!0;)g+=j,h=this.grid.getCell(g);if(!h||h.hidden===!0)g=f;a&&this.grid.updateRow(e);this.setFocusIndex(d._str,g)}}}),dojo.declare("dojox.grid.TreeGrid",
dojox.grid.DataGrid,{defaultOpen:!0,sortChildItems:!1,openAtLevels:[],treeModel:null,expandoCell:0,aggregator:null,_layoutClass:dojox.grid._TreeLayout,createSelection:function(){this.selection=new dojox.grid.TreeSelection(this)},_childItemSorter:function(a,b,c,e){a=this.store.getValue(a,c);b=this.store.getValue(b,c);return a!=b?a<b==e?1:-1:0},_onNew:function(a,b){if(!b||!b.item)this.inherited(arguments);else{var c=this.getItemIndex(b.item);typeof c=="string"?this.updateRow(c.split("/")[0]):c>-1&&
this.updateRow(c)}},_onSet:function(a){this._checkUpdateStatus();this.aggregator&&this.aggregator.clearSubtotalCache();a=this.getItemIndex(a);typeof a=="string"?this.updateRow(a.split("/")[0]):a>-1&&this.updateRow(a)},_onDelete:function(a){this._cleanupExpandoCache(this._getItemIndex(a,!0),this.store.getIdentity(a),a);this.inherited(arguments)},_cleanupExpandoCache:function(){},_addItem:function(a,b,c,e){!e&&this.model&&dojo.indexOf(this.model.root.children,a)==-1&&(this.model.root.children[b]=a);
this.inherited(arguments)},getItem:function(a){var b=dojo.isArray(a);dojo.isString(a)&&a.indexOf("/")&&(a=a.split("/"),b=!0);b&&a.length==1&&(a=a[0],b=!1);if(!b)return dojox.grid.DataGrid.prototype.getItem.call(this,a);var b=this.store,c=dojox.grid.DataGrid.prototype.getItem.call(this,a[0]),e,d,f;if(this.aggregator){e=this.aggregator.childFields||[];for(d=0;d<a.length-1&&c;d++)c=e[d]?(b.getValues(c,e[d])||[])[a[d+1]]:null}else if(this.treeModel&&(e=this.treeModel.childrenAttrs||[])&&c){d=1;for(il=
a.length;d<il&&c;d++){f=0;for(jl=e.length;f<jl;f++)if(c=e[f]?(b.getValues(c,e[f])||[])[a[d]]:null)break}}return c||null},_getItemIndex:function(a,b){if(!b&&!this.store.isItem(a))return-1;var c=this.inherited(arguments);return c==-1?this._by_idty_paths[this.store.getIdentity(a)]||-1:c},postMixInProperties:function(){if(this.treeModel&&!("defaultOpen"in this.params))this.defaultOpen=!1;var a=this.defaultOpen;this.openAtLevels=dojo.map(this.openAtLevels,function(b){if(typeof b=="string")switch(b.toLowerCase()){case "true":return!0;
case "false":return!1;default:return b=parseInt(b,10),isNaN(b)?a:b}return b});this._by_idty_paths={};this.inherited(arguments)},postCreate:function(){this.inherited(arguments);this.treeModel&&this._setModel(this.treeModel)},setModel:function(a){this._setModel(a);this._refresh(!0)},_setModel:function(a){if(a&&(!dijit.tree.ForestStoreModel||!(a instanceof dijit.tree.ForestStoreModel)))throw Error("dojox.grid.TreeGrid: treeModel must be an instance of dijit.tree.ForestStoreModel");this.treeModel=a;dojo.toggleClass(this.domNode,
"dojoxGridTreeModel",this.treeModel?!0:!1);this._setQuery(a?a.query:null);this._setStore(a?a.store:null)},createScroller:function(){this.inherited(arguments);this.scroller._origDefaultRowHeight=this.scroller.defaultRowHeight},createManagers:function(){this.rows=new dojox.grid._RowManager(this);this.focus=new dojox.grid._TreeFocusManager(this);this.edit=new dojox.grid._EditManager(this)},_setStore:function(a){this.inherited(arguments);if(this.treeModel&&!this.treeModel.root.children)this.treeModel.root.children=
[];if(this.aggregator)this.aggregator.store=a},getDefaultOpenState:function(a,b){var c,e=this.store;if(this.treeModel)return this.defaultOpen;if(!a||!e||!e.isItem(b)||!(c=this.aggregator.childFields[a.level]))return this.defaultOpen;if(this.openAtLevels.length>a.level){var d=this.openAtLevels[a.level];if(typeof d=="boolean")return d;else if(typeof d=="number")return e.getValues(b,c).length<=d}return this.defaultOpen},onStyleRow:function(a){if(this.layout._isCollapsable){var b=dojo.attr(a.node,"dojoxTreeGridBaseClasses");
if(b)a.customClasses=b;var b=a,c=b.node.tagName.toLowerCase();b.customClasses+=(b.odd?" dojoxGridRowOdd":"")+(b.selected&&c=="tr"?" dojoxGridRowSelected":"")+(b.over&&c=="tr"?" dojoxGridRowOver":"");this.focus.styleRow(b);this.edit.styleRow(b)}else this.inherited(arguments)},styleRowNode:function(a,b){b&&(b.tagName.toLowerCase()=="div"&&this.aggregator&&dojo.query("tr[dojoxTreeGridPath]",b).forEach(function(a){this.rows.styleRowNode(dojo.attr(a,"dojoxTreeGridPath"),a)},this),this.rows.styleRowNode(a,
b))},onCanSelect:function(a){var b=dojo.query("tr[dojoxTreeGridPath='"+a+"']",this.domNode);return b.length&&dojo.hasClass(b[0],"dojoxGridSummaryRow")?!1:this.inherited(arguments)},onKeyDown:function(a){if(!a.altKey&&!a.metaKey){var b=dojo.keys;switch(a.keyCode){case b.UP_ARROW:!this.edit.isEditing()&&this.focus.rowIndex!="0"&&(dojo.stopEvent(a),this.focus.move(-1,0));break;case b.DOWN_ARROW:var b=new dojox.grid.TreePath(this.focus.rowIndex,this),c=new dojox.grid.TreePath(this.rowCount-1,this),c=
c.lastChild(!0);!this.edit.isEditing()&&b.toString()!=c.toString()&&(dojo.stopEvent(a),this.focus.move(1,0));break;default:this.inherited(arguments)}}},canEdit:function(a,b){return a.getNode(b)&&this._canEdit},doApplyCellEdit:function(a,b,c){var e=this.getItem(b),d=this.store.getValue(e,c);typeof d=="number"?a=isNaN(a)?a:parseFloat(a):typeof d=="boolean"?a=a=="true"?!0:a=="false"?!1:a:d instanceof Date&&(d=new Date(a),a=isNaN(d.getTime())?a:d);this.store.setValue(e,c,a);this.onApplyCellEdit(a,b,c)}}),
dojox.grid.TreeGrid.markupFactory=function(a,b,c,e){var d=dojo,f=function(a){a=d.attr(a,"width")||"auto";a!="auto"&&a.slice(-2)!="em"&&a.slice(-1)!="%"&&(a=parseInt(a,10)+"px");return a},g=function(a){var b;return a.nodeName.toLowerCase()=="table"&&d.query("> colgroup",a).length===0&&(b=d.query("> thead > tr",a)).length==1?d.query("> th",b[0]).map(function(a){var b={type:d.trim(d.attr(a,"cellType")||""),field:d.trim(d.attr(a,"field")||"")};if(b.type)b.type=d.getObject(b.type);var c=d.query("> table",
a)[0];if(c){b.name="";b.children=g(c);b.itemAggregates=d.hasAttr(a,"itemAggregates")?d.map(d.attr(a,"itemAggregates").split(","),function(a){return d.trim(a)}):[];if(d.hasAttr(a,"aggregate"))b.aggregate=d.attr(a,"aggregate");b.type=b.type||dojox.grid.cells.SubtableCell}else{b.name=d.trim(d.attr(a,"name")||a.innerHTML);if(d.hasAttr(a,"width"))b.width=f(a);if(d.hasAttr(a,"relWidth"))b.relWidth=window.parseInt(d.attr(a,"relWidth"),10);if(d.hasAttr(a,"hidden"))b.hidden=d.attr(a,"hidden")=="true";b.field=
b.field||b.name;dojox.grid.DataGrid.cell_markupFactory(e,a,b);b.type=b.type||dojox.grid.cells.Cell}b.type&&b.type.markupFactory&&b.type.markupFactory(a,b);return b}):[]};if(!a.structure){var h=g(b);if(h.length)a.structure=[{__span:Infinity,cells:[h]}]}return dojox.grid.DataGrid.markupFactory(a,b,c,e)};