/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.gfx.VectorText"]||(dojo._hasResource["dojox.gfx.VectorText"]=!0,dojo.provide("dojox.gfx.VectorText"),dojo.require("dojox.gfx"),dojo.require("dojox.xml.DomParser"),dojo.require("dojox.html.metrics"),function(){dojo.mixin(dojox.gfx,{vectorFontFitting:{NONE:0,FLOW:1,FIT:2},defaultVectorText:{type:"vectortext",x:0,y:0,width:null,height:null,text:"",align:"start",decoration:"none",fitting:0,leading:1.5},defaultVectorFont:{type:"vectorfont",size:"10pt",family:null},_vectorFontCache:{},
_svgFontCache:{},getVectorFont:function(a){return dojox.gfx._vectorFontCache[a]?dojox.gfx._vectorFontCache[a]:new dojox.gfx.VectorFont(a)}});dojo.declare("dojox.gfx.VectorFont",null,{_entityRe:/&(quot|apos|lt|gt|amp|#x[^;]+|#\d+);/g,_decodeEntitySequence:function(a){if(a.match(this._entityRe)){for(var b={amp:"&",apos:"'",quot:'"',lt:"<",gt:">"},c,f="";(c=this._entityRe.exec(a))!==null;)f+=c[1].charAt(1)=="x"?String.fromCharCode(parseInt(c[1].slice(2),16)):isNaN(parseInt(c[1].slice(1),10))?b[c[1]]||
"":String.fromCharCode(parseInt(c[1].slice(1),10));return f}},_parse:function(a,b){var c=dojox.gfx._svgFontCache[b]||dojox.xml.DomParser.parse(a),f=c.documentElement.byName("font")[0],d=c.documentElement.byName("font-face")[0],g=parseFloat(d.getAttribute("units-per-em")||1E3,10),h={x:parseFloat(f.getAttribute("horiz-adv-x"),10),y:parseFloat(f.getAttribute("vert-adv-y")||0,10)};if(!h.y)h.y=g;var f={horiz:{x:parseFloat(f.getAttribute("horiz-origin-x")||0,10),y:parseFloat(f.getAttribute("horiz-origin-y")||
0,10)},vert:{x:parseFloat(f.getAttribute("vert-origin-x")||0,10),y:parseFloat(f.getAttribute("vert-origin-y")||0,10)}},e=d.getAttribute("font-family"),i=d.getAttribute("font-style")||"all",k=d.getAttribute("font-variant")||"normal",t=d.getAttribute("font-weight")||"all",l=d.getAttribute("font-stretch")||"normal",n=d.getAttribute("unicode-range")||"U+0-10FFFF";d.getAttribute("panose-1");d.getAttribute("cap-height");var q=parseFloat(d.getAttribute("ascent")||g-f.vert.y,10),r=parseFloat(d.getAttribute("descent")||
f.vert.y,10),m={},j=e;d.byName("font-face-name")[0]&&(j=d.byName("font-face-name")[0].getAttribute("name"));if(!dojox.gfx._vectorFontCache[j]){dojo.forEach(["alphabetic","ideographic","mathematical","hanging"],function(a){var c=d.getAttribute(a);c!==null&&(m[a]=parseFloat(c,10))});var o=parseFloat(c.documentElement.byName("missing-glyph")[0].getAttribute("horiz-adv-x")||h.x,10),s={},p={},u=c.documentElement.byName("glyph");dojo.forEach(u,function(a){var c=a.getAttribute("unicode"),b=a.getAttribute("glyph-name"),
d=parseFloat(a.getAttribute("horiz-adv-x")||h.x,10),a=a.getAttribute("d");c.match(this._entityRe)&&(c=this._decodeEntitySequence(c));d={code:c,name:b,xAdvance:d,path:a};s[c]=d;p[b]=d},this);u=c.documentElement.byName("hkern");dojo.forEach(u,function(a){var c=-parseInt(a.getAttribute("k"),10),b=a.getAttribute("u1"),d=a.getAttribute("g1"),e=a.getAttribute("u2"),a=a.getAttribute("g2"),f;b?(b=this._decodeEntitySequence(b),s[b]&&(f=s[b])):p[d]&&(f=p[d]);if(f){if(!f.kern)f.kern={};e?(e=this._decodeEntitySequence(e),
f.kern[e]={x:c}):p[a]&&(f.kern[p[a].code]={x:c})}},this);dojo.mixin(this,{family:e,name:j,style:i,variant:k,weight:t,stretch:l,range:n,viewbox:{width:g,height:g},origin:f,advance:dojo.mixin(h,{missing:{x:o,y:o}}),ascent:q,descent:r,baseline:m,glyphs:s});dojox.gfx._vectorFontCache[j]=this;dojox.gfx._vectorFontCache[b]=this;j!=e&&!dojox.gfx._vectorFontCache[e]&&(dojox.gfx._vectorFontCache[e]=this);dojox.gfx._svgFontCache[b]||(dojox.gfx._svgFontCache[b]=c)}},_clean:function(){var a=this.name,b=this.family;
dojo.forEach(["family","name","style","variant","weight","stretch","range","viewbox","origin","advance","ascent","descent","baseline","glyphs"],function(a){try{delete this[a]}catch(b){}},this);dojox.gfx._vectorFontCache[a]&&delete dojox.gfx._vectorFontCache[a];dojox.gfx._vectorFontCache[b]&&delete dojox.gfx._vectorFontCache[b];return this},constructor:function(a){this._defaultLeading=1.5;a!==void 0&&this.load(a)},load:function(a){this.onLoadBegin(a.toString());this._parse(dojox.gfx._svgFontCache[a.toString()]||
dojo._getText(a.toString()),a.toString());this.onLoad(this);return this},initialized:function(){return this.glyphs!==null},_round:function(a){return Math.round(1E3*a)/1E3},_leading:function(a){return this.viewbox.height*(a||this._defaultLeading)},_normalize:function(a){return a.replace(/\s+/g,String.fromCharCode(32))},_getWidth:function(a){var b=0,c=0,f=null;dojo.forEach(a,function(d,g){c=d.xAdvance;a[g]&&d.kern&&d.kern[a[g].code]&&(c+=d.kern[a[g].code].x);b+=c;f=d});f&&f.code==" "&&(b-=f.xAdvance);
return this._round(b)},_getLongestLine:function(a){var b=0,c=0;dojo.forEach(a,function(a,d){var g=Math.max(b,this._getWidth(a));g>b&&(b=g,c=d)},this);return{width:b,index:c,line:a[c]}},_trim:function(a){var b=function(a){a.length&&(a[a.length-1].code==" "&&a.splice(a.length-1,1),a.length&&a[0].code==" "&&a.splice(0,1))};dojo.isArray(a[0])?dojo.forEach(a,b):b(a);return a},_split:function(a,b){for(var c=this._getWidth(a),c=Math.floor(c/b),f=[],d=0,g=[],h=!1,e=0,i=a.length;e<i;e++){a[e].code==" "&&(h=
!0);d+=a[e].xAdvance;e+1<i&&a[e].kern&&a[e].kern[a[e+1].code]&&(d+=a[e].kern[a[e+1].code].x);if(d>=c){for(d=a[e];h&&d.code!=" "&&e>=0;)d=g.pop(),e--;f.push(g);g=[];d=0;h=!1}g.push(a[e])}g.length&&f.push(g);return this._trim(f)},_getSizeFactor:function(a){a+="";var b=dojox.html.metrics.getCachedFontMeasurements(),c=this.viewbox.height,f=b["1em"],f=parseFloat(a,10);return a.indexOf("em")>-1?this._round(b["1em"]*f/c):a.indexOf("ex")>-1?this._round(b["1ex"]*f/c):a.indexOf("pt")>-1?this._round(b["12pt"]/
12*f/c):a.indexOf("px")>-1?this._round(b["16px"]/16*f/c):a.indexOf("%")>-1?this._round(b["1em"]*(f/100)/c):(f=b[a]||b.medium,this._round(f/c))},_getFitFactor:function(a,b,c,f){if(c){var d=this._getLongestLine(a).width;return this._round(Math.min(b/d,c/(a.length*this.viewbox.height*f-(this.viewbox.height*f-this.viewbox.height))))}else return this._round(b/this._getWidth(a))},_getBestFit:function(a,b,c,f){for(var d=32,g=0,h=d;d>0;){var e=this._getFitFactor(this._split(a,d),b,c,f);e>g&&(g=e,h=d);d--}return{scale:g,
lines:this._split(a,h)}},_getBestFlow:function(a,b,c){for(var f=[],d=0,g=[],h=!1,e=0,i=a.length;e<i;e++){a[e].code==" "&&(h=!0);var k=a[e].xAdvance;e+1<i&&a[e].kern&&a[e].kern[a[e+1].code]&&(k+=a[e].kern[a[e+1].code].x);d+=c*k;if(d>=b){for(d=a[e];h&&d.code!=" "&&e>=0;)d=g.pop(),e--;f.push(g);g=[];d=0;h=!1}g.push(a[e])}g.length&&f.push(g);return this._trim(f)},getWidth:function(a,b){return this._getWidth(dojo.map(this._normalize(a).split(""),function(a){return this.glyphs[a]||{xAdvance:this.advance.missing.x}},
this))*(b||1)},getLineHeight:function(a){return this.viewbox.height*(a||1)},getCenterline:function(a){return(a||1)*(this.viewbox.height/2)},getBaseline:function(a){return(a||1)*(this.viewbox.height+this.descent)},draw:function(a,b,c,f,d){if(!this.initialized())throw Error("dojox.gfx.VectorFont.draw(): we have not been initialized yet.");var g=a.createGroup();if(b.x||b.y)a.applyTransform({dx:b.x||0,dy:b.y||0});var h=dojo.map(this._normalize(b.text).split(""),function(a){return this.glyphs[a]||{path:null,
xAdvance:this.advance.missing.x}},this),a=c.size,e=b.fitting,i=b.width,k=b.height,c=b.align,b=b.leading||this._defaultLeading;if(e&&(e==dojox.gfx.vectorFontFitting.FLOW&&!i||e==dojox.gfx.vectorFontFitting.FIT&&(!i||!k)))e=dojox.gfx.vectorFontFitting.NONE;switch(e){case dojox.gfx.vectorFontFitting.FIT:h=this._getBestFit(h,i,k,b);a=h.scale;h=h.lines;break;case dojox.gfx.vectorFontFitting.FLOW:a=this._getSizeFactor(a);h=this._getBestFlow(h,i,a);break;default:a=this._getSizeFactor(a),h=[h]}for(var h=
dojo.filter(h,function(a){return a.length>0}),i=0,e=this._getLongestLine(h).width,k=0,t=h.length;k<t;k++){for(var l=0,n=h[k],q=this._getWidth(n),r=g.createGroup(),m=0;m<n.length;m++){var j=n[m];if(j.path!==null){var o=r.createPath(j.path).setFill(f);d&&o.setStroke(d);o.setTransform([dojox.gfx.matrix.flipY,dojox.gfx.matrix.translate(l,-this.viewbox.height-this.descent)])}l+=j.xAdvance;m+1<n.length&&j.kern&&j.kern[n[m+1].code]&&(l+=j.kern[n[m+1].code].x)}l=0;c=="middle"?l=e/2-q/2:c=="end"&&(l=e-q);
r.setTransform({dx:l,dy:i});i+=this.viewbox.height*b}g.setTransform(dojox.gfx.matrix.scale(a));return g},onLoadBegin:function(){},onLoad:function(){}})}());