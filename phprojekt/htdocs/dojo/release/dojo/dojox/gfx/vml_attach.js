/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo.require("dojox.gfx.vml");dojo.experimental("dojox.gfx.vml_attach");
(function(){var g=dojox.gfx,i=g.matrix,h=g.vml;h.attachNode=function(a){if(!a)return null;var d=null;switch(a.tagName.toLowerCase()){case h.Rect.nodeType:var a=d=new h.Rect(a),b=a.rawNode,c=b.outerHTML.match(/arcsize = \"(\d*\.?\d+[%f]?)\"/)[1],b=b.style,f=parseFloat(b.width),e=parseFloat(b.height),c=c.indexOf("%")>=0?parseFloat(c)/100:h._parseFloat(c);a.shape=g.makeParameters(g.defaultRect,{x:parseInt(b.left),y:parseInt(b.top),width:f,height:e,r:Math.min(f,e)*c});break;case h.Ellipse.nodeType:a.style.width==
a.style.height?(a=d=new h.Circle(a),c=a.rawNode.style,b=parseInt(c.width)/2,a.shape=g.makeParameters(g.defaultCircle,{cx:parseInt(c.left)+b,cy:parseInt(c.top)+b,r:b})):(a=d=new h.Ellipse(a),c=a.rawNode.style,b=parseInt(c.width)/2,f=parseInt(c.height)/2,a.shape=g.makeParameters(g.defaultEllipse,{cx:parseInt(c.left)+b,cy:parseInt(c.top)+f,rx:b,ry:f}));break;case h.Path.nodeType:switch(a.getAttribute("dojoGfxType")){case "line":c=d=new h.Line(a);a=c.shape=dojo.clone(g.defaultLine);c=c.rawNode.path.v.match(g.pathVmlRegExp);
if(!(c.length<7||c[0]!="m"||c[3]!="l"||c[6]!="e"))a.x1=parseInt(c[1]),a.y1=parseInt(c[2]),a.x2=parseInt(c[4]),a.y2=parseInt(c[5]);break;case "polyline":c=d=new h.Polyline(a);a=c.shape=dojo.clone(g.defaultPolyline);c=c.rawNode.path.v.match(g.pathVmlRegExp);do if(!(c.length<3||c[0]!="m"))if(b=parseInt(c[0]),f=parseInt(c[1]),!isNaN(b)&&!isNaN(f)&&(a.points.push({x:b,y:f}),!(c.length<6||c[3]!="l")))for(e=4;e<c.length;e+=2){b=parseInt(c[e]);f=parseInt(c[e+1]);if(isNaN(b)||isNaN(f))break;a.points.push({x:b,
y:f})}while(0);break;case "path":d=new h.Path(a);j(d);break;case "text":d=new h.Text(a);k(d);l(d);a=d;m(a);c=a.matrix;b=a.fontStyle;if(c&&b)a.matrix=i.multiply(c,{dy:g.normalizedLength(b.size)*0.35});break;case "textpath":d=new h.TextPath(a),j(d),k(d),l(d)}break;case h.Image.nodeType:switch(a.getAttribute("dojoGfxType")){case "image":a=d=new h.Image(a),a.shape=dojo.clone(g.defaultImage),a.shape.src=a.rawNode.firstChild.src,a=d.rawNode.filters["DXImageTransform.Microsoft.Matrix"],d.matrix=i.normalize({xx:a.M11,
xy:a.M12,yx:a.M21,yy:a.M22,dx:a.Dx,dy:a.Dy})}break;default:return null}if(!(d instanceof h.Image)){a=d;c=null;e=a.rawNode;b=e.fill;if(b.on&&b.type=="gradient"){c=dojo.clone(g.defaultLinearGradient);f=i._degToRad(b.angle);c.x2=Math.cos(f);c.y2=Math.sin(f);c.colors=[];b=b.colors.value.split(";");for(f=0;f<b.length;++f)(e=b[f].match(/\S+/g))&&e.length==2&&c.colors.push({offset:h._parseFloat(e[0]),color:new dojo.Color(e[1])})}else if(b.on&&b.type=="gradientradial"){c=dojo.clone(g.defaultRadialGradient);
f=parseFloat(e.style.width);e=parseFloat(e.style.height);c.cx=isNaN(f)?0:b.focusposition.x*f;c.cy=isNaN(e)?0:b.focusposition.y*e;c.r=isNaN(f)?1:f/2;c.colors=[];b=b.colors.value.split(";");for(f=b.length-1;f>=0;--f)(e=b[f].match(/\S+/g))&&e.length==2&&c.colors.push({offset:h._parseFloat(e[0]),color:new dojo.Color(e[1])})}else if(b.on&&b.type=="tile")c=dojo.clone(g.defaultPattern),c.width=g.pt2px(b.size.x),c.height=g.pt2px(b.size.y),c.x=b.origin.x*c.width,c.y=b.origin.y*c.height,c.src=b.src;else if(b.on&&
e.fillcolor)c=new dojo.Color(e.fillcolor+""),c.a=b.opacity;a.fillStyle=c;n(d);d instanceof h.Text||m(d)}return d};h.attachSurface=function(a){var d=new h.Surface;d.clipNode=a;var a=d.rawNode=a.firstChild,b=a.firstChild;if(!b||b.tagName!="rect")return null;d.bgNode=a;return d};var n=function(a){var d=a.rawNode;if(d.stroked){var a=a.strokeStyle=dojo.clone(g.defaultStroke),b=d.stroke;a.color=new dojo.Color(d.strokecolor.value);a.width=g.normalizedLength(d.strokeweight+"");a.color.a=b.opacity;a.cap=this._translate(this._capMapReversed,
b.endcap);a.join=b.joinstyle=="miter"?b.miterlimit:b.joinstyle;a.style=b.dashstyle}else a.strokeStyle=null},m=function(a){var d=a.rawNode.skew,b=d.matrix,d=d.offset;a.matrix=i.normalize({xx:b.xtox,xy:b.ytox,yx:b.xtoy,yy:b.ytoy,dx:g.pt2px(d.x),dy:g.pt2px(d.y)})},k=function(a){var d=a.shape=dojo.clone(g.defaultText),b=a.rawNode,c=b.path.v.match(g.pathVmlRegExp);do if(c&&c.length==7){for(var f=b.childNodes,e=0;e<f.length&&f[e].tagName!="textpath";++e);if(!(e>=f.length)){a=f[e].style;d.text=f[e].string;
switch(a["v-text-align"]){case "left":d.x=parseInt(c[1]);d.align="start";break;case "center":d.x=(parseInt(c[1])+parseInt(c[4]))/2;d.align="middle";break;case "right":d.x=parseInt(c[4]),d.align="end"}d.y=parseInt(c[2]);d.decoration=a["text-decoration"];d.rotated=a["v-rotate-letters"].toLowerCase()in h._bool;d.kerning=a["v-text-kern"].toLowerCase()in h._bool;return}}while(0);a.shape=null},l=function(a){for(var d=a.fontStyle=dojo.clone(g.defaultFont),b=a.rawNode.childNodes,c=0;c<b.length&&b[c].tagName==
"textpath";++c);c>=b.length?a.fontStyle=null:(a=b[c].style,d.style=a.fontstyle,d.variant=a.fontvariant,d.weight=a.fontweight,d.size=a.fontsize,d.family=a.fontfamily)},j=function(a){for(var d=a.shape=dojo.clone(g.defaultPath),b=a.rawNode.path.v.match(g.pathVmlRegExp),a=[],c=!1,f=g.Path._pathVmlToSvgMap;0<b.length;++b){var e=b[0];e in f?(c=!1,a.push(f[e])):c||(e=parseInt(e),isNaN(e)?c=!0:a.push(e))}b=a.length;b>=4&&a[b-1]==""&&a[b-2]==0&&a[b-3]==0&&a[b-4]=="l"&&a.splice(b-4,4);if(b)d.path=a.join(" ")}})();