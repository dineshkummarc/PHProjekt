/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojox.drawing.tools.TextBlock"]||(dojo._hasResource["dojox.drawing.tools.TextBlock"]=!0,dojo.provide("dojox.drawing.tools.TextBlock"),dojo.require("dojox.drawing.stencil.Text"),function(){var g;dojo.addOnLoad(function(){(g=dojo.byId("conEdit"))?g.parentNode.removeChild(g):console.error("A contenteditable div is missing from the main document. See 'dojox.drawing.tools.TextBlock'")});dojox.drawing.tools.TextBlock=dojox.drawing.util.oo.declare(dojox.drawing.stencil.Text,function(a){if(a.data){var a=
a.data,c=a.text?this.typesetter(a.text):a.text,b=!a.width?this.style.text.minWidth:a.width=="auto"?"auto":Math.max(a.width,this.style.text.minWidth),d=this._lineHeight;c&&b=="auto"?(d=this.measureText(this.cleanText(c,!1),b),b=d.w,d=d.h):this._text="";this.points=[{x:a.x,y:a.y},{x:a.x+b,y:a.y},{x:a.x+b,y:a.y+d},{x:a.x,y:a.y+d}];a.showEmpty||c?(this.editMode=!0,dojo.disconnect(this._postRenderCon),this._postRenderCon=null,this.connect(this,"render",this,"onRender",!0),a.showEmpty?(this._text=c||"",
this.edit()):c&&a.editMode?(this._text="",this.edit()):c&&this.render(c),setTimeout(dojo.hitch(this,function(){this.editMode=!1}),100)):this.render()}else this.connectMouse(),this._postRenderCon=dojo.connect(this,"render",this,"_onPostRender")},{draws:!0,baseRender:!1,type:"dojox.drawing.tools.TextBlock",_caretStart:0,_caretEnd:0,_blockExec:!1,selectOnExec:!0,showEmpty:!1,onDrag:function(a){this.parentNode||this.showParent(a);var c=this._startdrag,a=a.page;this._box.left=c.x<a.x?c.x:a.x;this._box.top=
c.y;this._box.width=(c.x<a.x?a.x-c.x:c.x-a.x)+this.style.text.pad;dojo.style(this.parentNode,this._box.toPx())},onUp:function(a){if(this._downOnCanvas){this._downOnCanvas=!1;var c=dojo.connect(this,"render",this,function(){dojo.disconnect(c);this.onRender(this)});this.editMode=!0;this.showParent(a);this.created=!0;this.createTextField();this.connectTextField()}},showParent:function(a){if(!this.parentNode){var c=a.pageX||10,b=a.pageY||10;this.parentNode=dojo.doc.createElement("div");this.parentNode.id=
this.id;var d=this.style.textMode.create;this._box={left:c,top:b,width:a.width||1,height:a.height&&a.height>8?a.height:this._lineHeight,border:d.width+"px "+d.style+" "+d.color,position:"absolute",zIndex:500,toPx:function(){var a={},b;for(b in this)a[b]=typeof this[b]=="number"&&b!="zIndex"?this[b]+"px":this[b];return a}};dojo.style(this.parentNode,this._box);document.body.appendChild(this.parentNode)}},createTextField:function(a){var c=this.style.textMode.edit;this._box.border=c.width+"px "+c.style+
" "+c.color;this._box.height="auto";this._box.width=Math.max(this._box.width,this.style.text.minWidth*this.mouse.zoom);dojo.style(this.parentNode,this._box.toPx());this.parentNode.appendChild(g);dojo.style(g,{height:a?"auto":this._lineHeight+"px",fontSize:this.textSize/this.mouse.zoom+"px",fontFamily:this.style.text.family});g.innerHTML=a||"";return g},connectTextField:function(){if(!this._textConnected){var a=dijit.byId("dropdown");this._textConnected=!0;this._dropMode=!1;this.mouse.setEventMode("TEXT");
this.keys.editMode(!0);var c,b,d,f,e=this,h=!1,i=function(){if(!e._dropMode)dojo.forEach([c,b,d,f],function(a){dojo.disconnect(a)}),e._textConnected=!1,e.keys.editMode(!1),e.mouse.setEventMode(),e.execText()};c=dojo.connect(g,"keyup",this,function(b){dojo.trim(g.innerHTML)&&!h?(dojo.style(g,"height","auto"),h=!0):dojo.trim(g.innerHTML).length<2&&h&&(dojo.style(g,"height",this._lineHeight+"px"),h=!1);if(this._blockExec)b.keyCode==dojo.keys.SPACE&&(dojo.stopEvent(b),a.onCancel());else if(b.keyCode==
13||b.keyCode==27)dojo.stopEvent(b),i()});b=dojo.connect(g,"keydown",this,function(b){(b.keyCode==13||b.keyCode==27)&&dojo.stopEvent(b);if(b.keyCode==220){if(a==void 0){console.warn("Dropdown not found");return}dojo.stopEvent(b);this.getSelection(g);this.insertText(g,"\\");this._blockExec=this._dropMode=!0;a._pushChangeTo=g;a._textBlock=this;dijit.popup.open({parent:this.parentNode,popup:a,around:this.parentNode,orient:{BL:"TL"}})}if(this._dropMode)switch(b.keyCode){case dojo.keys.UP_ARROW:case dojo.keys.DOWN_ARROW:case dojo.keys.LEFT_ARROW:case dojo.keys.RIGHT_ARROW:dojo.stopEvent(b);
a._navigateByArrow(b);break;case dojo.keys.ENTER:dojo.stopEvent(b);a._onCellClick(b);break;case dojo.keys.BACKSPACE:case dojo.keys.DELETE:dojo.stopEvent(b),a.onCancel()}else this._blockExec=!1});d=dojo.connect(document,"mouseup",this,function(a){!this._onAnchor&&a.target.id!="conEdit"?(dojo.stopEvent(a),i()):a.target.id=="conEdit"&&g.innerHTML==""&&(g.blur(),setTimeout(function(){g.focus()},200))});this.createAnchors();f=dojo.connect(this.mouse,"setZoom",this,function(){i()});g.focus();this.onDown=
function(){};this.onDrag=function(){};setTimeout(dojo.hitch(this,function(){g.focus();this.onUp=function(){if(!e._onAnchor&&this.parentNode)e.disconnectMouse(),i(),e.onUp=function(){}}}),500)}},execText:function(){var a=dojo.marginBox(this.parentNode),a=Math.max(a.w,this.style.text.minWidth),c=this.cleanText(g.innerHTML,!0);g.innerHTML="";g.blur();this.destroyAnchors();var c=this.typesetter(c),c=this.measureText(c,a),b=this.mouse.scrollOffset(),d=this.mouse.origin,f=this._box.left+b.left-d.x,b=this._box.top+
b.top-d.y;f*=this.mouse.zoom;b*=this.mouse.zoom;a*=this.mouse.zoom;c.h*=this.mouse.zoom;this.points=[{x:f,y:b},{x:f+a,y:b},{x:f+a,y:b+c.h},{x:f,y:b+c.h}];this.editMode=!1;console.log("EXEC TEXT::::",this._postRenderCon);if(!c.text)this._text="",this._textArray=[];this.render(c.text);this.onChangeText(this.getText())},edit:function(){this.editMode=!0;var a=this.getText()||"";console.log("EDIT TEXT:",a," ",a.replace("/n"," "));if(!this.parentNode&&this.points){var c=this.pointsToData(),b=this.mouse.scrollOffset(),
d=this.mouse.origin,c={pageX:c.x/this.mouse.zoom-b.left+d.x,pageY:c.y/this.mouse.zoom-b.top+d.y,width:c.width/this.mouse.zoom,height:c.height/this.mouse.zoom};this.remove(this.shape,this.hit);this.showParent(c);this.createTextField(a.replace("/n"," "));this.connectTextField();a&&this.setSelection(g,"end")}},cleanText:function(a,c){c&&dojo.forEach(["<br>","<br/>","<br />","\\n","\\r"],function(b){a=a.replace(RegExp(b,"gi")," ")});a=a.replace(/&nbsp;/g," ");a=function(a){var c={"&lt;":"<","&gt;":">",
"&amp;":"&"},f;for(f in c)a=a.replace(RegExp(f,"gi"),c[f]);return a}(a);a=dojo.trim(a);return a=a.replace(/\s{2,}/g," ")},measureText:function(a,c){this.showParent({width:c||"auto",height:"auto"});this.createTextField(a);var b="",d=g;d.innerHTML="X";b=dojo.marginBox(d).h;d.innerHTML=a;if(!c||RegExp("(<br\\s*/*>)|(\\n)|(\\r)","gi").test(a))b=a.replace(RegExp("(<br\\s*/*>)|(\\n)|(\\r)","gi"),"\n"),d.innerHTML=a.replace(RegExp("(<br\\s*/*>)|(\\n)|(\\r)","gi"),"<br/>");else if(dojo.marginBox(d).h==b)b=
a;else{var f=a.split(" "),e=[[]],h=0;for(d.innerHTML="";f.length;){var i=f.shift();d.innerHTML+=i+" ";if(dojo.marginBox(d).h>b)h++,e[h]=[],d.innerHTML=i+" ";e[h].push(i)}dojo.forEach(e,function(a,b){e[b]=a.join(" ")});b=e.join("\n");d.innerHTML=b.replace("\n","<br/>")}d=dojo.marginBox(d);g.parentNode.removeChild(g);dojo.destroy(this.parentNode);this.parentNode=null;return{h:d.h,w:d.w,text:b}},_downOnCanvas:!1,onDown:function(a){this._startdrag={x:a.pageX,y:a.pageY};dojo.disconnect(this._postRenderCon);
this._postRenderCon=null;this._downOnCanvas=!0},createAnchors:function(){this._anchors={};var a=this,c=this.style.anchors,b=c.width,d=c.size-b*2,f=c.size/2*-1+"px",c={position:"absolute",width:d+"px",height:c.size-b*2+"px",backgroundColor:c.fill,border:b+"px "+c.style+" "+c.color};if(dojo.isIE)c.paddingLeft=d+"px",c.fontSize=d+"px";d=[{top:f,left:f},{top:f,right:f},{bottom:f,right:f},{bottom:f,left:f}];for(f=0;f<4;f++){var e=f==0||f==3,b=this.util.uid(e?"left_anchor":"right_anchor"),h=dojo.create("div",
{id:b},this.parentNode);dojo.style(h,dojo.mixin(dojo.clone(c),d[f]));var i,j,k;i=dojo.connect(h,"mousedown",this,function(b){e=b.target.id.indexOf("left")>-1;a._onAnchor=!0;var c=b.pageX,d=this._box.width;dojo.stopEvent(b);j=dojo.connect(document,"mousemove",this,function(a){a=a.pageX;e?(this._box.left=a,this._box.width=d+c-a):this._box.width=a+d-c;dojo.style(this.parentNode,this._box.toPx())});k=dojo.connect(document,"mouseup",this,function(b){c=this._box.left;d=this._box.width;dojo.disconnect(j);
dojo.disconnect(k);a._onAnchor=!1;g.focus();dojo.stopEvent(b)})});this._anchors[b]={a:h,cons:[i]}}},destroyAnchors:function(){for(var a in this._anchors)dojo.forEach(this._anchors[a].con,dojo.disconnect,dojo),dojo.destroy(this._anchors[a].a)},setSavedCaret:function(a){this._caretStart=this._caretEnd=a},getSavedCaret:function(){return{start:this._caretStart,end:this._caretEnd}},insertText:function(a,c){var b;b=a.innerHTML;var d=this.getSavedCaret();b=b.replace(/&nbsp;/g," ");b=b.substr(0,d.start)+
c+b.substr(d.end);b=this.cleanText(b,!0);this.setSavedCaret(Math.min(b.length,d.end+c.length));a.innerHTML=b;this.setSelection(a,"stored")},getSelection:function(a){var d;var c,b;dojo.doc.selection?(b=dojo.doc.selection.createRange(),c=dojo.body().createTextRange(),c.moveToElementText(a),a=c.duplicate(),c.moveToBookmark(b.getBookmark()),a.setEndPoint("EndToStart",c),c=this._caretStart=a.text.length,d=this._caretEnd=a.text.length+b.text.length,b=d,console.warn("Caret start: ",c," end: ",b," length: ",
a.text.length," text: ",a.text)):(this._caretStart=dojo.global.getSelection().getRangeAt(a).startOffset,this._caretEnd=dojo.global.getSelection().getRangeAt(a).endOffset,console.log("Caret start: ",this._caretStart," end: ",this._caretEnd))},setSelection:function(a,c){console.warn("setSelection:");if(dojo.doc.selection){var b=dojo.body().createTextRange();b.moveToElementText(a);switch(c){case "end":b.collapse(!1);break;case "beg":b.collapse();break;case "all":b.collapse();b.moveStart("character",
0);b.moveEnd("character",a.text.length);break;case "stored":b.collapse();var d=this._caretStart-this._caretEnd;b.moveStart("character",this._caretStart);b.moveEnd("character",d)}b.select()}else{var f=function(a,b){for(var b=b||[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];d.nodeType==3?b.push(d):d.tagName&&d.tagName.toLowerCase()=="img"&&b.push(d);d.childNodes&&d.childNodes.length&&f(d,b)}return b};console.log("ff node:",a);a.focus();b=dojo.global.getSelection();b.removeAllRanges();var d=
dojo.doc.createRange(),e=f(a);switch(c){case "end":console.log("len:",e[e.length-1].textContent.length);d.setStart(e[e.length-1],e[e.length-1].textContent.length);d.setEnd(e[e.length-1],e[e.length-1].textContent.length);break;case "beg":d.setStart(e[0],0);d.setEnd(e[0],0);break;case "all":d.setStart(e[0],0);d.setEnd(e[e.length-1],e[e.length-1].textContent.length);break;case "stored":console.log("Caret start: ",this._caretStart," caret end: ",this._caretEnd),d.setStart(e[0],this._caretStart),d.setEnd(e[0],
this._caretEnd)}b.addRange(d);console.log("sel ",c," on ",a)}}});dojox.drawing.tools.TextBlock.setup={name:"dojox.drawing.tools.TextBlock",tooltip:"Text Tool",iconClass:"iconText"};dojox.drawing.register(dojox.drawing.tools.TextBlock.setup,"tool")}());