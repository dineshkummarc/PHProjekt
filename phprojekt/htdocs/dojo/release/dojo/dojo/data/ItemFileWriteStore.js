/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojo.data.ItemFileWriteStore"]||(dojo._hasResource["dojo.data.ItemFileWriteStore"]=!0,dojo.provide("dojo.data.ItemFileWriteStore"),dojo.require("dojo.data.ItemFileReadStore"),dojo.declare("dojo.data.ItemFileWriteStore",dojo.data.ItemFileReadStore,{constructor:function(a){this._features["dojo.data.api.Write"]=!0;this._features["dojo.data.api.Notification"]=!0;this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};if(!this._datatypeMap.Date.serialize)this._datatypeMap.Date.serialize=
function(a){return dojo.date.stamp.toISOString(a,{zulu:!0})};if(a&&a.referenceIntegrity===!1)this.referenceIntegrity=!1;this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(a){if(!a)throw Error("assertion failed in ItemFileWriteStore");},_getIdentifierAttribute:function(){return this.getFeatures()["dojo.data.api.Identity"]},newItem:function(a,b){this._assert(!this._saveInProgress);this._loadFinished||this._forceLoad();if(typeof a!="object"&&typeof a!="undefined")throw Error("newItem() was passed something other than an object");
var c=null,d=this._getIdentifierAttribute();if(d===Number)c=this._arrayOfAllItems.length;else{c=a[d];if(typeof c==="undefined")throw Error("newItem() was not passed an identity for the new item");if(dojo.isArray(c))throw Error("newItem() was not passed an single-valued identity");}this._itemsByIdentity&&this._assert(typeof this._itemsByIdentity[c]==="undefined");this._assert(typeof this._pending._newItems[c]==="undefined");this._assert(typeof this._pending._deletedItems[c]==="undefined");var e={};
e[this._storeRefPropName]=this;e[this._itemNumPropName]=this._arrayOfAllItems.length;this._itemsByIdentity&&(this._itemsByIdentity[c]=e,e[d]=[c]);this._arrayOfAllItems.push(e);d=null;if(b&&b.parent&&b.attribute){var d={item:b.parent,attribute:b.attribute,oldValue:void 0},f=this.getValues(b.parent,b.attribute);if(f&&f.length>0){var h=f.slice(0,f.length);d.oldValue=f.length===1?f[0]:f.slice(0,f.length);h.push(e);this._setValueOrValues(b.parent,b.attribute,h,!1);d.newValue=this.getValues(b.parent,b.attribute)}else this._setValueOrValues(b.parent,
b.attribute,e,!1),d.newValue=e}else e[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(e);this._pending._newItems[c]=e;for(var g in a){if(g===this._storeRefPropName||g===this._itemNumPropName)throw Error("encountered bug in ItemFileWriteStore.newItem");c=a[g];dojo.isArray(c)||(c=[c]);e[g]=c;if(this.referenceIntegrity)for(f=0;f<c.length;f++)h=c[f],this.isItem(h)&&this._addReferenceToMap(h,e,g)}this.onNew(e,d);return e},_removeArrayElement:function(a,b){var c=dojo.indexOf(a,b);return c!=-1?
(a.splice(c,1),!0):!1},deleteItem:function(a){this._assert(!this._saveInProgress);this._assertIsItem(a);var b=a[this._itemNumPropName],c=this.getIdentity(a);if(this.referenceIntegrity){var d=this.getAttributes(a);a[this._reverseRefMap]&&(a["backup_"+this._reverseRefMap]=dojo.clone(a[this._reverseRefMap]));dojo.forEach(d,function(b){dojo.forEach(this.getValues(a,b),function(c){this.isItem(c)&&(a["backupRefs_"+this._reverseRefMap]||(a["backupRefs_"+this._reverseRefMap]=[]),a["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(c),
attr:b}),this._removeReferenceFromMap(c,a,b))},this)},this);if(d=a[this._reverseRefMap])for(var e in d){var f=null;if(f=this._itemsByIdentity?this._itemsByIdentity[e]:this._arrayOfAllItems[e])for(var h in d[e]){var g=this.getValues(f,h)||[],i=dojo.filter(g,function(a){return!(this.isItem(a)&&this.getIdentity(a)==c)},this);this._removeReferenceFromMap(a,f,h);i.length<g.length&&this._setValueOrValues(f,h,i,!0)}}}this._arrayOfAllItems[b]=null;a[this._storeRefPropName]=null;this._itemsByIdentity&&delete this._itemsByIdentity[c];
this._pending._deletedItems[c]=a;a[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,a);this.onDelete(a);return!0},setValue:function(a,b,c){return this._setValueOrValues(a,b,c,!0)},setValues:function(a,b,c){return this._setValueOrValues(a,b,c,!0)},unsetAttribute:function(a,b){return this._setValueOrValues(a,b,[],!0)},_setValueOrValues:function(a,b,c,d){this._assert(!this._saveInProgress);this._assertIsItem(a);this._assert(dojo.isString(b));this._assert(typeof c!=="undefined");
var e=this._getIdentifierAttribute();if(b==e)throw Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var e=this._getValueOrValues(a,b),f=this.getIdentity(a);if(!this._pending._modifiedItems[f]){var h={},g;for(g in a)h[g]=g===this._storeRefPropName||g===this._itemNumPropName||g===this._rootItemPropName?a[g]:g===this._reverseRefMap?dojo.clone(a[g]):a[g].slice(0,a[g].length);this._pending._modifiedItems[f]=h}f=!1;if(dojo.isArray(c)&&c.length===0){if(f=
delete a[b],c=void 0,this.referenceIntegrity&&e){g=e;dojo.isArray(g)||(g=[g]);for(var i=0;i<g.length;i++)h=g[i],this.isItem(h)&&this._removeReferenceFromMap(h,a,b)}}else{f=dojo.isArray(c)?c.slice(0,c.length):[c];if(this.referenceIntegrity)if(e){g=e;dojo.isArray(g)||(g=[g]);var j={};dojo.forEach(g,function(a){this.isItem(a)&&(a=this.getIdentity(a),j[a.toString()]=!0)},this);dojo.forEach(f,function(c){if(this.isItem(c)){var d=this.getIdentity(c);j[d.toString()]?delete j[d.toString()]:this._addReferenceToMap(c,
a,b)}},this);for(i in j)this._removeReferenceFromMap(this._itemsByIdentity?this._itemsByIdentity[i]:this._arrayOfAllItems[i],a,b)}else for(i=0;i<f.length;i++)h=f[i],this.isItem(h)&&this._addReferenceToMap(h,a,b);a[b]=f;f=!0}if(d)this.onSet(a,b,e,c);return f},_addReferenceToMap:function(a,b,c){var b=this.getIdentity(b),d=a[this._reverseRefMap];d||(d=a[this._reverseRefMap]={});(a=d[b])||(a=d[b]={});a[c]=!0},_removeReferenceFromMap:function(a,b,c){var b=this.getIdentity(b),d=a[this._reverseRefMap],e;
if(d){for(e in d)e==b&&(delete d[e][c],this._isEmpty(d[e])&&delete d[e]);this._isEmpty(d)&&delete a[this._reverseRefMap]}},_dumpReferenceMap:function(){var a;for(a=0;a<this._arrayOfAllItems.length;a++){var b=this._arrayOfAllItems[a];b&&b[this._reverseRefMap]&&console.log("Item: ["+this.getIdentity(b)+"] is referenced by: "+dojo.toJson(b[this._reverseRefMap]))}},_getValueOrValues:function(a,b){var c=void 0;this.hasAttribute(a,b)&&(c=this.getValues(a,b),c=c.length==1?c[0]:c);return c},_flatten:function(a){if(this.isItem(a))return{_reference:this.getIdentity(a)};
else{if(typeof a==="object")for(var b in this._datatypeMap){var c=this._datatypeMap[b];if(dojo.isObject(c)&&!dojo.isFunction(c)){if(a instanceof c.type){if(!c.serialize)throw Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+b+"]");return{_type:b,_value:c.serialize(a)}}}else if(a instanceof c)return{_type:b,_value:a.toString()}}return a}},_getNewFileContentString:function(){var a={},b=this._getIdentifierAttribute();if(b!==Number)a.identifier=b;if(this._labelAttr)a.label=this._labelAttr;
a.items=[];for(b=0;b<this._arrayOfAllItems.length;++b){var c=this._arrayOfAllItems[b];if(c!==null){var d={},e;for(e in c)if(e!==this._storeRefPropName&&e!==this._itemNumPropName&&e!==this._reverseRefMap&&e!==this._rootItemPropName){var f=e,h=this.getValues(c,f);if(h.length==1)d[f]=this._flatten(h[0]);else for(var g=[],i=0;i<h.length;++i)g.push(this._flatten(h[i])),d[f]=g}a.items.push(d)}}return dojo.toJson(a,!0)},_isEmpty:function(a){var b=!0;if(dojo.isObject(a))for(var c in a){b=!1;break}else dojo.isArray(a)&&
a.length>0&&(b=!1);return b},save:function(a){this._assert(!this._saveInProgress);this._saveInProgress=!0;var b=this,c=function(){b._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};b._saveInProgress=!1;a&&a.onComplete&&a.onComplete.call(a.scope||dojo.global)},d=function(c){b._saveInProgress=!1;a&&a.onError&&a.onError.call(a.scope||dojo.global,c)};if(this._saveEverything){var e=this._getNewFileContentString();this._saveEverything(c,d,e)}this._saveCustom&&this._saveCustom(c,d);!this._saveEverything&&
!this._saveCustom&&c()},revert:function(){this._assert(!this._saveInProgress);for(var a in this._pending._modifiedItems){var b=this._pending._modifiedItems[a],c=null,c=this._itemsByIdentity?this._itemsByIdentity[a]:this._arrayOfAllItems[a];b[this._storeRefPropName]=this;for(key in c)delete c[key];dojo.mixin(c,b)}var d;for(a in this._pending._deletedItems)d=this._pending._deletedItems[a],d[this._storeRefPropName]=this,b=d[this._itemNumPropName],d["backup_"+this._reverseRefMap]&&(d[this._reverseRefMap]=
d["backup_"+this._reverseRefMap],delete d["backup_"+this._reverseRefMap]),this._arrayOfAllItems[b]=d,this._itemsByIdentity&&(this._itemsByIdentity[a]=d),d[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(d);for(a in this._pending._deletedItems)d=this._pending._deletedItems[a],d["backupRefs_"+this._reverseRefMap]&&(dojo.forEach(d["backupRefs_"+this._reverseRefMap],function(a){this._addReferenceToMap(this._itemsByIdentity?this._itemsByIdentity[a.id]:this._arrayOfAllItems[a.id],d,a.attr)},this),
delete d["backupRefs_"+this._reverseRefMap]);for(a in this._pending._newItems)b=this._pending._newItems[a],b[this._storeRefPropName]=null,this._arrayOfAllItems[b[this._itemNumPropName]]=null,b[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,b),this._itemsByIdentity&&delete this._itemsByIdentity[a];this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};return!0},isDirty:function(a){return a?(a=this.getIdentity(a),(new Boolean(this._pending._newItems[a]||this._pending._modifiedItems[a]||
this._pending._deletedItems[a])).valueOf()):!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)?!0:!1},onSet:function(){},onNew:function(){},onDelete:function(){},close:function(a){if(this.clearOnClose)if(this.isDirty())throw Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");else this.inherited(arguments)}}));