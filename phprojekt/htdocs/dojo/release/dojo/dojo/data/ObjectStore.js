/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojo.data.ObjectStore"]||(dojo._hasResource["dojo.data.ObjectStore"]=!0,dojo.provide("dojo.data.ObjectStore"),dojo.require("dojo.regexp"),dojo.declare("dojo.data.ObjectStore",null,{objectStore:null,constructor:function(a){dojo.mixin(this,a)},labelProperty:"label",getValue:function(a,c,b){return typeof a.get==="function"?a.get(c):c in a?a[c]:b},getValues:function(a,c){var b=this.getValue(a,c);return b instanceof Array?b:b===void 0?[]:[b]},getAttributes:function(a){var c=[],b;for(b in a)a.hasOwnProperty(b)&&
!(b.charAt(0)=="_"&&b.charAt(1)=="_")&&c.push(b);return c},hasAttribute:function(a,c){return c in a},containsValue:function(a,c,b){return dojo.indexOf(this.getValues(a,c),b)>-1},isItem:function(a){return typeof a=="object"&&a&&!(a instanceof Date)},isItemLoaded:function(a){return a&&typeof a.load!=="function"},loadItem:function(a){var c;typeof a.item.load==="function"?dojo.when(a.item.load(),function(b){c=b;var d=b instanceof Error?a.onError:a.onItem;d&&d.call(a.scope,b)}):a.onItem&&a.onItem.call(a.scope,
a.item);return c},close:function(a){return a&&a.abort&&a.abort()},fetch:function(a){function c(c){a.onError&&a.onError.call(b,c,a)}var a=a||{},b=a.scope||this,d=a.query;if(typeof d=="object"){var d=dojo.delegate(d),e;for(e in d){var g=d[e];if(typeof g=="string")d[e]=RegExp("^"+dojo.regexp.escapeString(g,"*?").replace(/\*/g,".*").replace(/\?/g,".")+"$",a.queryOptions&&a.queryOptions.ignoreCase?"mi":"m"),d[e].toString=function(a){return function(){return a}}(g)}}var f=this.objectStore.query(d,a);dojo.when(f.total,
function(d){dojo.when(f,function(c){a.onBegin&&a.onBegin.call(b,d||c.length,a);if(a.onItem)for(var e=0;e<c.length;e++)a.onItem.call(b,c[e],a);a.onComplete&&a.onComplete.call(b,a.onItem?null:c,a);return c},c)},c);a.abort=function(){f.cancel&&f.cancel()};a.store=this;return a},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(a){if(this.isItem(a))return this.getValue(a,
this.labelProperty)},getLabelAttributes:function(){return[this.labelProperty]},getIdentity:function(a){return a.getId?a.getId():a[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(){return[this.objectStore.idProperty]},fetchItemByIdentity:function(a){var c;dojo.when(this.objectStore.get(a.identity),function(b){c=b;a.onItem.call(a.scope,b)},function(b){a.onError.call(a.scope,b)});return c},newItem:function(a,c){if(c){var b=this.getValue(c.parent,c.attribute,[]),b=b.concat([a]);a.__parent=
b;this.setValue(c.parent,c.attribute,b)}this._dirtyObjects.push({object:a,save:!0});this.onNew(a);return a},deleteItem:function(a){this.changing(a,!0);this.onDelete(a)},setValue:function(a,c,b){var d=a[c];this.changing(a);a[c]=b;this.onSet(a,c,d,b)},setValues:function(a,c,b){if(!dojo.isArray(b))throw Error("setValues expects to be passed an Array object as its value");this.setValue(a,c,b)},unsetAttribute:function(a,c){this.changing(a);var b=a[c];delete a[c];this.onSet(a,c,b,void 0)},_dirtyObjects:[],
changing:function(a,c){a.__isDirty=!0;for(var b=0;b<this._dirtyObjects.length;b++){var d=this._dirtyObjects[b];if(a==d.object){if(c&&(d.object=!1,!this._saveNotNeeded))d.save=!0;return}}d=a instanceof Array?[]:{};for(b in a)a.hasOwnProperty(b)&&(d[b]=a[b]);this._dirtyObjects.push({object:!c&&a,old:d,save:!this._saveNotNeeded})},save:function(a){var a=a||{},c,b=[],d=[],e=this._dirtyObjects,g=e.length;try{dojo.connect(a,"onError",function(){a.revertOnError!==!1?(e=d,jr.revert()):dirtyObject.concat(d)});
if(this.objectStore.transaction)var f=this.objectStore.transaction();for(var h=0;h<e.length;h++){var i=e[h],j=i.object,k=i.old;delete j.__isDirty;c=j?this.objectStore.put(j,{overwrite:!!k}):this.objectStore.remove(this.getIdentity(k));d.push(i);e.splice(h--,1);dojo.when(c,function(){--g||a.onComplete&&a.onComplete.call(a.scope,b)},function(b){g=-1;a.onError.call(a.scope,b)})}f&&f.commit()}catch(l){a.onError.call(a.scope,value)}},revert:function(){for(var a=this._dirtyObjects,c=a.length;c>0;){c--;
var b=a[c],d=b.object,b=b.old;if(d&&b){for(var e in b)b.hasOwnProperty(e)&&d[e]!==b[e]&&(this.onSet(d,e,d[e],b[e]),d[e]=b[e]);for(e in d)b.hasOwnProperty(e)||(this.onSet(d,e,d[e]),delete d[e])}else if(b)this.onNew(b);else this.onDelete(d);delete (d||b).__isDirty;a.splice(c,1)}},isDirty:function(a){return!a?!!this._dirtyObjects.length:a.__isDirty},onSet:function(){},onNew:function(){},onDelete:function(){}}));