/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dojo.data.ItemFileReadStore"]||(dojo._hasResource["dojo.data.ItemFileReadStore"]=!0,dojo.provide("dojo.data.ItemFileReadStore"),dojo.require("dojo.data.util.filter"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.date.stamp"),dojo.declare("dojo.data.ItemFileReadStore",null,{constructor:function(a){this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=!1;this.url=this._ccUrl=this._jsonFileUrl=a.url;this._jsonData=a.data;this.data=null;this._datatypeMap=
a.typeMap||{};this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(a){return dojo.date.stamp.fromISOString(a)}});this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._itemsByIdentity=null;this._storeRefPropName="_S";this._itemNumPropName="_0";this._rootItemPropName="_RI";this._reverseRefMap="_RRM";this._loadInProgress=!1;this._queuedFetches=[];if(a.urlPreventCache!==void 0)this.urlPreventCache=a.urlPreventCache?!0:!1;if(a.hierarchical!==void 0)this.hierarchical=
a.hierarchical?!0:!1;if(a.clearOnClose)this.clearOnClose=!0;if("failOk"in a)this.failOk=a.failOk?!0:!1},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(a){if(!this.isItem(a))throw Error("dojo.data.ItemFileReadStore: Invalid item argument.");},_assertIsAttribute:function(a){if(typeof a!=="string")throw Error("dojo.data.ItemFileReadStore: Invalid attribute argument.");},getValue:function(a,b,d){a=this.getValues(a,b);return a.length>
0?a[0]:d},getValues:function(a,b){this._assertIsItem(a);this._assertIsAttribute(b);return(a[b]||[]).slice(0)},getAttributes:function(a){this._assertIsItem(a);var b=[],d;for(d in a)d!==this._storeRefPropName&&d!==this._itemNumPropName&&d!==this._rootItemPropName&&d!==this._reverseRefMap&&b.push(d);return b},hasAttribute:function(a,b){this._assertIsItem(a);this._assertIsAttribute(b);return b in a},containsValue:function(a,b,d){var c=void 0;typeof d==="string"&&(c=dojo.data.util.filter.patternToRegExp(d,
!1));return this._containsValue(a,b,d,c)},_containsValue:function(a,b,d,c){return dojo.some(this.getValues(a,b),function(a){if(a!==null&&!dojo.isObject(a)&&c){if(a.toString().match(c))return!0}else if(d===a)return!0})},isItem:function(a){return a&&a[this._storeRefPropName]===this&&this._arrayOfAllItems[a[this._itemNumPropName]]===a?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(a){this._assertIsItem(a.item)},getFeatures:function(){return this._features},getLabel:function(a){if(this._labelAttr&&
this.isItem(a))return this.getValue(a,this._labelAttr)},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},_fetchItems:function(a,b,d){var c=this,i=function(a,d){var f=[],e,g;if(a.query){var i;e=a.queryOptions?a.queryOptions.ignoreCase:!1;var n={};for(g in a.query)i=a.query[g],typeof i==="string"?n[g]=dojo.data.util.filter.patternToRegExp(i,e):i instanceof RegExp&&(n[g]=i);for(e=0;e<d.length;++e){var o=!0,p=d[e];if(p===null)o=!1;else for(g in a.query)i=a.query[g],c._containsValue(p,
g,i,n[g])||(o=!1);o&&f.push(p)}}else for(e=0;e<d.length;++e)g=d[e],g!==null&&f.push(g);b(f,a)};if(this._loadFinished)i(a,this._getItemsArray(a.queryOptions));else{if(this._jsonFileUrl!==this._ccUrl)dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=this._jsonFileUrl;else if(this.url!==this._ccUrl)this._ccUrl=this._jsonFileUrl=this.url;if(this.data!=null)this._jsonData=
this.data,this.data=null;if(this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:a,filter:i});else{this._loadInProgress=!0;var f=dojo.xhrGet({url:c._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk});f.addCallback(function(b){try{c._getItemsFromLoadedData(b),c._loadFinished=!0,c._loadInProgress=!1,i(a,c._getItemsArray(a.queryOptions)),c._handleQueuedFetches()}catch(e){c._loadFinished=!0,c._loadInProgress=!1,d(e,a)}});f.addErrback(function(b){c._loadInProgress=
!1;d(b,a)});var e=null;if(a.abort)e=a.abort;a.abort=function(){f&&f.fired===-1&&f.cancel();e&&e.call(a)}}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,i(a,this._getItemsArray(a.queryOptions))}catch(g){d(g,a)}else d(Error("dojo.data.ItemFileReadStore: No JSON source data was provided as either URL or a nested Javascript object."),a)}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var a=0;a<this._queuedFetches.length;a++){var b=
this._queuedFetches[a],d=b.args;(b=b.filter)?b(d,this._getItemsArray(d.queryOptions)):this.fetchItemByIdentity(d)}this._queuedFetches=[]}},_getItemsArray:function(a){return a&&a.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(){if(this.clearOnClose&&this._loadFinished&&!this._loadInProgress)(this._jsonFileUrl==""||this._jsonFileUrl==null)&&(this.url==""||this.url==null)&&this.data==null&&console.debug("dojo.data.ItemFileReadStore: WARNING!  Data reload  information has not been provided.  Please set 'url' or 'data' to the appropriate value before the next fetch"),
this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[]},_getItemsFromLoadedData:function(a){function b(a){return a!==null&&typeof a==="object"&&(!dojo.isArray(a)||c)&&!dojo.isFunction(a)&&(a.constructor==Object||dojo.isArray(a))&&typeof a._reference==="undefined"&&typeof a._type==="undefined"&&typeof a._value==="undefined"&&i.hierarchical}function d(a){i._arrayOfAllItems.push(a);for(var e in a){var c=a[e];
if(c)if(dojo.isArray(c))for(var f=0;f<c.length;++f){var g=c[f];b(g)&&d(g)}else b(c)&&d(c)}}var c=!1,i=this;this._labelAttr=a.label;var f,e;this._arrayOfAllItems=[];this._arrayOfTopLevelItems=a.items;for(f=0;f<this._arrayOfTopLevelItems.length;++f)e=this._arrayOfTopLevelItems[f],dojo.isArray(e)&&(c=!0),d(e),e[this._rootItemPropName]=!0;var g={},j;for(f=0;f<this._arrayOfAllItems.length;++f)for(j in e=this._arrayOfAllItems[f],e){if(j!==this._rootItemPropName){var h=e[j];h!==null?dojo.isArray(h)||(e[j]=
[h]):e[j]=[null]}g[j]=j}for(;g[this._storeRefPropName];)this._storeRefPropName+="_";for(;g[this._itemNumPropName];)this._itemNumPropName+="_";for(;g[this._reverseRefMap];)this._reverseRefMap+="_";if(g=a.identifier){this._itemsByIdentity={};this._features["dojo.data.api.Identity"]=g;for(f=0;f<this._arrayOfAllItems.length;++f)if(e=this._arrayOfAllItems[f],a=e[g],a=a[0],Object.hasOwnProperty.call(this._itemsByIdentity,a))if(this._jsonFileUrl)throw Error("dojo.data.ItemFileReadStore:  The json data as specified by: ["+
this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+g+"].  Value collided: ["+a+"]");else{if(this._jsonData)throw Error("dojo.data.ItemFileReadStore:  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+g+"].  Value collided: ["+a+"]");}else this._itemsByIdentity[a]=e}else this._features["dojo.data.api.Identity"]=Number;for(f=0;f<this._arrayOfAllItems.length;++f)e=this._arrayOfAllItems[f],e[this._storeRefPropName]=this,
e[this._itemNumPropName]=f;for(f=0;f<this._arrayOfAllItems.length;++f)for(j in e=this._arrayOfAllItems[f],e){a=e[j];for(g=0;g<a.length;++g)if(h=a[g],h!==null&&typeof h=="object"){if("_type"in h&&"_value"in h){var l=h._type,k=this._datatypeMap[l];if(k)if(dojo.isFunction(k))a[g]=new k(h._value);else if(dojo.isFunction(k.deserialize))a[g]=k.deserialize(h._value);else throw Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");
else throw Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+l+"'");}if(h._reference){h=h._reference;if(dojo.isObject(h))for(l=0;l<this._arrayOfAllItems.length;++l){var k=this._arrayOfAllItems[l],q=!0,m;for(m in h)k[m]!=h[m]&&(q=!1);q&&(a[g]=k)}else a[g]=this._getItemByIdentity(h);this.referenceIntegrity&&(h=a[g],this.isItem(h)&&this._addReferenceToMap(h,e,j))}else this.isItem(h)&&this.referenceIntegrity&&this._addReferenceToMap(h,
e,j)}}},_addReferenceToMap:function(){},getIdentity:function(a){var b=this._features["dojo.data.api.Identity"];if(b===Number)return a[this._itemNumPropName];else if(a=a[b])return a[0];return null},fetchItemByIdentity:function(a){var b,d;if(this._loadFinished)b=this._getItemByIdentity(a.identity),a.onItem&&(d=a.scope?a.scope:dojo.global,a.onItem.call(d,b));else{var c=this;if(this._jsonFileUrl!==this._ccUrl)dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),
this.url=this._ccUrl=this._jsonFileUrl;else if(this.url!==this._ccUrl)this._ccUrl=this._jsonFileUrl=this.url;if(this.data!=null&&this._jsonData==null)this._jsonData=this.data,this.data=null;if(this._jsonFileUrl)this._loadInProgress?this._queuedFetches.push({args:a}):(this._loadInProgress=!0,d=dojo.xhrGet({url:c._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk}),d.addCallback(function(d){var f=a.scope?a.scope:dojo.global;try{c._getItemsFromLoadedData(d),
c._loadFinished=!0,c._loadInProgress=!1,b=c._getItemByIdentity(a.identity),a.onItem&&a.onItem.call(f,b),c._handleQueuedFetches()}catch(e){c._loadInProgress=!1,a.onError&&a.onError.call(f,e)}}),d.addErrback(function(b){c._loadInProgress=!1;a.onError&&a.onError.call(a.scope?a.scope:dojo.global,b)}));else if(this._jsonData)c._getItemsFromLoadedData(c._jsonData),c._jsonData=null,c._loadFinished=!0,b=c._getItemByIdentity(a.identity),a.onItem&&(d=a.scope?a.scope:dojo.global,a.onItem.call(d,b))}},_getItemByIdentity:function(a){var b=
null;this._itemsByIdentity&&Object.hasOwnProperty.call(this._itemsByIdentity,a)?b=this._itemsByIdentity[a]:Object.hasOwnProperty.call(this._arrayOfAllItems,a)&&(b=this._arrayOfAllItems[a]);b===void 0&&(b=null);return b},getIdentityAttributes:function(){var a=this._features["dojo.data.api.Identity"];return a===Number?null:[a]},_forceLoad:function(){var a=this;if(this._jsonFileUrl!==this._ccUrl)dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),
this.url=this._ccUrl=this._jsonFileUrl;else if(this.url!==this._ccUrl)this._ccUrl=this._jsonFileUrl=this.url;if(this.data!=null)this._jsonData=this.data,this.data=null;if(this._jsonFileUrl){var b=dojo.xhrGet({url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0});b.addCallback(function(b){try{if(a._loadInProgress!==!0&&!a._loadFinished)a._getItemsFromLoadedData(b),a._loadFinished=!0;else if(a._loadInProgress)throw Error("dojo.data.ItemFileReadStore:  Unable to perform a synchronous load, an async load is in progress.");
}catch(c){throw console.log(c),c;}});b.addErrback(function(a){throw a;})}else if(this._jsonData)a._getItemsFromLoadedData(a._jsonData),a._jsonData=null,a._loadFinished=!0}}),dojo.extend(dojo.data.ItemFileReadStore,dojo.data.util.simpleFetch));