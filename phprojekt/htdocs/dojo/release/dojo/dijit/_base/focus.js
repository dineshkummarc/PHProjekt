/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dijit._base.focus"]||(dojo._hasResource["dijit._base.focus"]=!0,dojo.provide("dijit._base.focus"),dojo.require("dojo.window"),dojo.require("dijit._base.manager"),dojo.mixin(dijit,{_curFocus:null,_prevFocus:null,isCollapsed:function(){return dijit.getBookmark().isCollapsed},getBookmark:function(){var a,b,c=dojo.doc.selection,d=dijit._curFocus;if(dojo.global.getSelection){if(c=dojo.global.getSelection())if(c.isCollapsed){if(a=d?d.tagName:"")if(a=a.toLowerCase(),a=="textarea"||a==
"input"&&(!d.type||d.type.toLowerCase()=="text"))return c={start:d.selectionStart,end:d.selectionEnd,node:d,pRange:!0},{isCollapsed:c.end<=c.start,mark:c};a={isCollapsed:!0};if(c.rangeCount)a.mark=c.getRangeAt(0).cloneRange()}else b=c.getRangeAt(0),a={isCollapsed:!1,mark:b.cloneRange()}}else if(c){a=d?d.tagName:"";a=a.toLowerCase();if(d&&a&&(a=="button"||a=="textarea"||a=="input"))return c.type&&c.type.toLowerCase()=="none"?{isCollapsed:!0,mark:null}:(b=c.createRange(),{isCollapsed:b.text&&b.text.length?
!1:!0,mark:{range:b,pRange:!0}});a={};try{b=c.createRange(),a.isCollapsed=!(c.type=="Text"?b.htmlText.length:b.length)}catch(e){return a.isCollapsed=!0,a}if(c.type.toUpperCase()=="CONTROL")if(b.length){a.mark=[];c=0;for(d=b.length;c<d;)a.mark.push(b.item(c++))}else a.isCollapsed=!0,a.mark=null;else a.mark=b.getBookmark()}else console.warn("No idea how to store the current selection for this browser!");return a},moveToBookmark:function(a){var b=dojo.doc;if(a=a.mark)if(dojo.global.getSelection)(b=dojo.global.getSelection())&&
b.removeAllRanges?a.pRange?(b=a.node,b.selectionStart=a.start,b.selectionEnd=a.end):(b.removeAllRanges(),b.addRange(a)):console.warn("No idea how to restore selection for this browser!");else if(b.selection&&a){var c;a.pRange?c=a.range:dojo.isArray(a)?(c=b.body.createControlRange(),dojo.forEach(a,function(a){c.addElement(a)})):(c=b.body.createTextRange(),c.moveToBookmark(a));c.select()}},getFocus:function(a,b){var c=!dijit._curFocus||a&&dojo.isDescendant(dijit._curFocus,a.domNode)?dijit._prevFocus:
dijit._curFocus;return{node:c,bookmark:c==dijit._curFocus&&dojo.withGlobal(b||dojo.global,dijit.getBookmark),openedForWindow:b}},focus:function(a){if(a){var b="node"in a?a.node:a,c=a.bookmark,a=a.openedForWindow,d=c?c.isCollapsed:!1;if(b){var e=b.tagName.toLowerCase()=="iframe"?b.contentWindow:b;if(e&&e.focus)try{e.focus()}catch(f){}dijit._onFocusNode(b)}if(c&&dojo.withGlobal(a||dojo.global,dijit.isCollapsed)&&!d){a&&a.focus();try{dojo.withGlobal(a||dojo.global,dijit.moveToBookmark,null,[c])}catch(g){}}}},
_activeStack:[],registerIframe:function(a){return dijit.registerWin(a.contentWindow,a)},unregisterIframe:function(a){dijit.unregisterWin(a)},registerWin:function(a,b){var c=function(a){dijit._justMouseDowned=!0;setTimeout(function(){dijit._justMouseDowned=!1},0);if(!dojo.isIE||!a||!(a.srcElement&&a.srcElement.parentNode==null))dijit._onTouchNode(b||a.target||a.srcElement,"mouse")},d=dojo.isIE?a.document.documentElement:a.document;if(d)if(dojo.isIE){a.document.body.attachEvent("onmousedown",c);var e=
function(a){a.srcElement.tagName.toLowerCase()!="#document"&&dijit.isTabNavigable(a.srcElement)?dijit._onFocusNode(b||a.srcElement):dijit._onTouchNode(b||a.srcElement)};d.attachEvent("onactivate",e);var f=function(a){dijit._onBlurNode(b||a.srcElement)};d.attachEvent("ondeactivate",f);return function(){a.document.detachEvent("onmousedown",c);d.detachEvent("onactivate",e);d.detachEvent("ondeactivate",f);d=null}}else{d.body.addEventListener("mousedown",c,!0);var g=function(a){dijit._onFocusNode(b||a.target)};
d.addEventListener("focus",g,!0);var h=function(a){dijit._onBlurNode(b||a.target)};d.addEventListener("blur",h,!0);return function(){d.body.removeEventListener("mousedown",c,!0);d.removeEventListener("focus",g,!0);d.removeEventListener("blur",h,!0);d=null}}},unregisterWin:function(a){a&&a()},_onBlurNode:function(){dijit._prevFocus=dijit._curFocus;dijit._curFocus=null;if(!dijit._justMouseDowned)dijit._clearActiveWidgetsTimer&&clearTimeout(dijit._clearActiveWidgetsTimer),dijit._clearActiveWidgetsTimer=
setTimeout(function(){delete dijit._clearActiveWidgetsTimer;dijit._setStack([]);dijit._prevFocus=null},100)},_onTouchNode:function(a,b){dijit._clearActiveWidgetsTimer&&(clearTimeout(dijit._clearActiveWidgetsTimer),delete dijit._clearActiveWidgetsTimer);var c=[];try{for(;a;){var d=dojo.attr(a,"dijitPopupParent");if(d)a=dijit.byId(d).domNode;else if(a.tagName&&a.tagName.toLowerCase()=="body"){if(a===dojo.body())break;a=dojo.window.get(a.ownerDocument).frameElement}else{var e=a.getAttribute&&a.getAttribute("widgetId"),
f=e&&dijit.byId(e);f&&!(b=="mouse"&&f.get("disabled"))&&c.unshift(e);a=a.parentNode}}}catch(g){}dijit._setStack(c,b)},_onFocusNode:function(a){if(a&&a.nodeType!=9&&(dijit._onTouchNode(a),a!=dijit._curFocus)){if(dijit._curFocus)dijit._prevFocus=dijit._curFocus;dijit._curFocus=a;dojo.publish("focusNode",[a])}},_setStack:function(a,b){var c=dijit._activeStack;dijit._activeStack=a;for(var d=0;d<Math.min(c.length,a.length);d++)if(c[d]!=a[d])break;for(var e,f=c.length-1;f>=d;f--)if(e=dijit.byId(c[f]))e._focused=
!1,e.set("focused",!1),e._hasBeenBlurred=!0,e._onBlur&&e._onBlur(b),dojo.publish("widgetBlur",[e,b]);for(f=d;f<a.length;f++)if(e=dijit.byId(a[f]))e._focused=!0,e.set("focused",!0),e._onFocus&&e._onFocus(b),dojo.publish("widgetFocus",[e,b])}}),dojo.addOnLoad(function(){var a=dijit.registerWin(window);dojo.isIE&&dojo.addOnWindowUnload(function(){dijit.unregisterWin(a);a=null})}));