/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dijit.Tree"]||(dojo._hasResource["dijit.Tree"]=!0,dojo.provide("dijit.Tree"),dojo.require("dojo.fx"),dojo.require("dojo.DeferredList"),dojo.require("dijit._Widget"),dojo.require("dijit._Templated"),dojo.require("dijit._Container"),dojo.require("dijit._Contained"),dojo.require("dijit._CssStateMixin"),dojo.require("dojo.cookie"),dojo.require("dijit.tree.TreeStoreModel"),dojo.require("dijit.tree.ForestStoreModel"),dojo.require("dijit.tree._dndSelector"),dojo.declare("dijit._TreeNode",
[dijit._Widget,dijit._Templated,dijit._Container,dijit._Contained,dijit._CssStateMixin],{item:null,isTreeNode:!0,label:"",isExpandable:null,isExpanded:!1,state:"UNCHECKED",templateString:dojo.cache("dijit","templates/TreeNode.html",'<div class="dijitTreeNode" role="presentation"\n\t><div dojoAttachPoint="rowNode" class="dijitTreeRow" role="presentation" dojoAttachEvent="onmouseenter:_onMouseEnter, onmouseleave:_onMouseLeave, onclick:_onClick, ondblclick:_onDblClick"\n\t\t><img src="${_blankGif}" alt="" dojoAttachPoint="expandoNode" class="dijitTreeExpando" role="presentation"\n\t\t/><span dojoAttachPoint="expandoNodeText" class="dijitExpandoText" role="presentation"\n\t\t></span\n\t\t><span dojoAttachPoint="contentNode"\n\t\t\tclass="dijitTreeContent" role="presentation">\n\t\t\t<img src="${_blankGif}" alt="" dojoAttachPoint="iconNode" class="dijitIcon dijitTreeIcon" role="presentation"\n\t\t\t/><span dojoAttachPoint="labelNode" class="dijitTreeLabel" role="treeitem" tabindex="-1" aria-selected="false" dojoAttachEvent="onfocus:_onLabelFocus"></span>\n\t\t</span\n\t></div>\n\t<div dojoAttachPoint="containerNode" class="dijitTreeContainer" role="presentation" style="display: none;"></div>\n</div>\n'),
baseClass:"dijitTreeNode",cssStateNodes:{rowNode:"dijitTreeRow",labelNode:"dijitTreeLabel"},attributeMap:dojo.delegate(dijit._Widget.prototype.attributeMap,{label:{node:"labelNode",type:"innerText"},tooltip:{node:"rowNode",type:"attribute",attribute:"title"}}),buildRendering:function(){this.inherited(arguments);this._setExpando();this._updateItemClasses(this.item);this.isExpandable&&dijit.setWaiState(this.labelNode,"expanded",this.isExpanded);this.setSelected(!1)},_setIndentAttr:function(a){var b=
Math.max(a,0)*this.tree._nodePixelIndent+"px";dojo.style(this.domNode,"backgroundPosition",b+" 0px");dojo.style(this.rowNode,this.isLeftToRight()?"paddingLeft":"paddingRight",b);dojo.forEach(this.getChildren(),function(b){b.set("indent",a+1)});this._set("indent",a)},markProcessing:function(){this.state="LOADING";this._setExpando(!0)},unmarkProcessing:function(){this._setExpando(!1)},_updateItemClasses:function(a){var b=this.tree,c=b.model;b._v10Compat&&a===c.root&&(a=null);this._applyClassAndStyle(a,
"icon","Icon");this._applyClassAndStyle(a,"label","Label");this._applyClassAndStyle(a,"row","Row")},_applyClassAndStyle:function(a,b,c){var d="_"+b+"Class";b+="Node";var e=this[d];this[d]=this.tree["get"+c+"Class"](a,this.isExpanded);dojo.replaceClass(this[b],this[d]||"",e||"");dojo.style(this[b],this.tree["get"+c+"Style"](a,this.isExpanded)||{})},_updateLayout:function(){var a=this.getParent();!a||a.rowNode.style.display=="none"?dojo.addClass(this.domNode,"dijitTreeIsRoot"):dojo.toggleClass(this.domNode,
"dijitTreeIsLast",!this.getNextSibling())},_setExpando:function(a){var b=["dijitTreeExpandoLoading","dijitTreeExpandoOpened","dijitTreeExpandoClosed","dijitTreeExpandoLeaf"],a=a?0:this.isExpandable?this.isExpanded?1:2:3;dojo.replaceClass(this.expandoNode,b[a],b);this.expandoNodeText.innerHTML=["*","-","+","*"][a]},expand:function(){if(this._expandDeferred)return this._expandDeferred;this._wipeOut&&this._wipeOut.stop();this.isExpanded=!0;dijit.setWaiState(this.labelNode,"expanded","true");(this.tree.showRoot||
this!==this.tree.rootNode)&&dijit.setWaiRole(this.containerNode,"group");dojo.addClass(this.contentNode,"dijitTreeContentExpanded");this._setExpando();this._updateItemClasses(this.item);this==this.tree.rootNode&&dijit.setWaiState(this.tree.domNode,"expanded","true");var a,b=dojo.fx.wipeIn({node:this.containerNode,duration:dijit.defaultDuration,onEnd:function(){a.callback(!0)}});a=this._expandDeferred=new dojo.Deferred(function(){b.stop()});b.play();return a},collapse:function(){if(this.isExpanded){this._expandDeferred&&
(this._expandDeferred.cancel(),delete this._expandDeferred);this.isExpanded=!1;dijit.setWaiState(this.labelNode,"expanded","false");this==this.tree.rootNode&&dijit.setWaiState(this.tree.domNode,"expanded","false");dojo.removeClass(this.contentNode,"dijitTreeContentExpanded");this._setExpando();this._updateItemClasses(this.item);if(!this._wipeOut)this._wipeOut=dojo.fx.wipeOut({node:this.containerNode,duration:dijit.defaultDuration});this._wipeOut.play()}},indent:0,setChildItems:function(a){var b=this.tree,
c=b.model,d=[];dojo.forEach(this.getChildren(),function(a){dijit._Container.prototype.removeChild.call(this,a)},this);this.state="LOADED";a&&a.length>0?(this.isExpandable=!0,dojo.forEach(a,function(a){var g=c.getIdentity(a),h=b._itemNodesMap[g],f;if(h)for(var i=0;i<h.length;i++)if(h[i]&&!h[i].getParent()){f=h[i];f.set("indent",this.indent+1);break}f||(f=this.tree._createTreeNode({item:a,tree:b,isExpandable:c.mayHaveChildren(a),label:b.getLabel(a),tooltip:b.getTooltip(a),dir:b.dir,lang:b.lang,indent:this.indent+
1}),h?h.push(f):b._itemNodesMap[g]=[f]);this.addChild(f);(this.tree.autoExpand||this.tree._state(a))&&d.push(b._expandNode(f))},this),dojo.forEach(this.getChildren(),function(a){a._updateLayout()})):this.isExpandable=!1;this._setExpando&&this._setExpando(!1);this._updateItemClasses(this.item);if(this==b.rootNode)(a=this.tree.showRoot?this:this.getChildren()[0])?(a.setFocusable(!0),b.lastFocused=a):b.domNode.setAttribute("tabIndex","0");return new dojo.DeferredList(d)},getTreePath:function(){for(var a=
this,b=[];a&&a!==this.tree.rootNode;)b.unshift(a.item),a=a.getParent();b.unshift(this.tree.rootNode.item);return b},getIdentity:function(){return this.tree.model.getIdentity(this.item)},removeChild:function(a){this.inherited(arguments);var b=this.getChildren();if(b.length==0)this.isExpandable=!1,this.collapse();dojo.forEach(b,function(a){a._updateLayout()})},makeExpandable:function(){this.isExpandable=!0;this._setExpando(!1)},_onLabelFocus:function(){this.tree._onNodeFocus(this)},setSelected:function(a){dijit.setWaiState(this.labelNode,
"selected",a);dojo.toggleClass(this.rowNode,"dijitTreeRowSelected",a)},setFocusable:function(a){this.labelNode.setAttribute("tabIndex",a?"0":"-1")},_onClick:function(a){this.tree._onClick(this,a)},_onDblClick:function(a){this.tree._onDblClick(this,a)},_onMouseEnter:function(a){this.tree._onNodeMouseEnter(this,a)},_onMouseLeave:function(a){this.tree._onNodeMouseLeave(this,a)}}),dojo.declare("dijit.Tree",[dijit._Widget,dijit._Templated],{store:null,model:null,query:null,label:"",showRoot:!0,childrenAttr:["children"],
paths:[],path:[],selectedItems:null,selectedItem:null,openOnClick:!1,openOnDblClick:!1,templateString:dojo.cache("dijit","templates/Tree.html",'<div class="dijitTree dijitTreeContainer" role="tree"\n\tdojoAttachEvent="onkeypress:_onKeyPress">\n\t<div class="dijitInline dijitTreeIndent" style="position: absolute; top: -9999px" dojoAttachPoint="indentDetector"></div>\n</div>\n'),persist:!0,autoExpand:!1,dndController:"dijit.tree._dndSelector",dndParams:["onDndDrop","itemCreator","onDndCancel","checkAcceptance",
"checkItemAcceptance","dragThreshold","betweenThreshold"],onDndDrop:null,itemCreator:null,onDndCancel:null,checkAcceptance:null,checkItemAcceptance:null,dragThreshold:5,betweenThreshold:0,_nodePixelIndent:19,_publish:function(a,b){dojo.publish(this.id,[dojo.mixin({tree:this,event:a},b||{})])},postMixInProperties:function(){this.tree=this;if(this.autoExpand)this.persist=!1;this._itemNodesMap={};if(!this.cookieName)this.cookieName=this.id+"SaveStateCookie";this._loadDeferred=new dojo.Deferred;this.inherited(arguments)},
postCreate:function(){this._initState();this.model||this._store2model();this.connect(this.model,"onChange","_onItemChange");this.connect(this.model,"onChildrenChange","_onItemChildrenChange");this.connect(this.model,"onDelete","_onItemDelete");this._load();this.inherited(arguments);if(this.dndController){if(dojo.isString(this.dndController))this.dndController=dojo.getObject(this.dndController);for(var a={},b=0;b<this.dndParams.length;b++)this[this.dndParams[b]]&&(a[this.dndParams[b]]=this[this.dndParams[b]]);
this.dndController=new this.dndController(this,a)}},_store2model:function(){this._v10Compat=!0;dojo.deprecated("Tree: from version 2.0, should specify a model object rather than a store/query");var a={id:this.id+"_ForestStoreModel",store:this.store,query:this.query,childrenAttrs:this.childrenAttr};if(this.params.mayHaveChildren)a.mayHaveChildren=dojo.hitch(this,"mayHaveChildren");if(this.params.getItemChildren)a.getChildren=dojo.hitch(this,function(a,c,d){this.getItemChildren(this._v10Compat&&a===
this.model.root?null:a,c,d)});this.model=new dijit.tree.ForestStoreModel(a);this.showRoot=Boolean(this.label)},onLoad:function(){},_load:function(){this.model.getRoot(dojo.hitch(this,function(a){var b=this.rootNode=this.tree._createTreeNode({item:a,tree:this,isExpandable:!0,label:this.label||this.getLabel(a),indent:this.showRoot?0:-1});if(!this.showRoot)b.rowNode.style.display="none",dijit.setWaiRole(this.domNode,"presentation"),dijit.setWaiRole(b.labelNode,"presentation"),dijit.setWaiRole(b.containerNode,
"tree");this.domNode.appendChild(b.domNode);a=this.model.getIdentity(a);this._itemNodesMap[a]?this._itemNodesMap[a].push(b):this._itemNodesMap[a]=[b];b._updateLayout();this._expandNode(b).addCallback(dojo.hitch(this,function(){this._loadDeferred.callback(!0);this.onLoad()}))}),function(a){console.error(this,": error loading root: ",a)})},getNodesByItem:function(a){return!a?[]:[].concat(this._itemNodesMap[dojo.isString(a)?a:this.model.getIdentity(a)])},_setSelectedItemAttr:function(a){this.set("selectedItems",
[a])},_setSelectedItemsAttr:function(a){var b=this;this._loadDeferred.addCallback(dojo.hitch(this,function(){var c=dojo.map(a,function(a){return!a||dojo.isString(a)?a:b.model.getIdentity(a)}),d=[];dojo.forEach(c,function(a){d=d.concat(b._itemNodesMap[a]||[])});this.set("selectedNodes",d)}))},_setPathAttr:function(a){return a.length?this.set("paths",[a]):this.set("paths",[])},_setPathsAttr:function(a){function b(a,e,g){var h=a.shift(),f=dojo.filter(e,function(a){return a.getIdentity()==h})[0];f?a.length?
c._expandNode(f).addCallback(function(){b(a,f.getChildren(),g)}):g.callback(f):g.errback("Could not expand path at "+h)}var c=this;return(new dojo.DeferredList(dojo.map(a,function(a){var e=new dojo.Deferred,a=dojo.map(a,function(a){return dojo.isString(a)?a:c.model.getIdentity(a)});a.length?c._loadDeferred.addCallback(function(){b(a,[c.rootNode],e)}):e.errback("Empty path");return e}))).addCallback(function(a){c.set("selectedNodes",dojo.map(dojo.filter(a,function(a){return a[0]}),function(a){return a[1]}))})},
_setSelectedNodeAttr:function(a){this.set("selectedNodes",[a])},_setSelectedNodesAttr:function(a){this._loadDeferred.addCallback(dojo.hitch(this,function(){this.dndController.setSelection(a)}))},mayHaveChildren:function(){},getItemChildren:function(){},getLabel:function(a){return this.model.getLabel(a)},getIconClass:function(a,b){return!a||this.model.mayHaveChildren(a)?b?"dijitFolderOpened":"dijitFolderClosed":"dijitLeaf"},getLabelClass:function(){},getRowClass:function(){},getIconStyle:function(){},
getLabelStyle:function(){},getRowStyle:function(){},getTooltip:function(){return""},_onKeyPress:function(a){if(!a.altKey){var b=dojo.keys,c=dijit.getEnclosingWidget(a.target);if(c){var d=a.charOrCode;if(typeof d=="string"&&d!=" ")!a.altKey&&!a.ctrlKey&&!a.shiftKey&&!a.metaKey&&(this._onLetterKeyNav({node:c,key:d.toLowerCase()}),dojo.stopEvent(a));else{this._curSearch&&(clearTimeout(this._curSearch.timer),delete this._curSearch);var e=this._keyHandlerMap;if(!e)e={},e[b.ENTER]="_onEnterKey",e[b.SPACE]=
e[" "]="_onEnterKey",e[this.isLeftToRight()?b.LEFT_ARROW:b.RIGHT_ARROW]="_onLeftArrow",e[this.isLeftToRight()?b.RIGHT_ARROW:b.LEFT_ARROW]="_onRightArrow",e[b.UP_ARROW]="_onUpArrow",e[b.DOWN_ARROW]="_onDownArrow",e[b.HOME]="_onHomeKey",e[b.END]="_onEndKey",this._keyHandlerMap=e;this._keyHandlerMap[d]&&(this[this._keyHandlerMap[d]]({node:c,item:c.item,evt:a}),dojo.stopEvent(a))}}}},_onEnterKey:function(a){this._publish("execute",{item:a.item,node:a.node});this.dndController.userSelect(a.node,dojo.isCopyKey(a.evt),
a.evt.shiftKey);this.onClick(a.item,a.node,a.evt)},_onDownArrow:function(a){(a=this._getNextNode(a.node))&&a.isTreeNode&&this.focusNode(a)},_onUpArrow:function(a){var a=a.node,b=a.getPreviousSibling();if(b)for(a=b;a.isExpandable&&a.isExpanded&&a.hasChildren();)a=a.getChildren(),a=a[a.length-1];else if(b=a.getParent(),this.showRoot||b!==this.rootNode)a=b;a&&a.isTreeNode&&this.focusNode(a)},_onRightArrow:function(a){a=a.node;a.isExpandable&&!a.isExpanded?this._expandNode(a):a.hasChildren()&&(a=a.getChildren()[0])&&
a.isTreeNode&&this.focusNode(a)},_onLeftArrow:function(a){a=a.node;a.isExpandable&&a.isExpanded?this._collapseNode(a):(a=a.getParent())&&a.isTreeNode&&(this.showRoot||a!==this.rootNode)&&this.focusNode(a)},_onHomeKey:function(){var a=this._getRootOrFirstNode();a&&this.focusNode(a)},_onEndKey:function(){for(var a=this.rootNode;a.isExpanded;)a=a.getChildren(),a=a[a.length-1];a&&a.isTreeNode&&this.focusNode(a)},multiCharSearchDuration:250,_onLetterKeyNav:function(a){var b=this._curSearch;b?(b.pattern+=
a.key,clearTimeout(b.timer)):b=this._curSearch={pattern:a.key,startNode:a.node};var c=this;b.timer=setTimeout(function(){delete c._curSearch},this.multiCharSearchDuration);a=b.startNode;do(a=this._getNextNode(a))||(a=this._getRootOrFirstNode());while(a!==b.startNode&&a.label.toLowerCase().substr(0,b.pattern.length)!=b.pattern);a&&a.isTreeNode&&a!==b.startNode&&this.focusNode(a)},isExpandoNode:function(a,b){return dojo.isDescendant(a,b.expandoNode)},_onClick:function(a,b){var c=this.isExpandoNode(b.target,
a);this.openOnClick&&a.isExpandable||c?a.isExpandable&&this._onExpandoClick({node:a}):(this._publish("execute",{item:a.item,node:a,evt:b}),this.onClick(a.item,a,b),this.focusNode(a));dojo.stopEvent(b)},_onDblClick:function(a,b){var c=b.target,c=c==a.expandoNode||c==a.expandoNodeText;this.openOnDblClick&&a.isExpandable||c?a.isExpandable&&this._onExpandoClick({node:a}):(this._publish("execute",{item:a.item,node:a,evt:b}),this.onDblClick(a.item,a,b),this.focusNode(a));dojo.stopEvent(b)},_onExpandoClick:function(a){a=
a.node;this.focusNode(a);a.isExpanded?this._collapseNode(a):this._expandNode(a)},onClick:function(){},onDblClick:function(){},onOpen:function(){},onClose:function(){},_getNextNode:function(a){if(a.isExpandable&&a.isExpanded&&a.hasChildren())return a.getChildren()[0];else{for(;a&&a.isTreeNode;){var b=a.getNextSibling();if(b)return b;a=a.getParent()}return null}},_getRootOrFirstNode:function(){return this.showRoot?this.rootNode:this.rootNode.getChildren()[0]},_collapseNode:function(a){a._expandNodeDeferred&&
delete a._expandNodeDeferred;a.isExpandable&&a.state!="LOADING"&&(a.collapse(),this.onClose(a.item,a),a.item&&(this._state(a.item,!1),this._saveState()))},_expandNode:function(a,b){if(a._expandNodeDeferred&&!b)return a._expandNodeDeferred;var c=this.model,d=a.item,e=this;switch(a.state){case "UNCHECKED":a.markProcessing();var g=a._expandNodeDeferred=new dojo.Deferred;c.getChildren(d,function(b){a.unmarkProcessing();var b=a.setChildItems(b),c=e._expandNode(a,!0);b.addCallback(function(){c.addCallback(function(){g.callback()})})},
function(a){console.error(e,": error loading root children: ",a)});break;default:g=a._expandNodeDeferred=a.expand(),this.onOpen(a.item,a),d&&(this._state(d,!0),this._saveState())}return g},focusNode:function(a){dijit.focus(a.labelNode)},_onNodeFocus:function(a){if(a&&a!=this.lastFocused)this.lastFocused&&!this.lastFocused._destroyed&&this.lastFocused.setFocusable(!1),a.setFocusable(!0),this.lastFocused=a},_onNodeMouseEnter:function(){},_onNodeMouseLeave:function(){},_onItemChange:function(a){var b=
this._itemNodesMap[this.model.getIdentity(a)];if(b){var c=this.getLabel(a),d=this.getTooltip(a);dojo.forEach(b,function(b){b.set({item:a,label:c,tooltip:d});b._updateItemClasses(a)})}},_onItemChildrenChange:function(a,b){var c=this._itemNodesMap[this.model.getIdentity(a)];c&&dojo.forEach(c,function(a){a.setChildItems(b)})},_onItemDelete:function(a){var a=this.model.getIdentity(a),b=this._itemNodesMap[a];b&&(dojo.forEach(b,function(a){this.dndController.removeTreeNode(a);var b=a.getParent();b&&b.removeChild(a);
a.destroyRecursive()},this),delete this._itemNodesMap[a])},_initState:function(){if(this.persist){var a=dojo.cookie(this.cookieName);this._openedItemIds={};a&&dojo.forEach(a.split(","),function(a){this._openedItemIds[a]=!0},this)}},_state:function(a,b){if(!this.persist)return!1;var c=this.model.getIdentity(a);if(arguments.length===1)return this._openedItemIds[c];b?this._openedItemIds[c]=!0:delete this._openedItemIds[c]},_saveState:function(){if(this.persist){var a=[],b;for(b in this._openedItemIds)a.push(b);
dojo.cookie(this.cookieName,a.join(","),{expires:365})}},destroy:function(){this._curSearch&&(clearTimeout(this._curSearch.timer),delete this._curSearch);this.rootNode&&this.rootNode.destroyRecursive();this.dndController&&!dojo.isString(this.dndController)&&this.dndController.destroy();this.rootNode=null;this.inherited(arguments)},destroyRecursive:function(){this.destroy()},resize:function(a){a&&dojo.marginBox(this.domNode,a);this._nodePixelIndent=dojo._getMarginSize(this.tree.indentDetector).w;this.tree.rootNode&&
this.tree.rootNode.set("indent",this.showRoot?0:-1)},_createTreeNode:function(a){return new dijit._TreeNode(a)}}));