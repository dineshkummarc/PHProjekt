/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dijit.Editor"]||(dojo._hasResource["dijit.Editor"]=!0,dojo.provide("dijit.Editor"),dojo.require("dijit._editor.RichText"),dojo.require("dijit.Toolbar"),dojo.require("dijit.ToolbarSeparator"),dojo.require("dijit._editor._Plugin"),dojo.require("dijit._editor.plugins.EnterKeyHandling"),dojo.require("dijit._editor.range"),dojo.require("dijit._Container"),dojo.require("dojo.i18n"),dojo.require("dijit.layout._LayoutWidget"),dojo.requireLocalization("dijit._editor","commands",null,"ROOT,ar,ca,cs,da,de,el,es,fi,fr,he,hu,it,ja,kk,ko,nb,nl,pl,pt,pt-pt,ro,ru,sk,sl,sv,th,tr,zh,zh-tw"),
dojo.declare("dijit.Editor",dijit._editor.RichText,{plugins:null,extraPlugins:null,constructor:function(){if(!dojo.isArray(this.plugins))this.plugins=["undo","redo","|","cut","copy","paste","|","bold","italic","underline","strikethrough","|","insertOrderedList","insertUnorderedList","indent","outdent","|","justifyLeft","justifyRight","justifyCenter","justifyFull","dijit._editor.plugins.EnterKeyHandling"];this._plugins=[];this._editInterval=this.editActionInterval*1E3;dojo.isIE&&(this.events.push("onBeforeDeactivate"),
this.events.push("onBeforeActivate"))},postMixInProperties:function(){this.setValueDeferred=new dojo.Deferred;this.inherited(arguments)},postCreate:function(){this._steps=this._steps.slice(0);this._undoedSteps=this._undoedSteps.slice(0);if(dojo.isArray(this.extraPlugins))this.plugins=this.plugins.concat(this.extraPlugins);this.inherited(arguments);this.commands=dojo.i18n.getLocalization("dijit._editor","commands",this.lang);if(!this.toolbar)this.toolbar=new dijit.Toolbar({dir:this.dir,lang:this.lang}),
this.header.appendChild(this.toolbar.domNode);dojo.forEach(this.plugins,this.addPlugin,this);this.setValueDeferred.callback(!0);dojo.addClass(this.iframe.parentNode,"dijitEditorIFrameContainer");dojo.addClass(this.iframe,"dijitEditorIFrame");dojo.attr(this.iframe,"allowTransparency",!0);dojo.isWebKit&&dojo.style(this.domNode,"KhtmlUserSelect","none");this.toolbar.startup();this.onNormalizedDisplayChanged()},destroy:function(){dojo.forEach(this._plugins,function(a){a&&a.destroy&&a.destroy()});this._plugins=
[];this.toolbar.destroyRecursive();delete this.toolbar;this.inherited(arguments)},addPlugin:function(a,c){var b=dojo.isString(a)?{name:a}:a;if(!b.setEditor){var d={args:b,plugin:null,editor:this};dojo.publish(dijit._scopeName+".Editor.getPlugin",[d]);if(!d.plugin){var e=dojo.getObject(b.name);if(e)d.plugin=new e(b)}if(!d.plugin){console.warn("Cannot find plugin",a);return}a=d.plugin}arguments.length>1?this._plugins[c]=a:this._plugins.push(a);a.setEditor(this);dojo.isFunction(a.setToolbar)&&a.setToolbar(this.toolbar)},
startup:function(){},resize:function(a){a&&dijit.layout._LayoutWidget.prototype.resize.apply(this,arguments)},layout:function(){this.editingArea.style.height=this._contentBox.h-(this.getHeaderHeight()+this.getFooterHeight()+dojo._getPadBorderExtents(this.iframe.parentNode).h+dojo._getMarginExtents(this.iframe.parentNode).h)+"px";if(this.iframe)this.iframe.style.height="100%";this._layoutMode=!0},_onIEMouseDown:function(a){var c,b=this.document.body,d=b.clientWidth,e=b.clientHeight,f=b.clientLeft,
g=b.offsetWidth,h=b.offsetHeight,i=b.offsetLeft;bodyDir=b.dir?b.dir.toLowerCase():"";bodyDir!="rtl"?d<g&&a.x>d&&a.x<g&&(c=!0):a.x<f&&a.x>i&&(c=!0);c||e<h&&a.y>e&&a.y<h&&(c=!0);c||(delete this._cursorToStart,delete this._savedSelection,a.target.tagName=="BODY"&&setTimeout(dojo.hitch(this,"placeCursorAtEnd"),0),this.inherited(arguments))},onBeforeActivate:function(){this._restoreSelection()},onBeforeDeactivate:function(a){this.customUndo&&this.endEditing(!0);a.target.tagName!="BODY"&&this._saveSelection()},
customUndo:!0,editActionInterval:3,beginEditing:function(a){if(!this._inEditing)this._inEditing=!0,this._beginEditing(a);if(this.editActionInterval>0)this._editTimer&&clearTimeout(this._editTimer),this._editTimer=setTimeout(dojo.hitch(this,this.endEditing),this._editInterval)},_steps:[],_undoedSteps:[],execCommand:function(a){if(this.customUndo&&(a=="undo"||a=="redo"))return this[a]();else{this.customUndo&&(this.endEditing(),this._beginEditing());var c,b=/copy|cut|paste/.test(a);try{if(c=this.inherited(arguments),
dojo.isWebKit&&b&&!c)throw{code:1011};}catch(d){if(d.code==1011&&b)c=dojo.string.substitute,alert(c(this.commands.systemShortcut,[this.commands[a],c(this.commands[dojo.isMac?"appleKey":"ctrlKey"],[{cut:"X",copy:"C",paste:"V"}[a]])]));c=!1}this.customUndo&&this._endEditing();return c}},queryCommandEnabled:function(a){return this.customUndo&&(a=="undo"||a=="redo")?a=="undo"?this._steps.length>1:this._undoedSteps.length>0:this.inherited(arguments)},_moveToBookmark:function(a){var c=a.mark,b=a.mark,a=
a.isCollapsed,d,e,f;if(b)if(dojo.isIE<9)if(dojo.isArray(b))c=[],dojo.forEach(b,function(a){c.push(dijit.range.getNode(a,this.editNode))},this),dojo.withGlobal(this.window,"moveToBookmark",dijit,[{mark:c,isCollapsed:a}]);else{if(b.startContainer&&b.endContainer&&(f=dijit.range.getSelection(this.window))&&f.removeAllRanges)f.removeAllRanges(),a=dijit.range.create(this.window),d=dijit.range.getNode(b.startContainer,this.editNode),e=dijit.range.getNode(b.endContainer,this.editNode),d&&e&&(a.setStart(d,
b.startOffset),a.setEnd(e,b.endOffset),f.addRange(a))}else if((f=dijit.range.getSelection(this.window))&&f.removeAllRanges)f.removeAllRanges(),a=dijit.range.create(this.window),d=dijit.range.getNode(b.startContainer,this.editNode),e=dijit.range.getNode(b.endContainer,this.editNode),d&&e&&(a.setStart(d,b.startOffset),a.setEnd(e,b.endOffset),f.addRange(a))},_changeToStep:function(a,c){this.setValue(c.text);var b=c.bookmark;b&&this._moveToBookmark(b)},undo:function(){var a=!1;if(!this._undoRedoActive){this._undoRedoActive=
!0;this.endEditing(!0);var c=this._steps.pop();c&&this._steps.length>0&&(this.focus(),this._changeToStep(c,this._steps[this._steps.length-1]),this._undoedSteps.push(c),this.onDisplayChanged(),delete this._undoRedoActive,a=!0);delete this._undoRedoActive}return a},redo:function(){var a=!1;if(!this._undoRedoActive){this._undoRedoActive=!0;this.endEditing(!0);var c=this._undoedSteps.pop();c&&this._steps.length>0&&(this.focus(),this._changeToStep(this._steps[this._steps.length-1],c),this._steps.push(c),
this.onDisplayChanged(),a=!0);delete this._undoRedoActive}return a},endEditing:function(a){this._editTimer&&clearTimeout(this._editTimer);if(this._inEditing)this._endEditing(a),this._inEditing=!1},_getBookmark:function(){var a=dojo.withGlobal(this.window,dijit.getBookmark),c=[];if(a&&a.mark){var b=a.mark;if(dojo.isIE<9){var d=dijit.range.getSelection(this.window);if(dojo.isArray(b))dojo.forEach(a.mark,function(a){c.push(dijit.range.getIndex(a,this.editNode).o)},this),a.mark=c;else if(d){var e;d.rangeCount&&
(e=d.getRangeAt(0));a.mark=e?e.cloneRange():dojo.withGlobal(this.window,dijit.getBookmark)}}try{if(a.mark&&a.mark.startContainer)c=dijit.range.getIndex(a.mark.startContainer,this.editNode).o,a.mark={startContainer:c,startOffset:a.mark.startOffset,endContainer:a.mark.endContainer===a.mark.startContainer?c:dijit.range.getIndex(a.mark.endContainer,this.editNode).o,endOffset:a.mark.endOffset}}catch(f){a.mark=null}}return a},_beginEditing:function(){this._steps.length===0&&this._steps.push({text:dijit._editor.getChildrenHtml(this.editNode),
bookmark:this._getBookmark()})},_endEditing:function(){var a=dijit._editor.getChildrenHtml(this.editNode);this._undoedSteps=[];this._steps.push({text:a,bookmark:this._getBookmark()})},onKeyDown:function(a){!dojo.isIE&&!this.iframe&&a.keyCode==dojo.keys.TAB&&!this.tabIndent&&this._saveSelection();if(this.customUndo){var c=a.keyCode,b=dojo.keys;if(a.ctrlKey&&!a.altKey)if(c==90||c==122){dojo.stopEvent(a);this.undo();return}else if(c==89||c==121){dojo.stopEvent(a);this.redo();return}this.inherited(arguments);
switch(c){case b.ENTER:case b.BACKSPACE:case b.DELETE:this.beginEditing();break;case 88:case 86:if(a.ctrlKey&&!a.altKey&&!a.metaKey){this.endEditing();a.keyCode==88?this.beginEditing("cut"):this.beginEditing("paste");setTimeout(dojo.hitch(this,this.endEditing),1);break}default:if(!a.ctrlKey&&!a.altKey&&!a.metaKey&&(a.keyCode<dojo.keys.F1||a.keyCode>dojo.keys.F15)){this.beginEditing();break}case b.ALT:this.endEditing();break;case b.UP_ARROW:case b.DOWN_ARROW:case b.LEFT_ARROW:case b.RIGHT_ARROW:case b.HOME:case b.END:case b.PAGE_UP:case b.PAGE_DOWN:this.endEditing(!0);
case b.CTRL:case b.SHIFT:case b.TAB:}}else this.inherited(arguments)},_onBlur:function(){this.inherited(arguments);this.endEditing(!0)},_saveSelection:function(){try{this._savedSelection=this._getBookmark()}catch(a){}},_restoreSelection:function(){this._savedSelection&&(delete this._cursorToStart,dojo.withGlobal(this.window,"isCollapsed",dijit)&&this._moveToBookmark(this._savedSelection),delete this._savedSelection)},onClick:function(){this.endEditing(!0);this.inherited(arguments)},replaceValue:function(a){this.customUndo?
this.isClosed?this.setValue(a):(this.beginEditing(),a||(a="&nbsp;"),this.setValue(a),this.endEditing()):this.inherited(arguments)},_setDisabledAttr:function(a){this.setValueDeferred.addCallback(dojo.hitch(this,function(){!this.disabled&&a||!this._buttonEnabledPlugins&&a?dojo.forEach(this._plugins,function(a){a.set("disabled",!0)}):this.disabled&&!a&&dojo.forEach(this._plugins,function(a){a.set("disabled",!1)})}));this.inherited(arguments)},_setStateClass:function(){try{this.inherited(arguments),this.document&&
this.document.body&&dojo.style(this.document.body,"color",dojo.style(this.iframe,"color"))}catch(a){}}}),dojo.subscribe(dijit._scopeName+".Editor.getPlugin",null,function(a){if(!a.plugin){var c,b=dijit._editor._Plugin,d=a.args.name;switch(d){case "undo":case "redo":case "cut":case "copy":case "paste":case "insertOrderedList":case "insertUnorderedList":case "indent":case "outdent":case "justifyCenter":case "justifyFull":case "justifyLeft":case "justifyRight":case "delete":case "selectAll":case "removeFormat":case "unlink":case "insertHorizontalRule":c=
new b({command:d});break;case "bold":case "italic":case "underline":case "strikethrough":case "subscript":case "superscript":c=new b({buttonClass:dijit.form.ToggleButton,command:d});break;case "|":c=new b({button:new dijit.ToolbarSeparator,setEditor:function(a){this.editor=a}})}a.plugin=c}}));