/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dijit.tree.dndSource"]||(dojo._hasResource["dijit.tree.dndSource"]=!0,dojo.provide("dijit.tree.dndSource"),dojo.require("dijit.tree._dndSelector"),dojo.require("dojo.dnd.Manager"),dojo.declare("dijit.tree.dndSource",dijit.tree._dndSelector,{isSource:!0,accept:["text","treeNode"],copyOnly:!1,dragThreshold:5,betweenThreshold:0,constructor:function(a,c){c||(c={});dojo.mixin(this,c);this.isSource=typeof c.isSource=="undefined"?!0:c.isSource;var d=c.accept instanceof Array?c.accept:
["text","treeNode"];this.accept=null;if(d.length){this.accept={};for(var b=0;b<d.length;++b)this.accept[d[b]]=1}this.mouseDown=this.isDragging=!1;this.targetBox=this.targetAnchor=null;this.dropPosition="";this._lastY=this._lastX=0;this.sourceState="";this.isSource&&dojo.addClass(this.node,"dojoDndSource");this.targetState="";this.accept&&dojo.addClass(this.node,"dojoDndTarget");this.topics=[dojo.subscribe("/dnd/source/over",this,"onDndSourceOver"),dojo.subscribe("/dnd/start",this,"onDndStart"),dojo.subscribe("/dnd/drop",
this,"onDndDrop"),dojo.subscribe("/dnd/cancel",this,"onDndCancel")]},checkAcceptance:function(){return!0},copyState:function(a){return this.copyOnly||a},destroy:function(){this.inherited("destroy",arguments);dojo.forEach(this.topics,dojo.unsubscribe);this.targetAnchor=null},_onDragMouse:function(a){var c=dojo.dnd.manager(),d=this.targetAnchor,b=this.current,f=this.dropPosition,e="Over";if(b&&this.betweenThreshold>0){if(!this.targetBox||d!=b)this.targetBox=dojo.position(b.rowNode,!0);a.pageY-this.targetBox.y<=
this.betweenThreshold?e="Before":a.pageY-this.targetBox.y>=this.targetBox.h-this.betweenThreshold&&(e="After")}if(b!=d||e!=f)d&&this._removeItemClass(d.rowNode,f),b&&this._addItemClass(b.rowNode,e),b?b==this.tree.rootNode&&e!="Over"?c.canDrop(!1):c.source==this&&b.id in this.selection?c.canDrop(!1):this.checkItemAcceptance(b.rowNode,c.source,e.toLowerCase())&&!this._isParentChildDrop(c.source,b.rowNode)?c.canDrop(!0):c.canDrop(!1):c.canDrop(!1),this.targetAnchor=b,this.dropPosition=e},onMouseMove:function(a){if(!(this.isDragging&&
this.targetState=="Disabled")){this.inherited(arguments);var c=dojo.dnd.manager();if(this.isDragging)this._onDragMouse(a);else if(this.mouseDown&&this.isSource&&(Math.abs(a.pageX-this._lastX)>=this.dragThreshold||Math.abs(a.pageY-this._lastY)>=this.dragThreshold)){var d=this.getSelectedTreeNodes();if(d.length){if(d.length>1){var b=this.selection,f=0,e=[],h,g;a:for(;h=d[f++];){for(g=h.getParent();g&&g!==this.tree;g=g.getParent())if(b[g.id])continue a;e.push(h)}d=e}d=dojo.map(d,function(a){return a.domNode});
c.startDrag(this,d,this.copyState(dojo.isCopyKey(a)))}}}},onMouseDown:function(a){this.mouseDown=!0;this.mouseButton=a.button;this._lastX=a.pageX;this._lastY=a.pageY;this.inherited(arguments)},onMouseUp:function(a){if(this.mouseDown)this.mouseDown=!1,this.inherited(arguments)},onMouseOut:function(){this.inherited(arguments);this._unmarkTargetAnchor()},checkItemAcceptance:function(){return!0},onDndSourceOver:function(a){this!=a?(this.mouseDown=!1,this._unmarkTargetAnchor()):this.isDragging&&dojo.dnd.manager().canDrop(!1)},
onDndStart:function(a,c,d){this.isSource&&this._changeState("Source",this==a?d?"Copied":"Moved":"");this._changeState("Target",this.checkAcceptance(a,c)?"":"Disabled");this==a&&dojo.dnd.manager().overSource(this);this.isDragging=!0},itemCreator:function(a){return dojo.map(a,function(a){return{id:a.id,name:a.textContent||a.innerText||""}})},onDndDrop:function(a,c,d){if(this.containerState=="Over"){var b=this.tree,f=b.model,e=this.targetAnchor;this.isDragging=!1;var h,g;h=e&&e.item||b.item;this.dropPosition==
"Before"||this.dropPosition=="After"?(h=e.getParent()&&e.getParent().item||b.item,g=e.getIndexInParent(),this.dropPosition=="After"&&(g=e.getIndexInParent()+1)):h=e&&e.item||b.item;var i;dojo.forEach(c,function(b,n){var m=a.getItem(b.id);if(dojo.indexOf(m.type,"treeNode")!=-1)var j=m.data,k=j.item,l=j.getParent().item;a==this?(typeof g=="number"&&h==l&&j.getIndexInParent()<g&&(g-=1),f.pasteItem(k,l,h,d,g)):f.isItem(k)?f.pasteItem(k,l,h,d,g):(i||(i=this.itemCreator(c,e.rowNode,a)),f.newItem(i[n],h,
g))},this);this.tree._expandNode(e)}this.onDndCancel()},onDndCancel:function(){this._unmarkTargetAnchor();this.mouseDown=this.isDragging=!1;delete this.mouseButton;this._changeState("Source","");this._changeState("Target","")},onOverEvent:function(){this.inherited(arguments);dojo.dnd.manager().overSource(this)},onOutEvent:function(){this._unmarkTargetAnchor();var a=dojo.dnd.manager();this.isDragging&&a.canDrop(!1);a.outSource(this);this.inherited(arguments)},_isParentChildDrop:function(a,c){if(!a.tree||
a.tree!=this.tree)return!1;for(var d=a.tree.domNode,b=a.selection,f=c.parentNode;f!=d&&!b[f.id];)f=f.parentNode;return f.id&&b[f.id]},_unmarkTargetAnchor:function(){if(this.targetAnchor)this._removeItemClass(this.targetAnchor.rowNode,this.dropPosition),this.dropPosition=this.targetBox=this.targetAnchor=null},_markDndStatus:function(a){this._changeState("Source",a?"Copied":"Moved")}}));