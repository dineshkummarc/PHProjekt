/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._hasResource["dijit.tree.TreeStoreModel"]||(dojo._hasResource["dijit.tree.TreeStoreModel"]=!0,dojo.provide("dijit.tree.TreeStoreModel"),dojo.declare("dijit.tree.TreeStoreModel",null,{store:null,childrenAttrs:["children"],newItemIdAttr:"id",labelAttr:"",root:null,query:null,deferItemLoadingUntilExpand:!1,constructor:function(a){dojo.mixin(this,a);this.connects=[];a=this.store;if(!a.getFeatures()["dojo.data.api.Identity"])throw Error("dijit.Tree: store must support dojo.data.Identity");if(a.getFeatures()["dojo.data.api.Notification"])this.connects=
this.connects.concat([dojo.connect(a,"onNew",this,"onNewItem"),dojo.connect(a,"onDelete",this,"onDeleteItem"),dojo.connect(a,"onSet",this,"onSetItem")])},destroy:function(){dojo.forEach(this.connects,dojo.disconnect)},getRoot:function(a,b){this.root?a(this.root):this.store.fetch({query:this.query,onComplete:dojo.hitch(this,function(b){if(b.length!=1)throw Error(this.declaredClass+": query "+dojo.toJson(this.query)+" returned "+b.length+" items, but must return exactly one item");this.root=b[0];a(this.root)}),
onError:b})},mayHaveChildren:function(a){return dojo.some(this.childrenAttrs,function(b){return this.store.hasAttribute(a,b)},this)},getChildren:function(a,b,c){var f=this.store;if(f.isItemLoaded(a)){for(var d=[],e=0;e<this.childrenAttrs.length;e++)var g=f.getValues(a,this.childrenAttrs[e]),d=d.concat(g);var h=0;this.deferItemLoadingUntilExpand||dojo.forEach(d,function(a){f.isItemLoaded(a)||h++});h==0?b(d):dojo.forEach(d,function(a,e){f.isItemLoaded(a)||f.loadItem({item:a,onItem:function(a){d[e]=
a;--h==0&&b(d)},onError:c})})}else{var i=dojo.hitch(this,arguments.callee);f.loadItem({item:a,onItem:function(a){i(a,b,c)},onError:c})}},isItem:function(a){return this.store.isItem(a)},fetchItemByIdentity:function(a){this.store.fetchItemByIdentity(a)},getIdentity:function(a){return this.store.getIdentity(a)},getLabel:function(a){return this.labelAttr?this.store.getValue(a,this.labelAttr):this.store.getLabel(a)},newItem:function(a,b,c){var f={parent:b,attribute:this.childrenAttrs[0]},d;this.newItemIdAttr&&
a[this.newItemIdAttr]?this.fetchItemByIdentity({identity:a[this.newItemIdAttr],scope:this,onItem:function(e){e?this.pasteItem(e,null,b,!0,c):(d=this.store.newItem(a,f))&&c!=void 0&&this.pasteItem(d,b,b,!1,c)}}):(d=this.store.newItem(a,f))&&c!=void 0&&this.pasteItem(d,b,b,!1,c)},pasteItem:function(a,b,c,f,d){var e=this.store,g=this.childrenAttrs[0];b&&dojo.forEach(this.childrenAttrs,function(c){if(e.containsValue(b,c,a)){if(!f){var d=dojo.filter(e.getValues(b,c),function(b){return b!=a});e.setValues(b,
c,d)}g=c}});if(c)if(typeof d=="number"){var h=e.getValues(c,g).slice();h.splice(d,0,a);e.setValues(c,g,h)}else e.setValues(c,g,e.getValues(c,g).concat(a))},onChange:function(){},onChildrenChange:function(){},onDelete:function(){},onNewItem:function(a,b){b&&this.getChildren(b.item,dojo.hitch(this,function(a){this.onChildrenChange(b.item,a)}))},onDeleteItem:function(a){this.onDelete(a)},onSetItem:function(a,b){if(dojo.indexOf(this.childrenAttrs,b)!=-1)this.getChildren(a,dojo.hitch(this,function(b){this.onChildrenChange(a,
b)}));else this.onChange(a)}}));